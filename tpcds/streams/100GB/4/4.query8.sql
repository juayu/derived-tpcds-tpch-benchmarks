-- start query 8 in stream 4 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '67517','27472','59546','18024','60733','53888',
                          '88920','52535','82250','65033','78128',
                          '44662','84443','65728','91948','80022',
                          '95847','58366','66739','55708','94556',
                          '58537','50990','64185','68383','68380',
                          '61692','58993','75413','44196','22025',
                          '82665','37492','23816','96780','46686',
                          '86384','37581','36289','79808','30795',
                          '57527','36599','58875','22030','98341',
                          '84554','70066','14886','51986','83320',
                          '90208','74801','34756','41793','55029',
                          '39754','69581','10892','42875','47996',
                          '12173','32590','67930','85923','61699',
                          '57215','97709','17455','25694','45660',
                          '64109','15563','85091','66867','81551',
                          '32067','43634','54665','26135','19564',
                          '26130','39332','94211','76808','70762',
                          '72320','16776','99342','55745','99393',
                          '60791','12920','37364','74824','83631',
                          '95049','85874','79802','97231','50481',
                          '71761','13701','85435','93549','55370',
                          '84378','73984','91343','86197','61532',
                          '10702','35695','79606','10624','64702',
                          '34009','90658','94982','24460','29320',
                          '23042','84022','60715','44126','62080',
                          '82443','19482','46328','84740','73981',
                          '82560','41411','97633','97579','99844',
                          '83357','11148','59845','21133','91564',
                          '31050','64111','81788','75019','12736',
                          '25898','92489','32211','51038','14508',
                          '60467','42484','36216','58362','71937',
                          '85014','54597','81821','50627','20654',
                          '27926','50249','37065','66928','55302',
                          '58363','98535','55374','78602','88090',
                          '43888','12395','26025','29428','68910',
                          '37703','99520','26250','18309','31566',
                          '89928','60847','31780','89031','43090',
                          '88973','94938','80095','11469','42870',
                          '14082','98252','73887','25389','11671',
                          '70992','10354','70346','82366','26201',
                          '99967','33606','75226','32622','44983',
                          '80446','94722','89209','15512','10880',
                          '83035','92127','93532','62088','63074',
                          '42241','20032','61036','10525','22575',
                          '41796','26448','82565','38257','62414',
                          '63026','83419','41867','21970','65358',
                          '99486','76233','67979','98276','34111',
                          '25535','35191','67789','86308','61236',
                          '91319','53805','77034','39581','98845',
                          '95958','24047','67961','27090','56389',
                          '99279','57905','36857','52966','52512',
                          '94263','43608','64629','22454','88883',
                          '65587','68071','32076','27181','90450',
                          '59764','94219','78537','62548','69722',
                          '92821','44346','13134','48737','21096',
                          '13249','50914','63958','10083','10119',
                          '83128','42409','16973','71291','60273',
                          '52621','34438','77054','33202','29801',
                          '77490','59860','30821','70676','53597',
                          '33456','94432','21840','80381','26177',
                          '40312','55104','21099','40602','79352',
                          '32413','12819','33210','86899','55101',
                          '73124','50989','30731','13894','24490',
                          '78579','47215','59042','70327','73274',
                          '73244','15089','55146','57631','35278',
                          '46602','30710','17114','62003','54687',
                          '96922','26771','93812','60803','91493',
                          '33528','13965','94586','84284','45846',
                          '59671','23882','52040','14761','35562',
                          '74345','78653','90027','95181','15048',
                          '66584','96022','31134','88145','14056',
                          '30327','78534','92540','80960','99103',
                          '95202','21241','99597','36949','52979',
                          '77313','60291','25805','81071','76850',
                          '39155','20050','61430','47861','74955',
                          '48453','28763','31435','20870','68960',
                          '63470','42657','45042','28510','48709',
                          '62810','98672','56689','82531','61185',
                          '76359','60714','43012','71012','40151',
                          '69405','96282','37180','22625')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

