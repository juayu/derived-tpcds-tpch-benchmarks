-- start query 8 in stream 9 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '74369','79904','48673','67457','68352','40230',
                          '68123','66267','66726','72491','51035',
                          '62703','92329','33602','59833','19459',
                          '46995','92811','53133','12606','27453',
                          '28607','41520','41464','22284','44241',
                          '37675','78821','90753','17914','75939',
                          '77311','93478','74403','43426','69218',
                          '35958','97914','71239','64875','49675',
                          '70983','23161','28248','53658','77231',
                          '49341','62000','54560','11416','86815',
                          '14674','26201','64043','32639','98840',
                          '51341','75275','45006','16777','14239',
                          '98104','53836','31149','44347','73864',
                          '25303','73845','27512','78770','72562',
                          '81755','26465','11407','89897','44750',
                          '13863','70917','55341','38797','71793',
                          '18176','77087','51363','91198','20081',
                          '89752','19293','61019','73936','41217',
                          '51522','91352','36782','60569','11819',
                          '33301','83785','77782','38210','70101',
                          '73741','93241','24779','31695','27631',
                          '37386','88582','15185','64656','48050',
                          '40983','49716','72358','14010','18581',
                          '62875','73112','40263','54715','95209',
                          '50520','38704','70226','48474','24679',
                          '19828','51678','45075','47634','36115',
                          '63648','42805','48672','32486','49211',
                          '73258','34972','95313','69746','10589',
                          '56362','67867','37198','84336','25019',
                          '97976','19096','42046','95401','86532',
                          '78257','66595','69166','27769','20283',
                          '54223','42694','82191','73080','38349',
                          '83757','81484','57412','57096','18462',
                          '54246','34095','57452','86227','78823',
                          '28586','68263','72972','65038','17714',
                          '38737','35537','57251','19338','50275',
                          '55689','54470','54686','49771','40823',
                          '29876','67780','69634','58924','97921',
                          '92726','79736','90052','46058','68118',
                          '37517','80568','74368','18336','43784',
                          '97861','82327','69342','79086','30298',
                          '74342','11844','27350','91881','87280',
                          '12883','27947','82183','41833','73675',
                          '64254','86445','71359','50565','75437',
                          '54359','82897','93578','79006','15215',
                          '71805','66626','48282','69416','73494',
                          '20605','11315','10309','78877','91605',
                          '42763','40153','69078','67854','50821',
                          '80966','13684','81614','92019','33814',
                          '77170','11938','41406','49762','60022',
                          '63284','39346','54743','93192','52694',
                          '78735','95909','63000','12524','82459',
                          '78599','75627','38061','80143','43747',
                          '44459','33877','29711','33595','69869',
                          '58341','82639','97810','37415','93010',
                          '66691','58055','71206','44771','33886',
                          '72502','50303','32506','83109','78181',
                          '98450','44157','41857','58471','99390',
                          '69786','96231','65255','73228','93579',
                          '66344','23769','74343','85081','95560',
                          '54267','96550','42095','35953','37436',
                          '98493','16200','46956','39313','16206',
                          '91206','66812','56816','68142','37149',
                          '36866','13355','29434','54255','98650',
                          '22434','95766','33859','24091','94326',
                          '99563','19082','90446','29726','11640',
                          '65054','44715','49433','20710','36311',
                          '98201','91719','56306','25293','16130',
                          '51226','16549','83586','83389','27188',
                          '73340','82199','70311','17867','46005',
                          '21380','31735','40490','43409','91573',
                          '77636','12283','58586','94141','53190',
                          '65034','36378','11426','48731','45236',
                          '65674','95302','29437','37603','85319',
                          '66061','11655','76683','13289','85850',
                          '74971','98387','34285','68016','59869',
                          '17978','36704','77400','30018','50119',
                          '91670','80484','28865','84213','18604',
                          '54856','39731','10751','77177','86583',
                          '47778','58547','55644','92362')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

