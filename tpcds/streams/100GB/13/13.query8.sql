-- start query 8 in stream 13 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '43233','71586','27371','52209','61952','61775',
                          '81844','70197','10379','12333','32360',
                          '91395','30517','94211','71975','49805',
                          '24733','33005','23766','55515','49403',
                          '82952','67091','98382','53662','94446',
                          '17654','84240','76664','88810','46524',
                          '37639','97713','20593','61201','13182',
                          '11785','71011','29282','47797','56348',
                          '59186','13911','11869','61410','94664',
                          '57498','92036','61782','17487','10652',
                          '30866','33359','39910','36620','22050',
                          '24496','14181','50249','41524','93677',
                          '33949','73467','14009','48096','62156',
                          '42353','56066','92607','61310','36297',
                          '61177','89318','19227','45712','75161',
                          '33019','77801','17023','86554','60485',
                          '99380','53811','53413','75502','79849',
                          '68047','88122','79603','82225','56075',
                          '93386','54150','27815','58867','11263',
                          '77807','68203','14550','48848','79963',
                          '93902','40372','32821','51052','30983',
                          '68518','71689','47194','78308','99485',
                          '96681','61701','42027','95597','22869',
                          '26784','90183','82800','85687','14649',
                          '56509','55758','52321','27033','47591',
                          '24661','12943','46487','17664','20693',
                          '92725','59536','12514','96858','89279',
                          '91980','57002','34255','23619','89513',
                          '75658','39179','56275','85721','66116',
                          '23034','14565','59101','68798','38460',
                          '74873','10498','25640','40526','57486',
                          '67038','15512','49155','61583','96791',
                          '83835','48985','14874','25596','53652',
                          '56464','34089','99934','78734','55795',
                          '99065','74747','68754','78614','56628',
                          '89433','67055','62968','19761','60804',
                          '14101','36463','67060','31027','30992',
                          '95061','64528','97904','75437','27443',
                          '10320','95827','72048','50391','70224',
                          '48297','64366','99383','97639','20257',
                          '78855','18484','35798','42685','24911',
                          '25717','54944','68982','83008','45754',
                          '20748','16710','56253','43964','72391',
                          '34138','39998','19845','45538','26562',
                          '55513','24347','53804','40110','81243',
                          '46753','10129','15641','64362','16301',
                          '22373','22775','15540','85601','17484',
                          '21123','25068','35532','57183','54874',
                          '44246','85188','99058','35638','43204',
                          '44505','46031','81751','93736','95066',
                          '92069','65997','19627','37380','16082',
                          '11176','65949','45120','51572','35991',
                          '68162','88871','48264','62120','30559',
                          '65466','71928','16904','19073','78064',
                          '84059','59130','56720','85842','53927',
                          '95749','19445','41675','35501','55092',
                          '89026','56208','48504','58332','98971',
                          '35060','40489','59226','20461','32398',
                          '93589','90958','71591','22791','66141',
                          '34451','95014','95868','67719','57536',
                          '34739','65741','74892','57128','18632',
                          '42085','47434','68228','58691','49584',
                          '81680','57262','25577','77396','58201',
                          '61520','27159','41904','41002','21297',
                          '23744','77713','61347','76134','54784',
                          '41113','55078','78233','91241','21778',
                          '64808','91313','23535','49233','92913',
                          '24698','67452','59304','92489','76614',
                          '85389','83311','57591','84893','56365',
                          '24897','44812','27592','37217','93455',
                          '95540','22751','78217','46481','40022',
                          '77512','47352','18177','83328','78194',
                          '10700','10851','94348','43075','67683',
                          '11248','77549','66949','46830','23928',
                          '58262','52487','36452','27893','94657',
                          '90845','40205','51473','91045','78398',
                          '82575','85891','27157','10462','12166',
                          '51661','92665','22894','89838','50378',
                          '19414','99775','82810','89624','26827',
                          '45971','47766','49616','54808')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

