-- start query 8 in stream 3 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '40840','14760','75989','29762','48829','30057',
                          '40743','44901','25413','78807','37212',
                          '96120','79043','72246','23732','31261',
                          '23529','34549','16949','72870','11572',
                          '83155','26801','90877','69003','34468',
                          '12716','27349','26950','91138','39978',
                          '72714','83321','76685','29452','20891',
                          '92551','28575','32390','38296','98208',
                          '64934','56203','86615','26317','90292',
                          '90695','62214','48824','80421','95702',
                          '97513','47814','19133','83906','29864',
                          '92778','76582','56299','13995','85589',
                          '51306','86132','80449','13262','85293',
                          '72431','32820','94660','57502','15338',
                          '34386','37066','26729','10273','56790',
                          '25516','96938','99188','98736','74063',
                          '40121','22542','84778','91982','32530',
                          '18151','59011','89982','49847','75358',
                          '86153','18465','42314','62732','70829',
                          '68564','82340','51598','79983','33819',
                          '84028','20281','85697','44485','57599',
                          '63117','29827','62418','70771','30739',
                          '45891','31150','18344','44959','77930',
                          '81841','96660','41518','57043','92257',
                          '34540','71212','64174','25905','67452',
                          '63972','37096','69736','79184','22034',
                          '59318','48267','44680','28622','44427',
                          '23688','93535','97020','76820','41356',
                          '97897','44816','50859','55075','44358',
                          '29320','34518','50767','52917','53712',
                          '89082','33980','31981','74691','27787',
                          '75222','18168','56063','34274','93256',
                          '45657','32433','17155','29006','98027',
                          '50474','99883','96977','61305','48604',
                          '28654','99762','80067','31360','43948',
                          '19417','49352','16421','79854','74906',
                          '52721','35030','92054','68181','17732',
                          '21740','55656','84428','11127','20797',
                          '18313','98658','95843','13385','44394',
                          '89845','49379','59783','34825','36250',
                          '98155','76696','66796','97591','25014',
                          '33911','69314','38357','42935','40176',
                          '83029','12083','90064','60472','33812',
                          '71116','36730','78581','51453','94965',
                          '46660','77401','97054','77349','35150',
                          '51380','52857','29203','98942','15583',
                          '22693','84231','54972','64196','73016',
                          '78437','86697','61301','65156','55633',
                          '70370','38875','48186','79555','31389',
                          '75146','60387','96568','29917','59020',
                          '10918','86182','32667','13175','83191',
                          '52663','22843','25353','47744','13891',
                          '57997','63554','83407','33852','21159',
                          '19722','64379','34865','70161','27724',
                          '81210','85409','59167','87735','62633',
                          '80797','83123','63466','32097','11304',
                          '73936','92528','82174','72301','46352',
                          '70705','54599','15843','25829','19982',
                          '97156','82479','11413','51699','54722',
                          '92881','32731','37596','42886','21648',
                          '79313','58804','23853','23175','72238',
                          '49901','57212','11389','78412','71583',
                          '33739','44918','88849','16843','88607',
                          '67369','66513','94687','33245','18579',
                          '14269','47823','41540','92173','70795',
                          '21416','57774','13560','98259','44130',
                          '87572','73152','14085','29590','59026',
                          '22657','99833','23469','58760','13874',
                          '17801','31836','62759','66870','92828',
                          '88789','47652','49746','45776','15109',
                          '99587','68546','55510','60980','51249',
                          '31975','53248','61473','68814','36475',
                          '29942','40675','90150','20424','14041',
                          '39234','85329','25771','11116','89693',
                          '72361','24299','82896','39560','87535',
                          '36371','28885','64909','66182','34416',
                          '39100','22289','27758','92232','16113',
                          '65456','55188','62481','47281','54448',
                          '10157','21712','74234','82125','82481',
                          '71524','17660','61803','67913')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

