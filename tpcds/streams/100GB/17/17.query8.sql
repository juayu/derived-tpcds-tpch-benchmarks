-- start query 8 in stream 17 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '77181','79712','72661','85845','65337','59409',
                          '89930','91300','52360','57123','69625',
                          '41700','62694','71106','88757','99867',
                          '39178','46392','52076','50991','59005',
                          '65565','75440','12220','74101','90680',
                          '81143','83139','30031','42493','32312',
                          '85942','34453','83267','23180','82861',
                          '27795','37409','35743','90560','58324',
                          '62193','60508','28650','19223','31757',
                          '28712','48748','29015','30171','50185',
                          '88338','76986','22499','40413','76990',
                          '37500','84707','18288','32985','58091',
                          '88893','87568','76693','23693','72802',
                          '20274','12720','59558','61081','64064',
                          '90981','20941','63296','84025','14863',
                          '54746','81951','29573','43012','71135',
                          '37061','86408','42655','91522','59500',
                          '30156','88406','81823','11604','44898',
                          '69156','66134','74976','96868','91605',
                          '95701','19869','51665','57162','24861',
                          '20818','33329','34273','54079','55150',
                          '93556','62411','13682','40639','95670',
                          '10850','62470','84606','31874','77859',
                          '21034','77743','35420','35436','16798',
                          '73646','31975','17287','88655','90562',
                          '27621','47491','18765','46551','77188',
                          '57984','62886','44356','93054','68849',
                          '19346','37274','67773','11257','56200',
                          '68206','92779','98138','94650','47919',
                          '30363','52613','28519','92677','96577',
                          '62172','14719','74048','73902','18718',
                          '36756','29297','86906','41925','11093',
                          '46335','62805','90299','37389','50297',
                          '42885','77062','72695','74015','58965',
                          '30767','36691','32834','76596','92177',
                          '57826','45625','57303','94056','80793',
                          '24909','22396','83591','10021','90561',
                          '72247','48307','47208','20548','11805',
                          '36769','32300','80926','59498','27541',
                          '50765','54261','89544','62045','18970',
                          '84319','90139','51787','87124','67863',
                          '30484','62676','94662','24761','17910',
                          '28283','34662','43265','78362','80613',
                          '20405','80809','84229','24865','98793',
                          '94758','45737','14440','98674','11454',
                          '81800','28638','26708','81634','20505',
                          '39140','36787','11739','92514','17500',
                          '47304','24196','71082','10892','61413',
                          '15763','27459','91505','32388','81969',
                          '11488','60355','57375','97927','42044',
                          '23572','78929','84513','46621','79382',
                          '46251','61018','45962','94499','91223',
                          '70710','85067','95892','72554','21551',
                          '17552','49084','36012','47673','61765',
                          '78245','31353','79346','30520','76143',
                          '80129','32912','43430','95824','75448',
                          '81572','84410','94291','16477','77293',
                          '42923','50365','26917','57931','19667',
                          '53537','93503','22165','45199','83627',
                          '75082','13322','69860','75379','97261',
                          '83771','30995','52279','52936','38935',
                          '56369','36246','98321','56599','79321',
                          '34888','34520','78102','90734','12041',
                          '51771','21888','37386','27812','69238',
                          '66034','75044','73370','41526','69638',
                          '18975','71750','58703','99117','97906',
                          '97502','15105','44776','85140','25401',
                          '28785','50354','83295','77162','77474',
                          '26545','86702','61129','65720','40547',
                          '59813','36348','55874','36571','84588',
                          '54125','70141','16926','93350','72295',
                          '74957','40267','49295','41012','46274',
                          '45723','85982','47885','73709','21724',
                          '86530','96020','68177','26497','26410',
                          '21918','25764','68461','96828','31886',
                          '42349','96958','96231','40729','23553',
                          '49099','82388','49822','41603','59671',
                          '92760','15395','18796','82597','82105',
                          '14180','18662','45216','53842','14696',
                          '65618','33197','12448','67840')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

