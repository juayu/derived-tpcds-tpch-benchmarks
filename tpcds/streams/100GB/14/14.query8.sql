-- start query 8 in stream 14 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '59157','54300','82112','87660','69355','29136',
                          '82158','84456','64909','59173','69932',
                          '67609','22133','83279','27793','88544',
                          '30414','59537','82552','38393','18077',
                          '96560','92575','83601','15346','88642',
                          '44817','41403','57530','32275','12558',
                          '92589','74517','51063','17350','71785',
                          '44667','60418','40225','62616','47597',
                          '75008','55154','47728','48745','98273',
                          '46087','89394','94304','10671','35365',
                          '80185','76964','51546','27566','72938',
                          '10484','65750','92889','84635','38736',
                          '29413','96140','97655','64642','41591',
                          '16828','45745','28620','73227','63049',
                          '44548','19219','92431','56971','94216',
                          '24623','23459','80389','25892','61580',
                          '72518','55765','75807','89696','80523',
                          '49083','26539','46190','37998','31386',
                          '27519','56553','78559','60185','63487',
                          '56117','80000','70883','78592','26975',
                          '11200','90646','35691','38766','68097',
                          '79077','89825','91793','32084','64197',
                          '94325','66573','96876','30769','97449',
                          '95774','25828','86211','50710','62206',
                          '26442','76040','70334','37134','22319',
                          '14435','81014','92956','86318','84656',
                          '89022','79124','32786','92008','85135',
                          '42379','20418','87206','71779','81844',
                          '87430','35747','23740','14051','30754',
                          '38525','39745','89766','72306','87282',
                          '11909','13195','15353','52935','51052',
                          '84434','47700','31356','58804','46731',
                          '40050','49528','17419','17826','80709',
                          '32161','66106','29608','99856','32635',
                          '44149','28088','17412','51816','32771',
                          '41732','93206','82778','34829','83507',
                          '91521','79169','81781','72073','59226',
                          '74868','77915','99935','88776','17688',
                          '49634','21042','24303','53041','67956',
                          '27005','38745','71229','58983','85294',
                          '56557','18687','49623','66129','41655',
                          '58405','99376','20563','18628','86815',
                          '74349','50126','49246','96049','17992',
                          '14796','40190','44887','82354','20273',
                          '83691','57879','97168','71979','71929',
                          '89951','71538','37260','58830','29532',
                          '96272','98866','85219','83641','11877',
                          '49173','30164','36482','90721','46219',
                          '10929','25535','15411','51233','26270',
                          '25813','47788','76359','91364','40162',
                          '98424','14166','86750','88600','36455',
                          '96227','85131','46438','15056','47969',
                          '80570','17724','54156','72520','84017',
                          '80564','95171','48442','86509','38018',
                          '70057','71012','33065','36033','52603',
                          '30493','25286','49536','24672','17168',
                          '89782','38331','95093','80221','38894',
                          '35520','23312','29762','33089','37758',
                          '80080','95725','30874','98365','10137',
                          '70800','14099','76048','81169','45004',
                          '57362','40984','91509','98754','88989',
                          '63479','45024','13439','91560','22423',
                          '28667','25063','58094','95942','35420',
                          '75025','56189','42146','96856','73276',
                          '50731','55506','39835','78711','86468',
                          '17702','55787','27007','82855','49872',
                          '24046','87458','57645','75018','93403',
                          '83905','98675','37452','68215','64847',
                          '59273','48958','75395','41468','62732',
                          '35814','55070','81282','40141','30146',
                          '50726','32434','44569','36890','53938',
                          '48750','68355','88846','11283','67903',
                          '25311','70004','69516','71281','28702',
                          '39085','34050','15387','60939','45019',
                          '57713','61164','30026','31193','75666',
                          '65397','91628','26339','37217','80900',
                          '42855','10168','88460','94992','42302',
                          '75539','43421','43224','10081','50984',
                          '62153','37862','27092','93240','57982',
                          '78684','69970','92295','63090')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

