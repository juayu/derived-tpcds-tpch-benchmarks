-- start query 8 in stream 10 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '45416','41175','51981','97685','17707','92896',
                          '88611','22192','45664','48897','87484',
                          '50103','21606','45804','58886','66491',
                          '88955','12957','62588','64091','17690',
                          '32287','88444','77789','58123','85984',
                          '95283','42863','15389','60473','62241',
                          '86573','28066','64447','66341','53581',
                          '42082','47952','93393','80192','39980',
                          '90476','33659','79024','25195','86059',
                          '20525','49360','27075','45934','10861',
                          '98895','29733','91216','10017','25836',
                          '10864','71589','68501','94281','55898',
                          '28006','98379','22323','46563','48194',
                          '19156','77068','42849','79602','85101',
                          '21723','18021','25399','51771','96052',
                          '36607','30327','15727','29529','78941',
                          '76046','14039','75826','44620','50409',
                          '83748','93010','26671','71494','24596',
                          '84115','35224','62356','72955','62818',
                          '87656','42391','72394','28720','17134',
                          '86253','31066','53166','94125','12077',
                          '18267','10061','20047','95891','69746',
                          '47407','97634','19621','27655','46243',
                          '14953','54176','69967','64952','45403',
                          '30387','61146','86929','54993','15595',
                          '43274','73486','26413','20917','78873',
                          '40129','47402','95882','22673','58931',
                          '11611','56171','78481','11277','55268',
                          '78708','25484','99361','38383','22790',
                          '95321','45761','55705','83494','79918',
                          '60317','47699','76484','76799','19430',
                          '29750','42358','30802','34095','75504',
                          '31099','34854','36295','15106','49641',
                          '28088','28707','86747','39217','67334',
                          '44552','78630','95432','72149','83694',
                          '99976','51008','69670','85971','47733',
                          '56022','70396','34706','85663','14283',
                          '90789','80998','83076','97680','29805',
                          '84704','75509','47935','30453','58209',
                          '57484','35788','46960','46396','74962',
                          '13160','84475','32776','11832','45647',
                          '42750','50595','65329','59581','49376',
                          '83996','62561','54623','12274','79844',
                          '61239','26951','34530','41970','94320',
                          '90259','83110','22998','23053','98282',
                          '97886','54698','32579','39976','22115',
                          '92345','52794','52530','42196','12833',
                          '73642','88797','10079','33645','97204',
                          '54022','14245','35293','15321','20647',
                          '15103','22999','40122','39233','59946',
                          '27378','85226','85980','25961','60449',
                          '63257','77908','49746','63381','33314',
                          '71199','66784','65940','48080','72605',
                          '48874','13666','14128','99821','31674',
                          '48998','48162','47060','82257','97606',
                          '16260','73469','71783','43642','40099',
                          '10126','15679','68961','78540','14556',
                          '55334','33794','57259','77239','83095',
                          '45359','80105','50885','32917','53944',
                          '75468','97934','78139','83735','38969',
                          '58423','93930','17639','49737','80457',
                          '21403','26010','31018','79053','41838',
                          '36544','32349','25712','56825','55407',
                          '32620','17171','80516','93813','45843',
                          '59962','74905','96276','57567','93103',
                          '34818','55593','65106','40075','86073',
                          '61942','73258','95023','45840','89756',
                          '38885','20312','17746','48157','83633',
                          '67090','13181','61601','83617','25648',
                          '95653','91055','47912','26749','45072',
                          '82746','27606','92449','32422','10543',
                          '97780','96306','72763','84311','63898',
                          '30226','60544','51782','63745','21992',
                          '43150','45033','86630','19663','29138',
                          '53752','47147','41440','88016','15099',
                          '64672','99364','11868','33130','52673',
                          '22579','26271','36600','16681','74151',
                          '12879','93460','41578','82150','52494',
                          '59727','65953','16202','44210','16597',
                          '59017','51491','11585','47917')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

