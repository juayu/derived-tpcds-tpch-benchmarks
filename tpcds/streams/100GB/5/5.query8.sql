-- start query 8 in stream 5 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '58574','28823','79591','75329','14485','14330',
                          '53609','15794','46649','71942','20939',
                          '34845','83769','52993','99194','76881',
                          '88330','21473','63870','94667','82280',
                          '97657','75207','33627','60921','96601',
                          '15766','66922','99188','34389','97901',
                          '65358','44405','29332','73796','66606',
                          '52066','67955','98640','22727','48113',
                          '59008','79940','26623','42333','26278',
                          '46087','69582','60478','84231','95856',
                          '60058','25812','39874','74905','55287',
                          '47030','27621','46762','57088','37051',
                          '64585','30274','13154','59763','22190',
                          '80941','86687','86160','35730','31681',
                          '61255','92713','42144','69944','71182',
                          '22862','36598','94772','63833','25709',
                          '54103','49019','90718','17493','73208',
                          '17322','31697','32932','65851','44034',
                          '65219','82054','21326','24421','15936',
                          '80377','79354','72647','82390','70214',
                          '88958','27751','76596','73102','21578',
                          '68318','17473','30482','53725','61493',
                          '46164','80197','23726','76599','51506',
                          '24583','83690','25541','12798','22453',
                          '40580','36507','84453','52529','48170',
                          '79219','56407','89376','74067','98670',
                          '24026','60599','85396','18945','42307',
                          '53015','80847','18779','65274','45135',
                          '11543','45132','99668','51230','26769',
                          '41247','95378','60740','17808','66923',
                          '14666','72455','36874','49025','63113',
                          '40377','43907','26598','99184','30216',
                          '36784','25819','71624','84176','98412',
                          '65010','94786','21376','28561','81170',
                          '20469','71621','45936','92360','65723',
                          '44098','16920','82737','56965','81549',
                          '30208','28619','31601','11283','58365',
                          '40394','26510','92784','80840','65032',
                          '71686','50562','19501','25688','65436',
                          '30620','16528','76947','53366','46898',
                          '34463','75894','13814','46431','48866',
                          '18409','61665','80416','32498','28342',
                          '92723','50697','13542','98210','62949',
                          '10925','42109','64356','53649','88032',
                          '89309','62952','32652','32700','43750',
                          '42989','75944','90772','13595','61675',
                          '97823','74193','19958','70395','26715',
                          '57992','45320','54084','89086','33302',
                          '58659','90519','57516','64713','46740',
                          '62986','76377','16549','48360','21997',
                          '84643','63948','99543','99337','38707',
                          '71666','99643','66822','40927','86331',
                          '69223','91139','25998','23931','97418',
                          '65936','70076','65500','22881','69366',
                          '14256','89610','78716','95893','48693',
                          '27748','84427','95516','61236','19384',
                          '36068','59780','54155','80331','98413',
                          '71711','61372','52785','64148','55681',
                          '78780','13428','66599','80003','60431',
                          '45606','56364','82509','48850','89145',
                          '64995','68944','87153','20715','31816',
                          '29943','99546','18248','43449','24904',
                          '65908','16485','35672','15265','96960',
                          '72924','54800','84052','85917','14718',
                          '73279','54317','94969','18039','66133',
                          '53643','91148','66921','34797','14402',
                          '28172','84459','90401','86342','62534',
                          '46291','35792','10345','48871','19835',
                          '96917','68028','40491','22374','76562',
                          '36755','13675','44283','48348','42040',
                          '80366','34060','58635','65881','81694',
                          '54123','85919','10735','11225','86726',
                          '75004','73426','62978','99412','65599',
                          '23388','83017','90520','39545','84460',
                          '12704','34551','44786','81682','73181',
                          '39319','98371','63798','15574','98865',
                          '20221','57919','98268','88281','45596',
                          '15327','69832','85469','15443','13622',
                          '64580','58003','88421','91884','45762',
                          '35901','97140','21821','59467')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

