-- start query 8 in stream 11 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '76187','36131','76125','64475','40298','90144',
                          '93988','92400','84295','36506','92488',
                          '74097','73835','58029','17105','11740',
                          '14995','37441','30276','64264','61790',
                          '82630','24367','25395','64150','24248',
                          '29418','59248','20651','86459','88258',
                          '29797','12147','88346','67052','81693',
                          '73199','99076','10437','42307','70326',
                          '57091','20769','18369','98241','99998',
                          '68879','77265','90135','72355','15563',
                          '63421','53291','18781','37377','50456',
                          '89883','94531','45135','68971','68494',
                          '66970','63611','59498','64804','59002',
                          '21386','57621','11017','21489','82741',
                          '30639','33422','97170','19850','35858',
                          '25195','50455','28104','71223','10903',
                          '77650','33519','84014','96974','95864',
                          '54515','57434','27159','10887','31343',
                          '64445','61977','48259','18081','16135',
                          '28669','28061','94155','22183','56166',
                          '94175','69943','23472','96174','13278',
                          '31341','63379','30564','15353','81910',
                          '68422','77500','40240','29124','99158',
                          '44716','62697','23943','49763','53227',
                          '51186','89437','39072','94969','35976',
                          '98903','13990','68694','32418','84166',
                          '68530','32165','14329','66489','14868',
                          '92130','67604','11871','41272','80862',
                          '37194','32552','87202','32541','54923',
                          '29378','76358','88875','90851','29911',
                          '59811','67879','40955','54984','22293',
                          '32371','32331','34413','68881','19719',
                          '36327','80400','97981','57579','34596',
                          '64733','17135','42021','51939','55360',
                          '94411','78355','21393','57609','75304',
                          '50734','90052','92442','61609','23335',
                          '64711','43037','42147','16004','71870',
                          '87983','93803','66328','37584','97135',
                          '97720','11641','99989','24650','81477',
                          '93793','22268','98220','27531','66437',
                          '17199','27793','23948','12535','78919',
                          '76489','11928','92597','35493','32182',
                          '35053','28250','87056','51669','41758',
                          '65264','62098','66942','98131','65526',
                          '61146','97927','16714','20315','28926',
                          '77732','58882','33555','79653','65763',
                          '74412','29763','75205','68206','16102',
                          '84956','27306','33954','41623','63483',
                          '49908','44978','83979','96910','67676',
                          '50709','66806','42214','67891','99282',
                          '72395','91669','75009','90702','98300',
                          '11117','82442','23566','40065','18909',
                          '17869','16516','74364','88128','54159',
                          '53665','40726','89655','88378','18809',
                          '40791','79906','39575','22481','15163',
                          '55137','58294','80735','20755','91241',
                          '72079','84961','23843','34687','99249',
                          '43994','46810','62912','83369','74577',
                          '47046','66817','20701','55437','12821',
                          '15958','47193','49864','73082','52123',
                          '13883','31024','55667','83533','96513',
                          '17830','18542','77846','68622','16901',
                          '36363','71793','26954','70652','13219',
                          '91138','28802','68162','71406','14330',
                          '22383','72817','99333','43494','68268',
                          '61263','20493','64516','63709','82557',
                          '31793','63056','30660','38636','15208',
                          '19932','54389','43415','27359','86774',
                          '63634','63355','88982','21953','26892',
                          '30997','36470','37038','90213','34371',
                          '24683','87985','68317','76799','57885',
                          '22654','59933','41476','60856','82675',
                          '65970','87009','86195','17696','32079',
                          '66488','91244','81743','64054','58978',
                          '62150','69699','48877','76580','43531',
                          '30535','73159','21103','35539','71120',
                          '18547','44898','69974','21128','27627',
                          '96844','82133','20182','93271','72300',
                          '72714','75439','42510','84101','33367',
                          '21317','23114','64847','97751')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

