-- start query 8 in stream 8 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '24279','84335','94235','55277','83096','14103',
                          '87758','83704','35066','44706','27378',
                          '84825','77237','38632','43684','31930',
                          '70837','93432','91887','34262','78063',
                          '71782','99831','60101','30729','31372',
                          '26417','95770','73516','46253','19772',
                          '57515','47636','97310','10982','76797',
                          '51819','74128','22778','77650','48674',
                          '28860','48759','87323','42360','49606',
                          '78013','55393','78905','50780','15550',
                          '57043','70983','84637','11833','91674',
                          '47206','46944','67827','39860','75655',
                          '89455','61430','68261','66144','14675',
                          '12021','87668','56260','87210','99860',
                          '70473','37154','53671','26264','14150',
                          '88231','86555','58706','12942','82072',
                          '52407','96267','77172','48002','75444',
                          '23295','76860','13406','76843','68263',
                          '44839','92418','12983','56962','23342',
                          '38189','19276','43629','21914','51289',
                          '97390','95036','83184','81613','30402',
                          '36898','37060','45391','83420','50696',
                          '36006','33419','85828','26901','99665',
                          '48097','52248','25734','38881','47761',
                          '25417','29454','46021','77371','30652',
                          '65110','38063','13575','50363','34752',
                          '12547','86509','81755','88239','66381',
                          '27024','77109','77384','26726','40770',
                          '25003','77892','59687','66195','38522',
                          '27539','80994','89997','64464','70299',
                          '67817','78993','70453','46010','30002',
                          '92351','54428','54718','85761','48550',
                          '15714','27181','98019','76256','45694',
                          '52423','72708','36922','26829','24316',
                          '26692','91166','42114','96088','65382',
                          '64454','50919','59932','24542','19656',
                          '66692','51424','29413','52729','65654',
                          '88293','87976','79933','53532','71445',
                          '97535','75187','13831','60500','33423',
                          '74263','12665','64796','45278','66333',
                          '86863','22832','29476','58239','93384',
                          '94036','35926','44614','91441','84498',
                          '58554','93635','56202','61803','33254',
                          '12954','52335','19110','15635','54737',
                          '93617','26903','35539','94569','70359',
                          '20232','82690','29392','15521','96293',
                          '34305','56494','64070','94378','23626',
                          '82429','80370','12375','36239','14282',
                          '83325','80407','45846','68754','42582',
                          '17305','94445','72228','15417','61979',
                          '88898','16261','70671','75486','50979',
                          '72912','22490','14664','40986','54637',
                          '66401','65114','11262','53681','93979',
                          '10789','45841','57378','48745','78771',
                          '30954','24503','82131','50236','74674',
                          '27426','22837','36482','91783','27254',
                          '67611','30201','50955','18981','64407',
                          '83562','57764','95893','72466','75330',
                          '32435','65938','53901','87534','95914',
                          '71957','31528','76036','37880','46504',
                          '27989','40296','93474','49435','10667',
                          '68343','27915','99008','81883','67536',
                          '45338','63842','41334','23764','63903',
                          '87473','17012','77025','92250','40619',
                          '64687','83270','56919','82789','60211',
                          '77700','21439','33513','47304','20030',
                          '50074','51661','32718','52703','20372',
                          '92819','92615','10292','29325','21737',
                          '99289','14039','47495','49334','99272',
                          '32793','84833','67873','88007','29098',
                          '96636','72852','72285','64266','10833',
                          '95711','70841','15759','75612','87990',
                          '78203','39715','23719','72798','70371',
                          '68879','70041','62431','23915','24741',
                          '39093','67135','40952','85651','40911',
                          '49472','62451','15377','24431','28292',
                          '90657','82159','36259','22061','96420',
                          '71071','45466','30609','39358','15542',
                          '27727','57277','30188','55826','18852',
                          '18179','22425','90672','81515')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

