-- start query 8 in stream 18 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '23988','65009','91773','93896','97215','58191',
                          '93811','76562','29641','17948','58854',
                          '73005','27758','44341','61071','99560',
                          '52136','16945','94337','38895','78784',
                          '27832','44961','95116','40060','49701',
                          '36635','60690','14079','45023','29096',
                          '32937','18688','31395','87166','51060',
                          '57699','39399','56358','32949','84909',
                          '95961','90210','87919','88671','10187',
                          '67838','58719','14336','60294','20023',
                          '60354','84704','47967','64079','83826',
                          '29564','75393','41305','59152','50927',
                          '64534','21019','44651','96613','10084',
                          '71200','77682','49553','14885','26194',
                          '96667','64957','84403','76512','36198',
                          '90078','21470','43312','14794','71515',
                          '87252','18131','96800','43318','41591',
                          '76401','45108','48833','47070','55411',
                          '67423','94306','18772','35424','39346',
                          '30036','37170','86116','57642','51768',
                          '38411','19786','34641','85864','89905',
                          '86726','21849','58027','90883','24863',
                          '64489','90802','68106','89948','37401',
                          '57414','41679','68037','90481','48040',
                          '78120','57101','95058','30404','19509',
                          '65733','42107','82035','57242','57723',
                          '85529','59080','99680','84353','53343',
                          '63971','71788','71809','67286','19459',
                          '59263','58253','61465','91817','62945',
                          '47808','24474','80978','61521','26885',
                          '99326','92995','17087','70815','42564',
                          '36307','96515','15912','54311','64174',
                          '95964','56378','34057','72957','18036',
                          '46039','82596','16000','63970','68962',
                          '24365','44535','93853','74480','88027',
                          '29681','71981','59528','80505','48765',
                          '73122','89507','98053','99034','34259',
                          '58112','32177','52457','23645','20894',
                          '31313','96137','63613','31029','60166',
                          '34857','36324','23740','19535','71658',
                          '77990','20357','54267','48820','89939',
                          '86524','83785','60022','64316','27742',
                          '50390','17764','43366','71960','17339',
                          '26581','60621','75206','81176','81128',
                          '25403','57782','90824','76491','36894',
                          '62846','45056','89530','74336','49714',
                          '76314','92858','27577','77748','21929',
                          '13653','81623','17737','38346','57724',
                          '19276','28749','40924','77832','86614',
                          '27460','58051','48513','18745','51171',
                          '19517','18903','94019','18855','78215',
                          '61352','70796','63269','68879','65577',
                          '73243','76284','81561','28583','73988',
                          '28410','29105','15704','33305','63359',
                          '76929','87960','30814','73715','94478',
                          '84516','83998','89426','30023','56011',
                          '33677','63212','89856','12938','25792',
                          '33271','29692','45806','69757','20472',
                          '97260','49131','78574','80586','84921',
                          '44841','54499','82002','13891','75284',
                          '68540','19036','80909','43262','21085',
                          '86006','23486','22485','51413','70713',
                          '74787','95099','11083','44706','98510',
                          '34110','78386','16550','38437','29233',
                          '64634','79579','19561','44858','91702',
                          '58143','74039','50832','83622','48581',
                          '57777','38827','11313','72784','91536',
                          '16536','46759','78424','16262','64726',
                          '14399','12873','89497','32020','79409',
                          '67529','37196','12042','84666','73374',
                          '78988','59949','47591','41323','82184',
                          '17000','87190','99837','26540','57971',
                          '62946','83367','67603','34377','57784',
                          '63992','36469','10271','79845','45350',
                          '42231','22462','97363','79213','52744',
                          '34896','36796','21646','58993','41192',
                          '64746','92361','95227','14693','82650',
                          '60760','42568','18511','32516','53615',
                          '68825','67185','96780','52150','14761',
                          '92399','96026','38096','16652')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

