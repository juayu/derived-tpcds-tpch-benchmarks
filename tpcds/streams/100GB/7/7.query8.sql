-- start query 8 in stream 7 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '96924','49756','74637','52831','33108','49348',
                          '27579','99752','84693','72205','87274',
                          '13510','54760','49961','36663','40800',
                          '88773','62584','80535','31357','88980',
                          '78756','59309','75209','30039','29488',
                          '46006','97610','86612','16332','46196',
                          '66759','91810','34886','17172','41003',
                          '95630','18526','59945','92865','98212',
                          '84696','98734','56441','46058','68118',
                          '65725','60316','25043','38027','23682',
                          '47122','33035','67014','59011','25408',
                          '44560','22308','92089','89616','85209',
                          '20304','74373','53063','66305','94512',
                          '15583','13782','25178','22352','26581',
                          '85068','84446','69321','55932','71458',
                          '18504','37790','27609','61029','63480',
                          '77118','86307','30868','81459','13766',
                          '98633','40773','54590','67322','57362',
                          '58342','85176','45635','84314','34479',
                          '68205','17827','47047','95304','53545',
                          '31317','21313','62986','22569','92465',
                          '41513','60487','55109','61130','32647',
                          '44857','34923','49553','86940','50419',
                          '57303','23396','65853','90585','42657',
                          '45164','73615','93831','93810','12482',
                          '31656','10751','16446','20354','76520',
                          '90202','29163','20282','15138','57897',
                          '55061','97555','65325','33442','64154',
                          '69176','93416','31219','51232','28550',
                          '29085','40512','27358','43474','31366',
                          '36541','47894','70110','41344','31638',
                          '25848','98272','35364','64077','70686',
                          '57189','97302','59114','67257','22583',
                          '86074','15388','13945','11329','99475',
                          '84582','51650','29000','31698','47573',
                          '40408','90351','24651','15860','47614',
                          '84129','54484','77257','70755','86860',
                          '75772','70631','63141','72453','51371',
                          '94424','20277','54058','24936','53878',
                          '23292','64515','76799','43742','65534',
                          '58225','47144','37317','97100','39326',
                          '67828','96286','14557','60946','70339',
                          '11773','25711','96566','54559','97607',
                          '95111','30446','39919','21118','31920',
                          '90078','53592','47660','62599','73560',
                          '58213','78748','55418','79583','19973',
                          '62139','49250','95798','24038','80053',
                          '54689','31387','94874','96045','36262',
                          '74398','97366','52559','36376','94650',
                          '76626','63378','79325','67617','64088',
                          '60395','12790','40893','21588','86655',
                          '36492','51325','42895','71767','12792',
                          '87920','51763','95273','95840','89442',
                          '13084','20196','61006','42941','61131',
                          '19788','84771','85144','70243','85444',
                          '53905','33620','25218','78023','40786',
                          '83858','19361','80171','32005','74335',
                          '83621','43449','85420','76916','98162',
                          '16911','17822','41184','92060','43595',
                          '14366','85858','53940','91935','47911',
                          '20232','82117','79897','36204','61310',
                          '29198','90815','20544','95860','43734',
                          '88299','11571','10980','43848','62629',
                          '19105','57818','39344','10917','53675',
                          '28315','55875','37218','47887','59261',
                          '70442','90542','40806','21317','48572',
                          '90485','53709','66710','80043','74275',
                          '63425','56978','66830','95541','28856',
                          '97768','85891','21115','89428','38372',
                          '24996','92875','44289','86739','96186',
                          '22883','61028','62728','50766','23136',
                          '23610','29861','58666','83095','36260',
                          '89390','12163','93805','18853','88057',
                          '25406','48464','19915','46955','93379',
                          '53999','25583','44993','72899','94799',
                          '64561','49628','69117','39611','78437',
                          '99534','99904','94647','51013','24364',
                          '21198','96949','13041','74628','11401',
                          '40475','86824','29979','28865','54499',
                          '28137','37164','88327','11790')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

