-- start query 8 in stream 16 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '71893','92450','79603','77103','22364','37779',
                          '37656','93491','87138','11799','18683',
                          '91841','59969','86952','99114','92284',
                          '83928','23490','98795','98172','71113',
                          '41064','77042','65829','71050','29450',
                          '33909','88793','26098','79158','96728',
                          '79117','72941','58267','12756','63339',
                          '93851','61534','88090','31454','91169',
                          '35015','39158','57366','80592','31133',
                          '16992','54025','70789','20741','61805',
                          '77182','84520','93895','22856','73186',
                          '87249','25956','45370','63488','72305',
                          '50189','68958','47652','97451','25652',
                          '81757','32649','99977','63515','33250',
                          '39353','87648','94882','52603','33303',
                          '27689','14522','31569','30914','36369',
                          '28812','10794','77854','18123','16766',
                          '84057','81828','41040','47461','30652',
                          '89565','65706','89575','33854','78438',
                          '28858','83138','23753','80901','73123',
                          '22623','96028','94775','28210','57760',
                          '34015','41778','64805','79796','99116',
                          '31293','16901','39134','24322','55191',
                          '72816','98775','75639','77142','83537',
                          '17766','25125','15243','56563','41259',
                          '96123','74587','47106','72910','29726',
                          '46513','93686','83561','27226','12337',
                          '26155','55542','25982','87656','15757',
                          '98407','46284','68443','99583','29965',
                          '78750','70743','55430','76780','68418',
                          '78326','99396','98675','51527','55906',
                          '63115','43230','77203','15410','72145',
                          '80247','73783','90558','96402','13422',
                          '46972','44058','41452','98285','91672',
                          '23852','14011','48344','41084','78544',
                          '21306','74504','73579','82711','39311',
                          '18152','60870','45159','80942','71565',
                          '27646','30105','18546','99261','72119',
                          '20246','59805','33867','39501','94076',
                          '19851','31553','74070','49542','85883',
                          '22595','29731','48585','43347','74627',
                          '94924','31101','95354','85873','53558',
                          '89135','68694','59967','77800','18171',
                          '48749','13245','94732','17595','99803',
                          '56086','17940','41228','95458','91180',
                          '63637','71296','86676','23550','57423',
                          '57758','99997','63261','26928','36284',
                          '28093','49563','64002','73999','93660',
                          '39405','95786','14837','68400','47152',
                          '91369','36845','72682','75264','93451',
                          '68234','25948','42553','19619','74478',
                          '23658','49141','98447','73574','88822',
                          '77504','80621','91619','91638','26402',
                          '74967','39902','16196','39816','95213',
                          '90950','32309','10011','97423','24553',
                          '12513','42429','12949','88919','59737',
                          '41087','24474','22162','16896','95796',
                          '96676','58963','25902','77326','18897',
                          '53304','35330','18488','60171','32439',
                          '59065','80330','49217','45926','63181',
                          '17082','98779','75647','66227','90652',
                          '37237','91378','12472','93056','92145',
                          '40007','90370','18272','17220','68905',
                          '21385','38725','91960','83507','46109',
                          '37476','75717','51902','43639','49010',
                          '30645','45641','10097','93565','70123',
                          '61174','35563','27304','68862','93392',
                          '68278','13504','64117','75449','83627',
                          '97761','13036','78344','79112','10656',
                          '85718','66639','33353','21168','44992',
                          '81661','61345','16226','19967','91261',
                          '17386','72939','79963','13395','76884',
                          '60104','81867','31226','59731','15267',
                          '80135','74265','63272','40082','66869',
                          '69818','56936','30650','80379','11407',
                          '67784','72576','19892','71248','32934',
                          '71896','42777','99434','71278','24550',
                          '40032','36386','59013','80752','55949',
                          '36135','27448','94101','29966','91341',
                          '22276','99428','66050','22427')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

