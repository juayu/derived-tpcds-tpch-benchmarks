-- start query 8 in stream 1 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '85004','89207','43633','95925','96818','89159',
                          '28005','28436','86186','25575','11191',
                          '92989','21357','69925','12263','21148',
                          '37365','90199','53832','75253','79567',
                          '51671','14773','87396','72809','13291',
                          '46792','79945','89966','54144','45296',
                          '53263','19381','78090','54037','92187',
                          '14666','29936','63378','75250','38850',
                          '56108','29304','82995','93284','69850',
                          '91482','16557','41584','28053','26888',
                          '99181','31908','86782','71574','53585',
                          '54636','61785','64859','45855','78567',
                          '55902','97653','47531','16143','27280',
                          '54722','45731','74018','96874','40295',
                          '79699','27209','59315','79975','87130',
                          '24125','21439','96879','41477','92846',
                          '35527','75732','81547','13339','33784',
                          '97285','83016','58217','80538','26430',
                          '76233','19237','65767','39729','24483',
                          '52528','82516','21018','32009','87389',
                          '88362','68060','43902','43972','15256',
                          '60105','92326','53199','39869','20755',
                          '17099','28402','65237','51689','72773',
                          '47631','76038','34253','52736','39961',
                          '86710','72772','52564','42068','80669',
                          '36442','56719','98089','74267','68871',
                          '96597','34222','59481','69252','63791',
                          '71422','73987','71858','24420','26149',
                          '72607','20133','41719','58441','26777',
                          '89354','13301','19352','70805','30300',
                          '16171','53251','24195','59452','12707',
                          '26449','50155','86074','38514','60730',
                          '58149','39079','56501','95338','74506',
                          '61231','89469','78203','49355','76361',
                          '76270','83722','67202','74561','46471',
                          '76054','83186','70356','24946','54849',
                          '30228','78899','77346','11317','15355',
                          '66381','44362','17496','48124','13799',
                          '23993','89144','67715','58340','58849',
                          '75252','30871','33058','96115','55271',
                          '15139','77683','80424','96495','98990',
                          '40267','47666','30085','65896','21088',
                          '44671','16748','60841','66598','47329',
                          '31259','64759','81432','49636','40403',
                          '69709','29786','54210','62657','75884',
                          '96208','85310','43151','60223','82351',
                          '29806','50625','19959','54898','74863',
                          '46465','52535','57497','92578','15175',
                          '62918','21484','52439','36765','76411',
                          '41469','73950','17053','12748','80630',
                          '73612','67793','93902','76339','94516',
                          '39050','56967','92036','70140','64866',
                          '14198','36184','61566','10999','46586',
                          '98897','17557','65531','81499','12552',
                          '68456','55987','44256','61021','65751',
                          '82264','58623','31453','38669','93630',
                          '18209','62543','86448','20625','87186',
                          '17876','59417','35636','30289','27304',
                          '91261','33466','92130','64229','38200',
                          '81348','73703','99279','15485','78809',
                          '62279','84878','70562','94421','85549',
                          '49827','60068','42759','52658','11858',
                          '51603','47574','39272','26240','36532',
                          '48812','30877','88701','59383','94153',
                          '77652','76245','44596','18746','31679',
                          '22974','56772','45676','83014','36237',
                          '78775','85312','13174','73473','73407',
                          '67772','53798','28555','10395','42648',
                          '95845','53013','72484','70045','62900',
                          '82454','13263','92325','16960','64557',
                          '13235','23122','83886','67696','77435',
                          '37697','71620','67484','66212','13850',
                          '27870','16634','76251','98806','48531',
                          '51377','72851','79059','76395','22054',
                          '79976','30717','66660','14471','86512',
                          '48483','37839','91049','16725','51544',
                          '84051','29910','47044','62336','24204',
                          '63558','57249','11124','54473','76827',
                          '97897','76433','38712','74759','10421',
                          '82098','58800','37379','30450')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

