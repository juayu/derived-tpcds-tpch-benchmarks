-- start query 8 in stream 19 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '91521','26156','42666','47245','41595','99988',
                          '99910','83644','64820','63526','74765',
                          '68973','84583','62941','55059','43096',
                          '49773','84903','12139','97955','88971',
                          '94243','70167','39876','41913','11267',
                          '37320','17453','79985','27606','86499',
                          '38459','15189','53966','17055','17456',
                          '34392','55084','74382','74354','98956',
                          '51003','56043','10042','11927','76565',
                          '27629','21261','95071','25015','34950',
                          '98744','93499','83155','97304','93801',
                          '61135','27490','63094','73694','73230',
                          '72156','33328','42458','22876','50911',
                          '51659','92786','24621','24104','77667',
                          '79000','59218','13311','37752','93811',
                          '31277','28365','33053','40862','32284',
                          '20405','42388','93157','52064','22483',
                          '66544','48749','44206','13243','66009',
                          '88905','26238','89854','69044','63127',
                          '39996','76016','16909','97710','82936',
                          '45314','48200','50946','18486','10262',
                          '32812','48397','73253','85382','86228',
                          '67755','70499','52949','14254','32506',
                          '78108','15440','52502','78124','34029',
                          '44445','30474','12575','92921','80332',
                          '76223','80730','79674','65669','75707',
                          '96060','50652','97080','19040','45888',
                          '49807','97276','48894','18702','48577',
                          '24087','70815','84709','21709','44669',
                          '19714','14698','50208','40902','99336',
                          '53420','36202','19122','71117','63450',
                          '58792','44898','85246','34433','11451',
                          '11145','23133','73182','75181','63054',
                          '79329','15607','20101','91118','65232',
                          '99924','66689','28701','17517','26691',
                          '28331','79521','26300','26532','49063',
                          '94963','26005','88951','89516','97279',
                          '36886','12901','45757','74584','22364',
                          '81788','40029','77324','65244','33631',
                          '69842','39233','37338','27130','97846',
                          '31380','68252','60062','46597','14259',
                          '72698','62633','42976','46000','86838',
                          '63398','94727','56429','79948','70355',
                          '12087','27437','95722','89690','16643',
                          '18353','34822','56636','35909','36388',
                          '70740','38667','54689','58942','85742',
                          '11418','73143','32801','45228','15847',
                          '28262','57258','55110','16651','57820',
                          '69555','31414','94074','20531','60194',
                          '55348','49712','93353','60977','92348',
                          '32763','77805','40170','67470','96971',
                          '91982','92012','28746','60844','36592',
                          '20489','90113','99624','64509','98531',
                          '56414','12261','45156','91049','69460',
                          '82217','88149','71342','39610','89252',
                          '10090','34904','92403','40455','63257',
                          '23024','83788','29199','30107','57170',
                          '39718','70891','42456','93900','86247',
                          '74632','26089','59724','75469','68042',
                          '74146','40143','18673','66409','87652',
                          '55226','96560','86650','41594','42685',
                          '83675','22096','55399','30364','41535',
                          '73506','49349','92615','31493','19910',
                          '73769','81397','33948','87009','51215',
                          '11153','97631','45882','31850','21557',
                          '22280','37205','87110','53052','27596',
                          '22709','58762','94551','47807','37019',
                          '22946','88436','96851','98888','38235',
                          '67970','95429','11266','22056','84821',
                          '29382','72447','86232','94607','85812',
                          '16724','18871','92662','24455','42038',
                          '37590','70916','80155','88637','98988',
                          '53737','51102','95905','31356','11656',
                          '92952','55094','14203','35896','70851',
                          '29848','56078','58849','50233','40490',
                          '41666','20858','45479','39721','35629',
                          '65672','44241','94685','15972','88286',
                          '86544','57645','60723','41997','35732',
                          '61853','99004','29844','69349','69585',
                          '17952','93807','88934','86839')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

