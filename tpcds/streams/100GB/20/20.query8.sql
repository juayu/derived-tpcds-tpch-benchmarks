-- start query 8 in stream 20 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '27455','73368','23731','62593','40020','49950',
                          '54278','84241','24245','95097','70349',
                          '88299','76003','69953','70353','74358',
                          '84852','41490','63577','34510','72000',
                          '74975','69843','19445','51238','56355',
                          '38225','54713','32757','29563','76823',
                          '38839','21691','26961','15995','52508',
                          '41757','50903','23942','86335','90849',
                          '45619','42177','22768','32200','43367',
                          '12646','13814','12180','48406','35835',
                          '18902','97396','97299','20231','28196',
                          '24548','90059','83782','36503','77830',
                          '48806','22522','57619','76163','75460',
                          '34997','49202','90884','65305','99512',
                          '26166','48372','30192','61328','37710',
                          '16193','32931','10857','50563','76768',
                          '27907','82482','28581','72115','62232',
                          '67640','49247','55619','21772','57603',
                          '80198','62300','30222','56729','40613',
                          '90880','68395','96221','82846','18074',
                          '63012','42880','94524','45470','25047',
                          '45768','57364','27444','67191','17656',
                          '75574','49036','37363','25194','24680',
                          '76110','35893','39259','74437','72809',
                          '29422','86192','47200','32781','67855',
                          '92674','73840','72286','93223','58352',
                          '16060','20896','25935','94498','37714',
                          '14114','55276','11585','13513','31495',
                          '19394','30663','66148','63179','61329',
                          '55981','98605','64113','82406','46810',
                          '31435','56898','90657','68438','47877',
                          '73547','52207','88639','35525','53212',
                          '52244','18207','64851','56747','37915',
                          '52087','87103','11610','40661','31437',
                          '34773','80584','97571','71091','50279',
                          '45028','58533','66409','90451','12413',
                          '13189','87942','32251','62659','92825',
                          '83688','78093','98711','98631','97551',
                          '10812','82369','68894','90529','10434',
                          '28762','82017','64386','25259','60014',
                          '69531','13186','77460','89907','33059',
                          '98333','81099','67526','90221','50711',
                          '85519','87941','73103','17601','22473',
                          '57441','61660','79694','68333','48992',
                          '60117','65402','46890','18850','76666',
                          '59375','52822','62554','30130','48440',
                          '22912','24481','47105','11341','53011',
                          '91238','77879','53864','67200','52515',
                          '76353','92666','36499','99601','88374',
                          '65662','82891','37945','54298','67741',
                          '15452','71975','20207','69083','20689',
                          '21685','11892','84481','23351','82254',
                          '90445','86701','52706','40568','41450',
                          '65244','52542','20909','34075','84473',
                          '15900','62319','54645','96616','56033',
                          '82068','57452','84756','37225','77626',
                          '64001','19807','55495','33935','89578',
                          '39585','51616','36281','53441','47182',
                          '90956','35482','87879','33558','96459',
                          '41771','46084','17033','58733','38523',
                          '97659','58693','88400','63520','62381',
                          '62665','42790','62482','30479','59882',
                          '13907','93209','39691','93010','38370',
                          '29959','68097','24305','43478','50331',
                          '59587','30092','83407','96562','17634',
                          '82743','21009','17162','59396','19324',
                          '69700','65323','76999','69633','98702',
                          '74093','80830','47850','21762','61845',
                          '50352','99877','89428','32861','59499',
                          '21094','76207','46241','50594','22389',
                          '91047','46651','22586','66178','84420',
                          '72651','96875','87815','10837','92246',
                          '82448','55875','62217','97517','89335',
                          '56853','11018','86400','68207','76502',
                          '53048','38842','15024','71292','54120',
                          '79454','74910','12320','33451','77868',
                          '54056','54704','16414','64137','62993',
                          '36483','85312','54238','70093','47681',
                          '80982','85306','45618','52537','36447',
                          '94129','23473','37751','90785')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

