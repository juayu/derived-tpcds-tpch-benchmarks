-- start query 8 in stream 20 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '49883','63063','24597','41305','93270','91108',
                          '10276','58327','50626','79653','86590',
                          '75315','16778','63282','22338','33517',
                          '69086','21683','24140','16702','12181',
                          '15918','61818','32487','59867','50968',
                          '72686','59469','76232','89795','74104',
                          '82776','30989','33902','37772','72956',
                          '28385','57671','18260','46724','57134',
                          '93078','12396','97188','59311','21849',
                          '71972','35840','27758','77456','46657',
                          '27647','36076','83905','41723','95151',
                          '53510','89727','66431','94131','89196',
                          '47325','74224','25815','56318','39752',
                          '91552','31226','87968','21009','64423',
                          '55228','12429','70091','54221','72895',
                          '27293','13272','68929','24754','43071',
                          '59266','72735','62544','60223','30968',
                          '92783','30964','37257','73436','46409',
                          '28059','34999','16906','66334','89261',
                          '12529','19123','33264','87457','57031',
                          '35096','14426','35380','17051','77642',
                          '98936','60690','17693','16399','37082',
                          '41700','13525','74403','75028','65917',
                          '74126','84472','79625','94111','21645',
                          '21437','44333','68620','10813','59971',
                          '19842','76757','35934','88901','88588',
                          '11421','72851','48458','20355','69098',
                          '68341','42817','92643','95956','51907',
                          '84350','56611','97184','30514','20063',
                          '71475','14215','37493','43004','41067',
                          '45935','42521','82326','54003','30024',
                          '66531','16254','19142','17689','80512',
                          '40453','52559','72368','79962','92057',
                          '26484','30061','31844','17970','23705',
                          '39473','87533','20689','35001','10424',
                          '81145','34193','40618','13147','62407',
                          '58367','72198','82001','76324','20567',
                          '87567','46574','52348','76223','98851',
                          '57758','96789','42042','26430','52099',
                          '79609','62458','52373','63935','76846',
                          '14185','46978','93328','34285','36562',
                          '40009','17387','51183','99833','93114',
                          '75270','78718','87869','64025','56437',
                          '79068','12942','26716','34130','75311',
                          '84835','68164','50876','44880','85260',
                          '30076','13788','57369','86169','87493',
                          '75817','88785','22640','44666','46206',
                          '70018','28962','85893','35563','53212',
                          '39161','45334','79789','11337','34584',
                          '75839','38402','80179','64500','87547',
                          '30979','59809','55205','59103','53612',
                          '83817','13711','22297','96448','38191',
                          '78477','48168','73986','45034','78736',
                          '78345','11523','80685','83137','94130',
                          '18861','97784','79833','12739','86292',
                          '37640','35161','46471','20169','59079',
                          '77239','31950','19583','53966','23835',
                          '76325','34491','10883','49951','52349',
                          '65978','53810','54067','59506','28168',
                          '16509','15293','74119','37291','79643',
                          '37045','39617','98536','63705','72541',
                          '95993','44089','35395','72562','81280',
                          '48933','94980','47487','63220','92698',
                          '80085','56584','47874','24722','57840',
                          '90720','84394','56242','43565','93340',
                          '72308','41719','51219','39789','16404',
                          '59900','79329','35423','62129','27155',
                          '94372','54387','80843','44839','95144',
                          '65538','48357','23969','96786','58596',
                          '39295','76319','87369','18513','67470',
                          '42327','15557','76088','28054','27265',
                          '91190','40376','58080','34422','62698',
                          '87293','28985','34472','96515','22122',
                          '91270','76942','40069','46372','20789',
                          '92842','68625','25338','31158','69866',
                          '80693','96569','64614','85364','53573',
                          '41510','49025','81598','39395','56494',
                          '79523','36234','66890','80251','80330',
                          '58642','53196','37056','87609','66303',
                          '46247','90096','27959','27362')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

