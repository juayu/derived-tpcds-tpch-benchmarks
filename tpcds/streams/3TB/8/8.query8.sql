-- start query 8 in stream 8 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '16741','35023','52682','98265','25374','10344',
                          '73696','51315','30540','20084','88563',
                          '75959','37101','24270','85096','80707',
                          '56000','42161','17612','39321','62977',
                          '59182','80328','29575','27274','27159',
                          '79049','42724','65129','34832','64839',
                          '38383','69430','47571','93185','70086',
                          '30887','81645','48581','25322','96402',
                          '92347','12515','21241','53559','98852',
                          '99976','24694','39329','25579','53719',
                          '61318','67926','49587','16352','21666',
                          '81447','61777','56109','49558','32866',
                          '61970','31318','13504','76753','54153',
                          '66632','78025','65473','94487','12326',
                          '47347','95276','52805','21437','39533',
                          '16663','46920','76139','87855','61323',
                          '56598','29030','95158','31572','31924',
                          '97476','44240','18188','12187','44806',
                          '45420','68000','50534','22416','10701',
                          '89833','33381','16378','47640','36601',
                          '31040','20894','68577','35858','17625',
                          '66846','22185','79711','52067','86291',
                          '33663','48529','76412','19447','27558',
                          '27458','53967','97583','11313','63068',
                          '73199','74137','31106','37950','64250',
                          '21391','63906','35106','14621','32458',
                          '40049','16679','97640','78168','14841',
                          '33310','95951','58698','54059','72120',
                          '94311','72280','88455','28397','30886',
                          '28439','79940','78854','98063','69677',
                          '19759','23461','20333','65759','54594',
                          '20630','23919','54919','89850','85299',
                          '66397','34390','39674','69739','73860',
                          '86990','45944','95656','58595','66605',
                          '49977','85189','69485','24097','75299',
                          '19610','29958','27828','13687','25399',
                          '59009','12426','48145','77354','21333',
                          '40822','17798','93060','63660','33069',
                          '58596','83034','42373','33615','44065',
                          '98718','94490','91057','69353','19024',
                          '48276','10419','93893','64895','90533',
                          '14837','95714','11636','21961','28023',
                          '59197','44174','29214','88643','60289',
                          '95663','35479','76638','54306','18922',
                          '58696','97464','31247','47282','68245',
                          '44728','68852','55093','42479','32792',
                          '37187','49806','84298','52711','25034',
                          '59142','78768','82158','13280','18165',
                          '53500','45334','13883','94073','91602',
                          '73841','33778','61951','83014','14644',
                          '81197','40164','35894','24343','59298',
                          '63400','20653','99273','29849','44217',
                          '16308','20012','57796','32482','47704',
                          '85210','81340','79811','62332','34378',
                          '85399','84811','80558','96680','28258',
                          '40202','96946','54001','92047','70413',
                          '14952','42342','80914','25753','94467',
                          '35809','10573','51288','81777','82818',
                          '24229','51771','15255','78814','62124',
                          '71917','22925','77081','96188','45227',
                          '58529','42012','84879','36139','17576',
                          '22480','20603','57430','44187','23336',
                          '58259','22767','40683','37018','36061',
                          '91929','92629','41468','99008','91741',
                          '92623','38511','83530','17779','25421',
                          '25899','62819','88680','83482','87480',
                          '56836','54861','36924','68208','37923',
                          '40381','60358','70674','44883','38509',
                          '16473','46805','26149','18753','69173',
                          '94782','57312','36905','28082','74696',
                          '83917','41705','25639','78239','91815',
                          '84364','17449','15176','77850','83693',
                          '89022','38896','69769','25289','99100',
                          '34479','61109','65560','81767','54273',
                          '51873','86201','54680','20459','59675',
                          '65858','71768','83550','31949','46636',
                          '80415','35459','89900','81095','79692',
                          '70035','12719','26996','87360','25803',
                          '18473','88167','60081','37218','44389',
                          '79687','19221','80977','52740')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

