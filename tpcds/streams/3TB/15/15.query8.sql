-- start query 8 in stream 15 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '43951','72775','72173','62734','70689','72199',
                          '14592','47951','30450','79659','40485',
                          '98272','91074','68130','15351','49695',
                          '88902','37354','64558','77533','95746',
                          '97838','93129','56487','80018','48181',
                          '52245','59514','15937','31767','91453',
                          '28907','84671','38654','91989','31741',
                          '71012','43361','35805','68010','76296',
                          '16272','40425','92318','53569','37016',
                          '30219','18291','23128','54202','75235',
                          '84409','39143','73100','60470','97006',
                          '83080','85825','20091','26736','51271',
                          '91260','58411','66924','46508','57826',
                          '28590','30885','11193','39828','20848',
                          '39660','31371','55062','60187','21082',
                          '24536','76920','57682','40979','49314',
                          '51864','35173','97969','94373','66690',
                          '82849','22206','23946','23589','87269',
                          '24034','81697','59960','70201','64886',
                          '64141','80104','28516','22956','89031',
                          '91098','24546','75434','21021','20959',
                          '65323','18627','39455','14528','34521',
                          '79353','30261','27416','71644','82776',
                          '96135','80534','68265','23454','23980',
                          '87777','58380','87029','38037','61516',
                          '98152','35458','65479','33049','13831',
                          '63788','41148','26360','57197','74075',
                          '90224','79640','27292','10187','50382',
                          '63314','28695','46813','63997','57829',
                          '32267','81433','27208','17116','23873',
                          '10551','19077','35892','35685','74018',
                          '68765','64027','28500','44583','37893',
                          '20984','19502','56034','50164','90527',
                          '34397','54452','63611','28547','11238',
                          '35784','94365','10660','77946','36621',
                          '35431','25966','99638','76945','48592',
                          '50907','61500','76069','15694','44484',
                          '95163','44446','41062','83532','40267',
                          '53211','87426','29670','85024','77899',
                          '17025','48828','80808','62921','63047',
                          '77750','90907','43968','12740','15412',
                          '93092','99343','74448','63056','98848',
                          '13202','22345','45404','47466','66537',
                          '66085','27523','21781','56755','58002',
                          '31159','85702','34817','52902','81425',
                          '80465','98845','77114','65599','38085',
                          '18473','58071','24159','93904','63706',
                          '32710','90458','73631','89307','94652',
                          '39654','28212','40894','57095','16588',
                          '51474','43856','82069','93785','71739',
                          '90186','64383','27023','41609','69566',
                          '76039','83565','58527','51375','54808',
                          '37348','54337','66811','88656','59882',
                          '60444','87611','20249','51765','84767',
                          '87117','84432','62986','22644','15910',
                          '95108','59330','37388','88311','41779',
                          '61834','59516','58190','98326','33638',
                          '58284','89622','91783','39121','39853',
                          '84281','86736','81872','75770','12100',
                          '85812','55553','69459','80542','90785',
                          '68228','65397','64928','58072','53975',
                          '34733','10734','93619','97082','79919',
                          '30132','65444','78886','10454','81280',
                          '26114','25135','15329','90385','80978',
                          '75881','13417','81176','67526','86628',
                          '31229','37534','48457','35865','17691',
                          '29496','71306','33154','11125','80250',
                          '88775','65169','83926','54386','28712',
                          '26264','60982','99965','42229','20309',
                          '32209','73490','17284','27630','80854',
                          '86877','30119','32626','72418','74420',
                          '50524','51278','81506','57118','84077',
                          '32250','65771','22627','58207','43570',
                          '70784','23202','18985','32170','70808',
                          '21978','67484','15038','24832','46619',
                          '84669','26238','76696','21840','34696',
                          '41771','98820','92227','81993','29835',
                          '26842','22352','29305','64799','24662',
                          '31888','33426','55173','73869','29075',
                          '37350','39873','64701','75426')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

