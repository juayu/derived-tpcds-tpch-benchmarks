-- start query 8 in stream 1 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '75703','87893','10263','14545','35826','95436',
                          '27193','92182','45429','25664','21909',
                          '79028','82771','78416','56855','63988',
                          '12219','74799','67979','29174','15245',
                          '59667','61904','71563','16316','73470',
                          '42668','49525','84970','38173','50716',
                          '45735','26709','95316','49325','96445',
                          '64524','30357','18161','68047','55072',
                          '13334','20230','29000','93543','45511',
                          '78491','41105','85547','62384','67015',
                          '13210','78407','62995','55556','54551',
                          '72215','76317','21876','47454','24557',
                          '37483','88029','76648','39406','86436',
                          '95873','51258','53773','93541','72000',
                          '78431','26149','88978','17477','45730',
                          '54839','26248','50642','78533','98000',
                          '82420','23081','29050','34513','17720',
                          '64525','60190','66990','75773','67610',
                          '75928','88849','37515','40536','18975',
                          '82222','26039','40561','59646','72337',
                          '95619','63303','86682','92577','92114',
                          '71409','70304','21879','14736','22894',
                          '58993','50527','48708','57798','92525',
                          '67135','85856','23161','95785','32976',
                          '99936','22880','65016','48510','63368',
                          '28425','58048','18372','10680','35645',
                          '39641','34371','80034','14254','82768',
                          '81349','60174','98032','27889','43903',
                          '55826','16593','51627','62815','29092',
                          '50545','22117','82886','43032','60501',
                          '31515','77900','16692','51746','73320',
                          '79638','38004','95340','87321','21207',
                          '91124','36467','34010','75389','17734',
                          '51622','68458','29860','21079','56591',
                          '15742','72732','42110','20047','83779',
                          '89489','62142','32017','32527','48906',
                          '91251','67696','39323','36043','70105',
                          '72232','73535','70166','11584','33078',
                          '14400','91621','19949','34896','82952',
                          '75481','96704','79958','44212','36005',
                          '51532','48006','64471','12212','17903',
                          '23819','98393','59245','10695','51230',
                          '90470','78647','72423','36468','52147',
                          '37239','50201','24201','28077','73218',
                          '35623','40152','48147','61324','31152',
                          '94596','59473','29121','47189','39867',
                          '85760','71070','65164','62376','15826',
                          '36440','21133','79020','28981','84869',
                          '49509','81019','52578','39655','29697',
                          '52490','16311','82240','96226','90048',
                          '17623','16244','32489','64635','46106',
                          '28381','98852','65089','94252','99061',
                          '47936','39303','55999','50492','97563',
                          '74792','78151','68306','71121','84409',
                          '90966','44765','27626','93674','36011',
                          '52387','58412','13356','71469','96660',
                          '48769','78591','26267','60956','62841',
                          '67187','57918','15343','44730','55184',
                          '47253','10679','85185','55004','67366',
                          '39015','91469','93692','99846','88527',
                          '30143','36118','62211','18283','61081',
                          '33419','37141','95398','96724','77168',
                          '18842','36337','98070','36604','15722',
                          '82400','45164','52014','54218','43017',
                          '38195','86221','34990','99236','51500',
                          '96381','43387','37909','42681','77195',
                          '98818','86345','26565','59170','66595',
                          '63600','20780','83862','17617','69147',
                          '86796','57482','42138','21872','83033',
                          '54547','97813','42284','19286','99415',
                          '55751','52529','76421','34967','69936',
                          '92118','10402','22820','42840','53674',
                          '87266','19344','90140','21267','78061',
                          '41733','38039','56196','17764','39240',
                          '89848','76030','72265','33054','43966',
                          '26092','84395','12293','42345','62373',
                          '69530','73143','60865','61624','58413',
                          '77998','28484','11641','82226','72816',
                          '70072','94636','96147','63528','87412',
                          '91536','86713','18043','89916')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

