-- start query 8 in stream 2 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '96145','63448','81904','16532','56049','64297',
                          '30328','69932','38500','12883','29564',
                          '59649','42830','46035','46849','12063',
                          '12025','49651','12197','24494','69303',
                          '89904','45506','29483','60940','98014',
                          '78271','53879','56856','65760','71901',
                          '65226','13004','10481','83780','67629',
                          '56297','61802','64350','61314','48854',
                          '38252','42082','41677','47531','62790',
                          '85731','56642','67713','54924','24901',
                          '89757','36707','59173','54805','47786',
                          '70250','61226','76695','18915','98589',
                          '94349','57936','39028','75676','96191',
                          '10911','36258','78367','91348','63652',
                          '78537','21417','60506','78312','30207',
                          '19088','79159','27900','53580','34961',
                          '60716','39484','70011','69094','51058',
                          '85264','43195','96150','25198','58275',
                          '68064','74621','16413','61346','61263',
                          '99899','65367','49266','47525','27206',
                          '56753','58241','66307','45887','74594',
                          '71267','39131','36008','59681','76342',
                          '55746','60088','91332','77321','15011',
                          '64061','24175','96202','77297','78815',
                          '20312','87036','98591','79311','29404',
                          '38728','61159','45907','31788','26751',
                          '82489','65562','27383','19452','58861',
                          '27124','38994','90473','72740','18967',
                          '27598','38310','39754','42844','29914',
                          '98518','35669','40116','26748','10095',
                          '41244','72191','33215','26394','17354',
                          '69894','62984','67457','33704','63017',
                          '84050','90410','96543','63264','61801',
                          '30412','76182','97404','54550','76084',
                          '69743','13343','99377','51834','47072',
                          '89198','68828','34651','21322','12545',
                          '44853','70789','53749','41271','33612',
                          '67761','84043','30058','71837','46654',
                          '83554','68813','45066','59463','58747',
                          '79843','67151','54720','55879','14377',
                          '13681','43375','65342','76415','61795',
                          '75797','87384','59942','28067','87955',
                          '31721','93860','23155','42367','61584',
                          '83561','50801','63728','99742','89439',
                          '14760','44162','40875','89407','61461',
                          '25278','56551','33743','92021','10413',
                          '36607','25756','92957','61830','64928',
                          '91949','66512','76226','48123','61018',
                          '60545','63138','10932','73509','17503',
                          '28381','11033','43283','53383','43860',
                          '81132','63710','36471','37096','72818',
                          '20463','24002','61641','96087','42927',
                          '30105','68252','76165','87802','23443',
                          '10547','38187','61357','68534','45954',
                          '32039','20124','20737','55744','47962',
                          '62257','37715','36684','29967','43084',
                          '66384','50176','57617','73178','34024',
                          '28765','74115','12393','10782','65133',
                          '72853','57574','19457','64420','61581',
                          '10666','74552','30002','41096','78077',
                          '93729','58472','17286','23655','41039',
                          '23245','14699','44896','59666','58306',
                          '43242','70251','90116','32396','76720',
                          '18183','76608','79543','45549','57480',
                          '70422','25644','28962','81049','91324',
                          '13440','27645','28051','66425','47476',
                          '92190','27327','48179','87811','27084',
                          '54481','96694','25648','22974','40689',
                          '47771','97964','60269','63571','40580',
                          '30728','84619','98782','48000','49090',
                          '70394','22407','22772','65351','25028',
                          '64785','84949','56869','56189','97036',
                          '60110','90376','76488','90274','96849',
                          '99760','69403','71252','22263','71659',
                          '51565','57927','10229','23869','26087',
                          '81922','24353','55509','90571','65859',
                          '30391','74317','89740','89643','49688',
                          '96369','63799','15269','47942','51626',
                          '53672','85675','32725','46515','51149',
                          '72627','76247','47247','44079')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

