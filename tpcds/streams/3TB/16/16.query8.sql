-- start query 8 in stream 16 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '15631','86522','76945','16185','93511','88837',
                          '46073','20897','71423','31604','94128',
                          '15765','44798','54326','19835','14082',
                          '48862','34328','39843','28384','23035',
                          '91850','88017','47852','70689','17554',
                          '92207','41016','75728','74294','97563',
                          '70482','92482','10195','59089','77530',
                          '39896','62492','66318','19487','28936',
                          '57232','37213','31854','19839','88675',
                          '65056','90966','94256','53822','70636',
                          '60686','28583','48167','78346','64148',
                          '83928','73910','44004','27070','59696',
                          '33467','31475','90596','83184','33599',
                          '68662','51455','12848','98799','12279',
                          '69938','42828','99959','20525','36304',
                          '85288','74212','17629','99904','39314',
                          '22481','51031','12541','89357','51833',
                          '34750','18859','23698','27916','17266',
                          '88303','12219','47044','39245','78247',
                          '11159','98383','51788','31039','76231',
                          '97985','20266','78087','62468','93420',
                          '68947','16092','17567','33126','95541',
                          '14443','38779','77921','69189','47994',
                          '37755','31853','18496','35035','94336',
                          '67098','26948','42504','87923','15870',
                          '31121','18386','98555','13845','60867',
                          '35818','52691','99559','31560','48249',
                          '33354','91833','19302','99569','49819',
                          '35295','54179','36149','42257','89581',
                          '27774','59108','12386','52194','34563',
                          '27222','68414','79962','57454','25080',
                          '22263','98633','76623','64513','72026',
                          '69487','39337','85265','31318','53936',
                          '81942','91283','88736','34156','92006',
                          '50545','60031','89552','28617','16270',
                          '51612','49213','48799','64662','85361',
                          '94674','54006','25058','89829','82960',
                          '27876','26591','69775','43035','94909',
                          '52482','76968','71287','32617','68688',
                          '66619','88269','51115','31035','32035',
                          '37430','42049','53450','61938','97018',
                          '62103','25462','41258','64625','97613',
                          '62438','29008','54700','33816','69673',
                          '79866','81472','19099','74260','56334',
                          '90965','26421','30378','55635','52344',
                          '73452','87767','15438','24911','45280',
                          '92047','75891','28223','48917','77498',
                          '47829','46548','99836','73629','90192',
                          '56533','88702','93073','40499','92113',
                          '86830','53776','13493','83595','19281',
                          '27383','59650','13696','79388','26397',
                          '98759','82412','67606','84297','32055',
                          '22603','85149','99310','42195','21027',
                          '94912','53201','33453','95958','58937',
                          '30362','28717','59517','23247','84687',
                          '32500','29814','46536','97255','91407',
                          '41304','23466','17717','38647','39946',
                          '53616','75146','79400','77839','60564',
                          '98377','32633','24364','53486','45733',
                          '82613','78885','51586','28620','59848',
                          '29956','24264','84197','36493','30941',
                          '68876','59025','45184','17604','23202',
                          '54357','11348','19422','59138','29772',
                          '46740','78556','44911','13909','58609',
                          '12157','77188','93879','61494','75105',
                          '62644','36645','28982','30442','94643',
                          '33241','83001','12829','99803','50406',
                          '13104','67683','77827','32722','71269',
                          '49441','66013','78724','51316','54375',
                          '94259','77775','71809','35646','25153',
                          '30091','39091','67146','32670','58743',
                          '17096','78439','84686','10182','76093',
                          '46525','64485','44214','63189','25233',
                          '76521','88000','97136','24399','81338',
                          '76104','78996','58082','36361','41337',
                          '99529','69479','73748','80085','77661',
                          '98400','11196','97452','35346','84755',
                          '21178','35869','73318','19961','45332',
                          '99998','61952','77995','19413','30251',
                          '27102','67530','55164','37565')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

