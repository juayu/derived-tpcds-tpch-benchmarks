-- start query 8 in stream 3 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '37971','18298','95814','25889','16648','84816',
                          '25291','35146','84332','70358','26757',
                          '16503','49527','46441','40269','67776',
                          '64175','28193','22274','79211','33186',
                          '20887','20926','19064','15383','30027',
                          '87690','49659','44464','86068','26229',
                          '12362','82159','86498','28991','79315',
                          '10060','30291','21391','13149','75430',
                          '47268','56294','90083','75209','36935',
                          '67936','71216','69144','32146','71033',
                          '84229','41521','66931','29746','29268',
                          '29455','75496','56123','74317','43435',
                          '88567','82518','56354','82535','14154',
                          '94492','31811','21723','21250','90619',
                          '31062','10161','99079','62866','23315',
                          '85011','81507','69629','15633','70035',
                          '66848','56116','10925','30709','77882',
                          '53967','29615','55772','61369','43770',
                          '20464','28950','45311','29323','54357',
                          '13025','62570','28471','46713','81121',
                          '22669','97572','37331','69335','52537',
                          '82358','99598','22466','40186','84938',
                          '13392','33442','21321','48364','98194',
                          '46556','98126','35972','30068','21449',
                          '76811','85976','29193','99752','74053',
                          '27340','24627','80206','63992','49164',
                          '70985','67836','34417','29378','49179',
                          '51402','45421','68209','63394','20487',
                          '40049','76738','51423','71257','20243',
                          '90708','27264','75852','21673','42003',
                          '21101','67355','88816','98597','73991',
                          '59631','49056','63544','83760','38749',
                          '66634','12824','88446','33397','58951',
                          '63707','15718','31570','22988','64306',
                          '99235','43362','37110','13804','25610',
                          '89559','87204','66004','13681','45908',
                          '71274','97289','55383','19671','66604',
                          '68236','74585','50517','64916','26798',
                          '99054','69687','67473','83145','62317',
                          '38455','11265','89417','67407','18520',
                          '93123','75750','68108','26525','58999',
                          '93654','67377','44707','69075','86166',
                          '10547','20366','87532','34826','21291',
                          '67809','21577','15140','10871','78113',
                          '23115','85260','45643','62181','91648',
                          '99371','88958','26571','34397','12131',
                          '62159','45321','18403','31670','25324',
                          '74018','86860','90572','35834','67701',
                          '15841','81722','70052','74982','88686',
                          '45721','87636','52391','56372','59903',
                          '28528','65207','92292','15993','67581',
                          '42688','79922','27578','16555','28108',
                          '67026','11620','48128','72158','28970',
                          '67249','11469','43012','78142','58648',
                          '49379','33406','41326','18148','15946',
                          '51644','40172','36901','22268','27088',
                          '65785','24108','85774','58081','23109',
                          '57594','76081','49101','65569','12354',
                          '80133','43467','72902','78521','93141',
                          '74385','87189','22699','83256','40845',
                          '55520','70329','88015','74927','85554',
                          '41723','55421','48311','97337','44963',
                          '20549','20033','86420','55675','64073',
                          '37838','58538','98273','96081','50426',
                          '36782','42654','92571','96952','73037',
                          '91406','79512','56408','96753','99399',
                          '92322','27903','70707','97751','99647',
                          '39589','43107','90187','34708','74821',
                          '40080','44055','18264','92623','60060',
                          '13802','65255','10717','31474','53678',
                          '46838','23822','27576','25397','68476',
                          '23977','59442','83755','57443','63994',
                          '19687','39332','53274','66123','13861',
                          '33004','21253','68505','90218','34545',
                          '71348','15560','50181','23019','67964',
                          '23135','52529','54361','57372','52223',
                          '70757','67226','15241','38420','98388',
                          '84303','24680','37060','62625','47505',
                          '87835','77300','75074','32550','21977',
                          '48012','53552','87879','83903')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

