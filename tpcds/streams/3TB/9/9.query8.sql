-- start query 8 in stream 9 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '23799','25648','25723','78083','81845','41228',
                          '26688','37462','90998','70855','73659',
                          '86843','63812','61479','60081','34304',
                          '27247','30120','83564','61592','54113',
                          '25646','46952','48789','56349','97223',
                          '81168','34742','47161','24208','96129',
                          '99071','60913','35808','63263','15092',
                          '15815','16256','82958','51940','27375',
                          '12081','52613','60891','30196','58625',
                          '93481','46456','47767','20865','40892',
                          '59097','24144','83674','45892','78925',
                          '36402','55875','84663','85686','44291',
                          '72264','95215','20565','76520','57449',
                          '78474','41646','94400','28079','79773',
                          '78562','17336','47527','37483','47843',
                          '28990','57683','42459','12211','30004',
                          '69800','36985','59821','87986','40954',
                          '22801','97642','83090','87940','66120',
                          '26850','58417','33669','38536','90862',
                          '31152','44651','38978','30072','99084',
                          '17065','56774','50938','25312','21641',
                          '69656','75115','31949','46475','42256',
                          '48254','55428','34592','78899','20176',
                          '65200','47145','27569','34765','63725',
                          '86682','49334','96105','53209','37499',
                          '61337','17091','63825','11671','33500',
                          '66259','93498','17089','46779','78141',
                          '82118','35430','21921','52286','84475',
                          '26275','29455','82644','28336','47361',
                          '80411','35287','82212','18295','51379',
                          '38278','85770','17630','75160','63960',
                          '98102','20321','75506','90451','53532',
                          '52252','78608','57048','51192','80762',
                          '13587','84580','44429','61065','46226',
                          '56894','70478','39810','47409','61922',
                          '45040','94280','83337','84034','35046',
                          '92098','12927','77420','53690','24644',
                          '71596','98487','33270','72782','33231',
                          '29404','53741','41706','95534','55558',
                          '86543','51594','77593','12549','62750',
                          '13018','85071','14741','19414','18480',
                          '24404','28294','43194','12375','27026',
                          '93855','58955','14798','84825','47203',
                          '36411','42952','20873','86296','69736',
                          '65731','19120','64460','89633','86675',
                          '23865','78432','26769','61709','63803',
                          '20258','91452','56797','28355','58419',
                          '64980','40603','41758','80953','14079',
                          '12880','37589','60494','95544','78700',
                          '44703','18127','96211','43886','24375',
                          '74225','69314','81090','63741','12725',
                          '51196','51409','83384','64504','53085',
                          '87110','15405','60783','43160','14021',
                          '58981','93277','59752','98443','25895',
                          '41732','11565','45650','57257','84895',
                          '42036','80145','59375','85314','29778',
                          '63356','85177','81206','32663','26191',
                          '69229','23516','34021','79044','44607',
                          '31575','26223','80649','66053','29834',
                          '53108','46400','36684','37861','54298',
                          '12178','96968','60415','58691','96047',
                          '31543','68755','91433','86989','69753',
                          '85170','29366','74454','34688','16249',
                          '57701','94313','74630','67706','30141',
                          '35312','49509','32707','94045','40618',
                          '38824','79623','25841','46279','94160',
                          '49295','67781','73883','23480','40127',
                          '49057','34488','36067','41873','12210',
                          '32261','65610','11211','74487','52427',
                          '69915','30219','79663','90675','91731',
                          '44251','13667','33587','91429','45323',
                          '26351','38668','57814','35557','14405',
                          '15051','46825','59675','39573','16542',
                          '67082','26750','85150','68707','83978',
                          '32316','68329','42573','32351','15478',
                          '94927','39135','53608','16028','24275',
                          '45750','77380','58805','69295','53949',
                          '68249','43239','95362','52031','92503',
                          '84754','47639','67602','14786','44697',
                          '15061','31500','44875','93216')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

