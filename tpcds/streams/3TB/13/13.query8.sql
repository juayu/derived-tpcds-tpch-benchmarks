-- start query 8 in stream 13 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '31537','75024','77634','19796','95117','79964',
                          '31153','39864','29162','88071','25329',
                          '46475','16209','91667','95439','13609',
                          '75314','40484','28505','40003','50914',
                          '25229','49932','74122','38442','97266',
                          '46052','84245','70751','35083','62863',
                          '26299','18717','41808','27385','94639',
                          '59536','34789','11259','24179','70185',
                          '76389','68614','76501','77624','81138',
                          '91210','47024','60171','74937','83419',
                          '86018','21989','32460','39271','77190',
                          '95919','28511','65137','75858','36866',
                          '41043','98966','93709','57493','47345',
                          '36107','83862','60602','26922','40927',
                          '76519','86985','93942','37017','87145',
                          '14029','31494','57966','39153','44497',
                          '59708','62245','27149','63994','99502',
                          '52702','98983','64482','64171','26029',
                          '89101','43961','91856','25307','45791',
                          '25854','66156','47137','97601','89103',
                          '76979','96149','48675','99870','28464',
                          '88739','97744','30285','90273','26542',
                          '73077','14601','13152','44584','24209',
                          '64324','85236','23467','63037','81488',
                          '50947','85234','16566','29595','76311',
                          '85696','88003','90875','55568','81782',
                          '15277','73743','28366','39399','51210',
                          '76580','93381','37829','71166','84223',
                          '20360','76268','14838','18019','97172',
                          '36339','22925','27458','34679','91248',
                          '33638','96590','47458','13342','71725',
                          '64944','57074','77318','39316','97063',
                          '86488','22416','25427','60013','90303',
                          '51965','57392','13570','98623','62660',
                          '25973','80168','71509','50677','70973',
                          '14574','51152','32303','48286','58761',
                          '82785','13804','46658','89732','90383',
                          '86692','42349','62987','96862','70016',
                          '44009','62387','81612','96088','86717',
                          '49178','65064','61675','46413','55525',
                          '92594','20332','81861','14174','64032',
                          '41398','10839','44622','94898','31329',
                          '51319','57286','59919','70908','19186',
                          '62371','94743','62229','49134','51335',
                          '16637','95326','16214','22452','29290',
                          '76613','44065','78729','24572','91546',
                          '27065','21201','79664','55038','90648',
                          '66672','93855','70966','82837','50369',
                          '73227','23600','14469','52217','55357',
                          '35391','84993','39815','88906','12322',
                          '50742','57579','53409','89258','89267',
                          '34021','45127','28439','73900','88835',
                          '15087','53868','85547','77813','72859',
                          '95191','35501','19519','44110','29475',
                          '15452','90760','52053','68962','39560',
                          '93436','23530','34771','66440','37122',
                          '37056','69181','57984','23945','37043',
                          '22393','51957','65020','25412','52454',
                          '93028','33784','50776','56070','15031',
                          '82796','64042','10342','78624','21691',
                          '18131','10990','14392','78072','66259',
                          '24942','14387','92771','54207','13314',
                          '19014','60792','99585','24057','55981',
                          '67483','93640','89164','41091','73136',
                          '78984','73493','48583','99913','44962',
                          '72734','94398','38157','95138','30299',
                          '88120','21807','13216','32918','81326',
                          '18614','49482','18352','63614','55338',
                          '45293','50566','38248','43398','56533',
                          '52747','87854','26354','90297','46757',
                          '28516','30101','10157','73081','99942',
                          '26052','82590','32954','91757','62362',
                          '25248','68755','92067','71870','54173',
                          '67916','29252','31735','13074','78441',
                          '32759','71741','53749','88432','26534',
                          '53891','63615','13116','90217','33614',
                          '53780','86544','18599','19101','10218',
                          '83476','91042','38737','35858','49339',
                          '50270','91142','52125','79373','27716',
                          '45795','37619','36824','93939')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

