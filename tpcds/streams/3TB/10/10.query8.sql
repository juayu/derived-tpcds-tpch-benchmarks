-- start query 8 in stream 10 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '52195','88599','80028','24412','32114','30377',
                          '37578','21089','16142','22756','70438',
                          '46720','99246','85374','90894','17660',
                          '74185','11917','73652','27211','76203',
                          '58138','76880','80822','91265','41596',
                          '84305','89997','85942','10834','44123',
                          '94475','94816','79597','65474','71618',
                          '79920','56273','94208','79758','77661',
                          '92739','22723','83727','91902','43626',
                          '82653','73056','98675','11028','47169',
                          '74098','68990','16074','24524','99894',
                          '51225','19234','26567','92927','30603',
                          '76017','39461','70964','19552','37765',
                          '74641','85094','68612','38797','84782',
                          '27159','60974','54092','97883','55745',
                          '52900','70677','19166','72456','98109',
                          '35907','71588','16284','85785','70099',
                          '47885','40610','61182','66956','84998',
                          '70592','15688','45444','67043','85026',
                          '71122','80975','12222','56505','69641',
                          '20163','48975','87290','58212','57651',
                          '14812','67637','43896','89841','55775',
                          '98145','47028','46136','46717','18300',
                          '89807','48394','15706','78787','74670',
                          '54082','58426','60319','49329','45629',
                          '62440','66183','57912','46911','63269',
                          '96630','84598','10069','70413','24843',
                          '23832','38926','42760','77047','10744',
                          '68189','96753','23918','54793','60880',
                          '28460','78066','17808','31195','40790',
                          '60129','14186','67825','50707','30794',
                          '27069','49132','92062','47445','67266',
                          '76444','92284','64792','75238','89698',
                          '54859','74769','57487','66131','53144',
                          '11124','29931','58408','76424','70196',
                          '40917','50903','18441','47254','75914',
                          '84643','95828','82253','35905','19467',
                          '35619','16012','37904','36270','22450',
                          '26432','99689','31669','49060','71430',
                          '51406','21278','26956','23687','28014',
                          '76327','10085','54341','30611','25693',
                          '10326','79371','60748','56268','19852',
                          '25645','55425','66088','19677','87859',
                          '74549','52394','35385','47327','28887',
                          '41989','98421','36153','59408','46839',
                          '44375','37224','47431','70647','63303',
                          '69844','28673','50216','74519','62265',
                          '78728','23199','25837','20798','33317',
                          '21387','79846','32004','84584','33630',
                          '57203','28368','22183','37524','91921',
                          '17781','96101','91973','29309','60922',
                          '50278','42898','52711','65466','77334',
                          '25269','45483','83237','14179','71864',
                          '57836','25240','22684','10079','51833',
                          '25784','23589','69188','99633','80468',
                          '43052','64407','45767','97225','26442',
                          '92422','92652','30661','34540','31760',
                          '34351','77173','78674','73287','98352',
                          '11365','24213','75755','73256','37555',
                          '22023','51091','38950','16297','80683',
                          '64763','35578','66985','63685','96811',
                          '43342','98051','67913','81441','11383',
                          '92244','80575','97078','65558','95182',
                          '21593','71539','54443','36688','12477',
                          '43056','83554','56487','76708','88349',
                          '20864','81678','70518','82668','17607',
                          '91697','93011','27372','75941','29031',
                          '19861','13823','89501','32606','21504',
                          '24836','95308','35606','73045','14645',
                          '73100','56945','68358','39284','59737',
                          '66041','34872','40797','23756','74935',
                          '82674','31212','48803','92067','52403',
                          '42739','61861','65007','41768','69102',
                          '72423','71493','85184','42834','93942',
                          '28819','61187','22638','84985','86541',
                          '64592','32100','61515','16646','70460',
                          '17843','46024','90804','70324','73644',
                          '92885','34206','91728','21621','30420',
                          '55298','82276','97705','28867','36875',
                          '14114','11952','61782','41705')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

