-- start query 8 in stream 7 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '89725','23691','67709','14637','18826','75331',
                          '13822','41886','50398','22505','84691',
                          '38440','47923','42991','83728','86665',
                          '96252','35638','27266','64760','87460',
                          '70436','91815','84432','61061','48379',
                          '38928','94921','37327','44723','43388',
                          '61779','75338','91349','72066','58726',
                          '90392','64696','58328','49209','70929',
                          '88450','28430','95074','29212','10164',
                          '41380','71076','73966','91263','24130',
                          '81261','83081','36086','25367','12484',
                          '76845','96405','22470','31409','21818',
                          '99441','80917','23586','21838','15317',
                          '80166','93442','81440','56819','30203',
                          '70685','28729','28666','12896','10231',
                          '41358','31961','86230','49695','65589',
                          '54355','20091','66990','38570','67776',
                          '83623','28611','50532','44764','78010',
                          '83938','11500','20086','31911','89484',
                          '61942','88791','87546','12688','38065',
                          '79376','14456','97450','73195','49112',
                          '57998','90893','40896','96582','80114',
                          '44016','74432','48008','99549','33026',
                          '30393','76765','73006','24925','66448',
                          '18438','95925','35744','97296','16681',
                          '90291','82933','67126','78003','66773',
                          '17087','98273','30122','12241','14825',
                          '34980','18768','73404','64610','89087',
                          '10534','21357','14511','69751','54373',
                          '89035','89358','70195','27239','33684',
                          '83300','67490','65934','42305','17733',
                          '83791','51981','67412','29623','37883',
                          '11894','91997','55438','32183','24918',
                          '16417','25804','26705','74508','39797',
                          '65946','16383','72332','66937','47080',
                          '62216','47353','13376','81317','47245',
                          '11539','65015','90380','31995','52830',
                          '78575','75691','15979','15918','25446',
                          '13647','98893','46093','42369','85845',
                          '97408','49672','44170','93036','13434',
                          '78187','54678','68133','87663','76268',
                          '31312','50281','20907','27137','13221',
                          '96933','21751','35926','98175','65221',
                          '82292','93033','86033','79791','64116',
                          '89461','99604','23915','62197','12838',
                          '57773','92509','85203','65896','70793',
                          '88290','52452','69006','86391','90672',
                          '76285','15664','62400','36740','42265',
                          '26881','31188','47754','91223','60242',
                          '47131','22535','24717','18809','40402',
                          '43218','50224','65745','97173','74697',
                          '92468','58753','68063','67687','42807',
                          '59261','48366','16528','19289','84729',
                          '94773','37214','26417','73436','58025',
                          '81709','62022','84872','11973','85500',
                          '71233','73514','13849','63975','34875',
                          '64703','93627','31474','96840','36713',
                          '81601','33246','19277','47818','17608',
                          '20006','43673','79350','64840','34202',
                          '74801','47464','27419','95817','40611',
                          '45373','93166','29797','99474','79655',
                          '81779','35263','23382','73399','59760',
                          '41790','14110','77681','48377','86869',
                          '13728','61097','80561','95978','56565',
                          '72044','10646','40460','27665','53495',
                          '65688','43555','57297','38741','34843',
                          '18702','66324','34532','10647','68257',
                          '12132','25763','26650','26414','97100',
                          '58433','54411','57946','71625','18576',
                          '44597','75389','34310','80517','27564',
                          '98312','10243','91554','97172','93729',
                          '33319','22740','32298','51232','49389',
                          '88146','27890','27500','47220','72954',
                          '44258','20657','24099','20980','42358',
                          '70551','69701','34826','45609','28129',
                          '67918','45476','79953','42606','89180',
                          '69696','47915','43758','57620','11554',
                          '78317','15486','82682','79004','55177',
                          '49347','98996','30844','46725','52998',
                          '36962','89928','13554','62104')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

