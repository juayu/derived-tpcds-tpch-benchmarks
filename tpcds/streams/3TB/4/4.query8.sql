-- start query 8 in stream 4 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '65876','75272','18698','11925','69204','81308',
                          '91554','82505','55581','75741','13338',
                          '24336','16786','54053','52407','22319',
                          '96583','99728','32268','81085','59698',
                          '63781','25693','45001','58227','79490',
                          '52438','96794','21106','39967','72356',
                          '44742','91873','80491','52341','77493',
                          '24911','77336','17498','49284','78594',
                          '98048','47628','79971','59292','63687',
                          '55003','68541','72220','11692','53073',
                          '28145','72794','84022','52962','99462',
                          '50070','15149','88616','59437','80135',
                          '42396','84516','85716','62090','17669',
                          '84404','21586','42929','56340','90734',
                          '50429','81165','16042','74797','44427',
                          '72562','62966','85600','14755','52577',
                          '69148','55290','42882','43757','30764',
                          '65806','36300','79055','25720','69608',
                          '30952','83504','14570','21954','97732',
                          '28226','27546','95353','44862','19557',
                          '91783','67654','69875','55860','68014',
                          '81869','29690','82387','29217','47176',
                          '12967','74712','58525','76812','72721',
                          '26615','10075','86643','22722','99758',
                          '93769','37129','79467','74601','74192',
                          '25715','78698','60189','97680','14586',
                          '85974','79116','80450','63529','15881',
                          '29474','42893','31346','53121','67020',
                          '40155','19208','26619','34457','29008',
                          '69634','92422','52040','67048','47941',
                          '48204','41184','42505','84956','32461',
                          '36035','80389','10070','71095','76042',
                          '95823','20499','74679','61024','19622',
                          '56913','10516','46072','34939','63893',
                          '64379','48949','74687','85712','95813',
                          '94913','52268','27849','10721','66526',
                          '52558','51077','17911','82612','50186',
                          '89605','15390','67752','23828','98313',
                          '23721','61059','50266','97408','89995',
                          '78450','58773','77255','48252','81535',
                          '22445','42449','36264','61218','50636',
                          '14345','72305','56991','29993','61019',
                          '47330','43892','80406','53246','71027',
                          '83470','15808','25858','10684','19887',
                          '60942','69238','36955','23553','39331',
                          '91223','93463','45302','67812','93841',
                          '69933','27219','24488','31438','26931',
                          '53009','38164','98115','96039','23383',
                          '94189','50034','11375','98226','31281',
                          '74141','40598','75923','82115','73479',
                          '98640','86471','55904','60442','26594',
                          '78396','77476','32488','49804','15272',
                          '35715','76620','96185','77555','54773',
                          '96532','85045','33106','59516','25712',
                          '14738','87465','30315','11712','24828',
                          '17819','73011','14399','75261','56257',
                          '34147','85862','39166','31938','78656',
                          '36608','11457','49338','40270','29793',
                          '72283','68270','72226','38400','56773',
                          '29557','53301','97238','68801','27604',
                          '95249','50688','76578','70326','72981',
                          '56593','44318','89173','41975','60161',
                          '10119','77775','95824','50518','64606',
                          '58235','23466','49907','60076','58686',
                          '51977','53961','86206','77425','95533',
                          '75910','96747','19435','14843','37663',
                          '66977','70130','91820','26533','17376',
                          '13078','44520','33466','64376','56595',
                          '43991','89236','53584','99295','14053',
                          '95718','51984','34562','88012','35807',
                          '89562','76980','71600','97377','66332',
                          '45851','57847','69145','12861','42646',
                          '33228','98693','40964','55236','96213',
                          '90879','66994','70051','76975','99577',
                          '43234','25331','19651','73470','26138',
                          '66572','72797','99650','91428','85555',
                          '83158','19862','60211','47114','12837',
                          '98869','18174','45631','70847','31342',
                          '42842','49993','53641','27772','54414',
                          '81426','72264','31279','76801')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

