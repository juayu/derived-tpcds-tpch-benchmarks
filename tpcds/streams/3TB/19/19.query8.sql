-- start query 8 in stream 19 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '97930','50289','43097','44413','20557','28630',
                          '85179','84207','18972','53148','79392',
                          '77848','56167','91134','60323','86083',
                          '33501','67635','38777','29775','74781',
                          '25011','59552','26615','99572','87839',
                          '10808','77184','11641','51663','36259',
                          '86553','87631','63937','48503','63852',
                          '14245','78557','14491','23402','16690',
                          '77679','65167','84298','87553','41194',
                          '16206','25911','82910','50748','12819',
                          '88928','24768','69650','41214','63908',
                          '15410','10224','95341','67572','90790',
                          '47819','60176','18741','82534','11626',
                          '87095','73183','10607','29055','17214',
                          '88621','18994','97691','75750','92696',
                          '73069','25026','39652','67391','24103',
                          '59520','44117','97418','54428','52580',
                          '40952','71781','70923','80731','98743',
                          '25959','19484','51662','48155','39955',
                          '47529','22680','85163','27664','13452',
                          '88916','75571','36695','36436','14886',
                          '20371','54689','44840','15084','10897',
                          '26580','82285','18895','67991','88741',
                          '86958','42702','69889','17822','70326',
                          '91484','82756','23980','66687','57479',
                          '31608','63813','15776','19705','82199',
                          '74458','11451','27101','11217','38280',
                          '50218','32653','56641','12855','91604',
                          '89692','23956','25304','83562','64172',
                          '17206','76937','89664','69474','63004',
                          '23751','66970','61250','19098','65997',
                          '61457','64636','50421','21414','47540',
                          '21972','78623','87498','56438','88564',
                          '27215','61287','30887','43442','43948',
                          '55388','48979','81472','78783','27616',
                          '35327','26239','70071','59253','22233',
                          '49023','14526','17299','13778','55902',
                          '28695','22528','99735','98333','33121',
                          '93274','34553','87807','17609','11949',
                          '10549','29012','58081','35454','25088',
                          '42390','88822','48813','54643','34288',
                          '47851','62606','42296','78923','69426',
                          '57235','52677','32709','23939','90207',
                          '33584','46008','21161','14047','26523',
                          '83838','18626','92973','34438','62029',
                          '98405','68862','41221','10488','27810',
                          '56525','64901','30227','44483','62523',
                          '51894','75727','50542','38881','62828',
                          '57901','77306','70601','37611','64653',
                          '46713','97655','49932','31195','63781',
                          '71418','21136','20966','76101','51377',
                          '48629','47182','38971','70812','57373',
                          '73451','75432','82857','98120','65338',
                          '12938','32787','47386','56185','78983',
                          '51717','25682','90409','69644','31779',
                          '37379','66693','92490','22602','60190',
                          '73677','99602','11245','32983','67305',
                          '28973','82164','37988','88820','28714',
                          '81851','52372','14287','79343','89887',
                          '87542','64154','42439','99558','32896',
                          '14181','83597','24311','16222','35717',
                          '53611','65395','27711','26718','93190',
                          '29628','94821','38703','19278','35923',
                          '48190','45114','31179','22174','10219',
                          '82325','64820','67184','41384','69416',
                          '91507','42042','20348','38339','73725',
                          '15655','49405','33578','59690','92667',
                          '17931','66939','49011','18363','49949',
                          '13360','41924','86293','94396','29251',
                          '23125','39543','68802','24507','66319',
                          '53950','83381','62163','19133','63714',
                          '71631','57369','65425','98254','52179',
                          '89726','49455','69919','14239','42977',
                          '86266','47679','91200','23931','73174',
                          '95579','65419','25316','50304','54017',
                          '19086','82310','14754','55477','33649',
                          '71876','74930','19529','68068','15164',
                          '20421','75801','28218','65185','86848',
                          '83011','99110','10774','41802','19374',
                          '69424','15699','93346','31553')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

