-- start query 8 in stream 5 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '29678','29422','71540','84147','74305','57460',
                          '73446','58167','51080','48229','25852',
                          '92960','91277','35349','19286','74892',
                          '69077','14199','96908','23947','91847',
                          '71733','75139','68330','91167','73044',
                          '74211','31976','99732','32710','52150',
                          '79911','46630','31739','16824','15457',
                          '75353','24408','29144','17575','71020',
                          '24011','91809','84236','91717','43515',
                          '18424','39649','86072','46099','28162',
                          '70956','45464','32256','38864','92885',
                          '94391','95206','10112','52549','18432',
                          '75720','91109','96986','72925','91736',
                          '49907','40583','39036','60608','90755',
                          '30929','27233','50806','81623','14256',
                          '20266','11775','78290','76087','30004',
                          '23418','19736','32550','12818','68570',
                          '56335','48786','10154','57410','92533',
                          '51500','83441','11392','75414','84482',
                          '96500','41097','66912','74246','74607',
                          '46497','32390','13173','25352','32619',
                          '79892','52199','34730','34653','54948',
                          '28144','52065','54594','20553','94626',
                          '98333','37816','48076','99223','72952',
                          '66026','90821','35059','31984','74634',
                          '87573','13972','46679','31016','97690',
                          '27400','50101','99030','96761','53624',
                          '72964','62432','46164','92440','67643',
                          '15907','79880','16768','80670','71572',
                          '47696','34191','76874','48407','56314',
                          '58015','99012','26528','73731','34784',
                          '64293','14740','94447','74070','35842',
                          '76142','28139','37999','24720','70629',
                          '48803','11398','91287','49645','50216',
                          '16936','53755','60715','88371','53515',
                          '58452','62401','51959','29156','41295',
                          '81209','89085','51496','21782','92990',
                          '43607','45699','86382','35839','26099',
                          '77346','71800','72585','88021','77498',
                          '69446','97806','41128','24249','16645',
                          '40912','30230','59712','73829','20554',
                          '25022','86985','12515','99514','75702',
                          '80634','57601','95328','82134','46604',
                          '77140','75808','41799','60489','33631',
                          '30081','15565','95644','59831','71650',
                          '19232','12467','56789','66491','65009',
                          '78900','64835','97153','15152','51231',
                          '69549','81596','39630','77550','59440',
                          '27552','25162','70240','15361','83947',
                          '95108','51566','56287','23187','31634',
                          '13410','63003','24191','25909','56762',
                          '53727','74521','20950','73538','48468',
                          '69661','84857','56710','58064','53033',
                          '63265','45187','25938','24309','20649',
                          '72533','36742','30703','49955','76199',
                          '98026','30903','62623','74725','42773',
                          '16202','61830','31513','22597','47111',
                          '76307','69687','17701','40821','97105',
                          '46321','49061','50395','35654','94055',
                          '30238','46924','58906','95033','29415',
                          '72168','92377','96342','55166','86547',
                          '22295','37023','66864','58158','79305',
                          '34091','69268','32149','40552','79926',
                          '18938','32200','57245','29750','36814',
                          '10164','64969','26114','65422','56774',
                          '40756','86663','53353','46430','87097',
                          '86840','17758','92822','88357','57534',
                          '15227','54519','85648','81834','15173',
                          '98153','36432','64638','91518','29341',
                          '31946','85888','16931','36687','59024',
                          '39588','13838','96651','30313','33408',
                          '22032','89925','76688','22575','26663',
                          '98711','78186','24353','63560','60208',
                          '98638','37027','77899','77990','68149',
                          '88450','14290','43130','74730','52428',
                          '53884','71039','71143','32955','34614',
                          '51038','42247','83854','72636','12049',
                          '80561','64254','18346','68272','80940',
                          '55586','71325','35222','98047','24043',
                          '57959','92113','39694','54352')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

