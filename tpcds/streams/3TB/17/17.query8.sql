-- start query 8 in stream 17 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '55401','18603','55984','99312','85193','24659',
                          '56091','11986','52082','69138','12951',
                          '31448','54597','25069','44211','83429',
                          '83407','59363','17820','93495','96433',
                          '68657','72426','72699','93689','13810',
                          '35311','81114','68298','62052','72963',
                          '57580','94544','19931','11133','53808',
                          '69433','30866','38217','33693','31555',
                          '32632','79613','33812','84968','95804',
                          '25152','48077','92374','21263','96635',
                          '83886','74239','83186','39585','15622',
                          '15248','99775','67693','39838','84222',
                          '97034','80794','95108','22689','46077',
                          '81198','96423','29253','16808','46937',
                          '13497','36973','35460','35262','35210',
                          '80491','74649','42134','34312','74271',
                          '86572','72384','17256','38256','61885',
                          '20190','95952','92283','88073','93760',
                          '32390','81156','64133','95079','50910',
                          '13938','91342','40555','14249','42085',
                          '93467','38666','16598','11142','36697',
                          '96646','20569','75181','74142','56100',
                          '43005','67158','26472','80505','12615',
                          '10013','32070','38703','69820','49526',
                          '11198','56019','41655','75772','93133',
                          '44517','83030','85002','50054','48229',
                          '23264','11023','46727','52512','55957',
                          '51807','34994','53707','44137','45516',
                          '99162','31760','50934','14195','52350',
                          '80224','50555','69332','77739','70622',
                          '55593','85880','86869','76798','83932',
                          '63420','53404','66517','41805','33530',
                          '63884','77502','34722','21368','51897',
                          '42537','20493','44883','83999','69071',
                          '96753','78528','70159','18198','64343',
                          '31171','87604','48890','16613','59441',
                          '60494','71380','39044','20855','28369',
                          '51624','18388','24466','12270','65755',
                          '88298','34873','52239','33759','45070',
                          '61577','88176','69665','61415','51975',
                          '93130','38624','25913','91483','57178',
                          '36047','24559','41665','35816','40757',
                          '44251','11414','83717','13862','65878',
                          '64425','92386','83455','58505','71518',
                          '76611','77563','64234','52422','74965',
                          '66268','42029','95763','57679','98183',
                          '90297','91401','33820','61937','83972',
                          '61781','11491','66417','98581','23098',
                          '97205','80395','69980','71169','93846',
                          '94491','60452','74895','58944','23593',
                          '30679','22748','11435','40220','35506',
                          '76961','55092','92017','72938','75066',
                          '65317','42515','72646','40912','56680',
                          '48266','60166','41623','19464','37236',
                          '19525','13972','33041','67232','11083',
                          '80392','25743','26174','97018','14715',
                          '53238','52655','12586','57516','25229',
                          '95039','23619','41312','38068','86492',
                          '12184','54998','11443','52704','69913',
                          '58730','59955','68353','75212','79065',
                          '91286','50347','42175','65895','49031',
                          '80525','25984','65835','78149','75882',
                          '99583','60661','95930','18305','26466',
                          '39587','19669','19469','21611','86981',
                          '18790','37778','14267','85830','20009',
                          '40330','22775','83636','84642','95162',
                          '63149','38716','88280','98563','20447',
                          '38279','43583','46469','66118','67577',
                          '64667','15461','10773','43255','27521',
                          '88146','18643','83053','96393','55694',
                          '10322','95084','58062','34794','14944',
                          '47116','98045','96383','88221','30914',
                          '89901','73909','48477','36162','98166',
                          '27976','30729','28322','88974','52797',
                          '14752','62119','28235','30357','26558',
                          '89959','42501','43529','70253','51025',
                          '14806','68741','71974','74912','79770',
                          '18011','45166','87610','58161','14384',
                          '46591','77474','46627','78505','64235',
                          '74451','68713','95121','12696')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

