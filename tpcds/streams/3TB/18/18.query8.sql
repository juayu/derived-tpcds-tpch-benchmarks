-- start query 8 in stream 18 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '57482','17096','63941','19607','27158','87509',
                          '97071','38558','40520','84746','66184',
                          '12679','86211','53338','98930','37466',
                          '34745','48968','72379','94933','20662',
                          '38895','18308','97064','66929','27249',
                          '87073','32978','42649','18914','36345',
                          '94709','75669','76192','18052','54703',
                          '97994','85232','96469','11694','38042',
                          '29379','12292','71459','34558','90359',
                          '83740','91215','63210','26589','19054',
                          '64074','63462','18092','50036','65999',
                          '90990','13349','18227','76831','70551',
                          '21894','29895','41219','92316','59537',
                          '31201','42648','41220','97813','71080',
                          '20506','51223','79353','27925','75654',
                          '76145','18943','80866','72431','71554',
                          '12205','45804','21048','21042','54817',
                          '92408','72108','61081','61977','58508',
                          '65419','50767','84234','29713','55400',
                          '77388','86186','75854','12296','39127',
                          '54988','65935','74985','36807','76960',
                          '15824','24804','21723','81920','19155',
                          '82528','79760','67552','61448','57706',
                          '35892','93281','88936','91972','51003',
                          '65676','74434','75703','81901','45194',
                          '58414','26181','72244','43251','39553',
                          '97738','31429','12456','89682','10916',
                          '97283','28564','25513','96700','11258',
                          '54270','72798','65558','85021','77692',
                          '37444','67562','52281','39128','56578',
                          '11722','82731','63655','63292','56857',
                          '55512','46970','80116','88396','60679',
                          '97582','77638','79230','49802','88488',
                          '64914','93511','54532','66803','34471',
                          '53718','57303','86082','11250','46183',
                          '71204','75319','38022','36964','87108',
                          '18286','49576','86943','46954','53190',
                          '22011','26988','44045','59621','16591',
                          '19549','25237','10982','78525','18620',
                          '82422','68146','60532','96103','97802',
                          '58095','99081','25200','62707','91510',
                          '18466','95339','20339','30111','45317',
                          '23581','36672','61961','46663','38019',
                          '69653','95126','40338','65913','33004',
                          '81226','50795','66754','11549','67228',
                          '62606','49324','88274','78456','72740',
                          '96309','16655','37610','53647','40503',
                          '84382','75044','20060','39428','89099',
                          '74958','83187','45983','33729','97221',
                          '99872','39274','58832','17639','47523',
                          '94827','59171','98363','59013','30480',
                          '16025','45043','84587','21614','27346',
                          '65981','17035','59743','54254','31708',
                          '68055','69319','18491','91528','16281',
                          '43294','30913','30106','38413','98284',
                          '36231','47821','25359','48230','21814',
                          '23576','59113','33450','67043','26066',
                          '35959','87036','99177','40831','67111',
                          '70931','44553','67109','91436','97992',
                          '29117','15598','13531','43040','40458',
                          '87054','16477','33810','38652','57465',
                          '65632','49630','63326','85870','81325',
                          '61942','17698','36660','86686','94563',
                          '74649','43903','79286','86687','26313',
                          '64025','58098','55755','96993','78427',
                          '51895','71669','23029','51090','17703',
                          '39615','33413','18453','13967','17520',
                          '92947','90483','15908','64830','15430',
                          '89276','85541','38782','63105','83621',
                          '18396','82089','24815','64804','44988',
                          '93607','40833','16603','31530','40229',
                          '91950','27264','77455','14783','21302',
                          '94849','97678','68395','76189','66314',
                          '62276','27383','68591','25908','94342',
                          '66403','20937','92221','71211','37180',
                          '64674','94142','94076','54134','99562',
                          '13280','57094','10381','86118','78867',
                          '23630','85370','61374','80993','71605',
                          '33082','28556','98913','68407','30849',
                          '13471','58708','55950','39870')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

