-- start query 8 in stream 11 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '53074','35004','24570','53149','20912','75091',
                          '17216','54988','69930','33103','70340',
                          '28452','11381','56513','12706','90344',
                          '57839','38792','77714','21285','49805',
                          '97306','83564','65144','99627','18335',
                          '97629','17876','69595','14548','74390',
                          '45876','70853','55839','15880','40045',
                          '80542','34658','86347','73365','73490',
                          '19505','11504','77795','59755','93137',
                          '50922','44438','10880','96391','93084',
                          '95817','70180','44376','57000','83150',
                          '75638','36586','76070','27061','19594',
                          '54885','90584','19448','30097','86640',
                          '21316','79963','12019','34001','86832',
                          '37935','55000','42093','18991','50826',
                          '80659','30545','82223','63288','67632',
                          '16779','81945','18295','16745','11793',
                          '42493','52599','94744','27027','59455',
                          '92619','41472','55949','32090','32341',
                          '40934','50573','37605','28424','97958',
                          '23266','95496','75156','91722','93402',
                          '36617','25124','55324','31585','63567',
                          '29339','58656','12274','18707','21176',
                          '21530','62495','76207','79756','72513',
                          '72594','82678','37751','68212','28590',
                          '64614','55452','69557','86403','72194',
                          '34499','41892','21924','93203','43435',
                          '40352','49851','41322','81911','65702',
                          '86125','31061','55602','98563','10790',
                          '36362','62664','96623','79544','29955',
                          '48823','20429','66049','44071','57970',
                          '31710','47459','48424','28355','85998',
                          '99191','12466','68417','32214','29118',
                          '57723','35121','27433','18226','10732',
                          '57896','85067','79307','83866','77004',
                          '71321','78522','72978','19472','28884',
                          '92003','56959','81144','53673','43080',
                          '41298','43872','50755','59413','17946',
                          '59395','53632','75441','99357','34528',
                          '57612','79575','33354','82767','88227',
                          '47776','79703','31825','50612','69085',
                          '30560','70116','94929','27459','72749',
                          '49443','55756','49101','80145','55108',
                          '60557','57121','12321','53048','77148',
                          '73348','14181','64013','67474','32149',
                          '83565','66680','15855','19977','31970',
                          '49282','62026','89296','79727','53023',
                          '40510','34912','98314','96586','15924',
                          '62343','86133','34617','51660','45024',
                          '54793','48318','34156','85048','56080',
                          '64194','89619','75071','73785','41532',
                          '48279','81725','47796','95474','35552',
                          '65829','50620','40468','72193','28406',
                          '41479','18151','67473','68028','89618',
                          '52354','20096','23505','67344','70418',
                          '81915','52286','85172','37673','81964',
                          '86900','63366','16703','55332','56267',
                          '40275','27905','34419','96054','38945',
                          '86663','69873','74217','10409','14455',
                          '35686','54835','66160','25489','44426',
                          '11098','90461','66434','94812','72893',
                          '91711','36593','48659','83662','38693',
                          '60854','87554','79700','46973','45640',
                          '98736','92986','95695','11344','55046',
                          '17119','22257','82264','95986','68551',
                          '81653','42613','39729','42712','24955',
                          '56850','99512','14528','70781','84996',
                          '60310','50516','37640','34884','31416',
                          '94393','74181','78492','48782','76476',
                          '78789','99413','38633','50810','75860',
                          '37929','95729','96126','41305','17920',
                          '80596','32993','65381','41040','74641',
                          '90006','29312','88397','59456','96754',
                          '99009','92658','61366','46777','29259',
                          '83425','68952','75669','50373','86433',
                          '89639','77582','36200','95115','19736',
                          '63624','76546','61033','76242','97961',
                          '50223','25871','91801','50071','73398',
                          '73521','50758','66270','85657','44427',
                          '58940','60895','74540','12332')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

