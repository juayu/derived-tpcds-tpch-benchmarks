-- start query 8 in stream 14 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '50446','40913','64263','72802','88332','74217',
                          '38696','37105','32022','74325','95995',
                          '75802','42836','40726','18324','30450',
                          '30561','73656','29626','57295','58022',
                          '64034','65644','15456','37711','76707',
                          '34682','27966','38194','12202','31901',
                          '96246','79300','48281','28085','59545',
                          '54547','74575','46804','82671','18515',
                          '44699','87857','16457','59159','61301',
                          '99277','51081','23478','25065','22239',
                          '85138','46892','92788','12208','23775',
                          '18306','89014','14152','63789','13323',
                          '33022','20933','27652','75790','51890',
                          '58015','51713','64346','38157','62748',
                          '20696','47264','28206','16707','83763',
                          '81474','92690','77998','30836','94044',
                          '28612','32687','24597','38801','55001',
                          '72821','10863','26616','69861','15617',
                          '68341','34214','29095','38477','51015',
                          '87579','71903','23727','21318','47960',
                          '63059','72621','87473','87780','71820',
                          '99702','45097','43232','18818','55543',
                          '67738','24140','75077','45411','62891',
                          '15593','82124','14605','26882','69014',
                          '18766','10973','72487','68491','23163',
                          '11418','51019','71788','88932','28539',
                          '15467','35183','46452','99521','46295',
                          '30801','50368','69739','59502','72347',
                          '98823','74860','74618','72300','89903',
                          '64705','88726','50852','13379','65461',
                          '78000','54510','30417','80651','54011',
                          '56888','87104','77469','56803','93776',
                          '20054','91456','18627','82594','30096',
                          '99586','34522','60230','38680','31340',
                          '31501','31082','39281','91465','89103',
                          '92266','26507','41783','79268','71258',
                          '33452','61662','61115','48074','26430',
                          '94488','56252','23868','52684','86678',
                          '35578','17026','16353','13088','11170',
                          '58337','27090','41123','33569','61485',
                          '18518','43289','63053','35162','15035',
                          '25572','91848','57906','82651','72006',
                          '92997','99984','14277','21569','69601',
                          '13925','82120','95690','93870','55738',
                          '83791','65474','44983','78213','71224',
                          '63656','65272','48498','24781','49342',
                          '56372','71729','61488','88342','74291',
                          '30308','80231','52571','52719','73557',
                          '75269','14858','69742','36913','11796',
                          '80448','12481','37747','97460','88808',
                          '24719','37786','32284','45572','72358',
                          '76759','30866','19674','43462','52195',
                          '92335','12228','27115','56763','90198',
                          '60536','72173','55940','70501','79410',
                          '73927','55150','38688','25622','51736',
                          '76061','92060','89038','96241','42827',
                          '79723','32248','23494','86386','11147',
                          '80804','95368','19157','44669','45702',
                          '96026','58614','89114','89497','92920',
                          '13225','82709','43789','16899','77332',
                          '74173','64202','66844','18026','93840',
                          '55418','15834','82917','65725','29145',
                          '52016','43030','58457','86278','16501',
                          '16970','17235','24051','30441','20764',
                          '73632','95543','92671','73861','48317',
                          '41328','46938','23568','48007','71070',
                          '84456','29666','46678','12173','35247',
                          '61121','15973','88225','50704','94009',
                          '31790','43917','92043','16166','53236',
                          '49871','18638','15464','97614','10593',
                          '48177','82589','33579','20511','44898',
                          '61199','14422','62617','62640','90936',
                          '48590','58208','45956','46536','45822',
                          '11310','89542','18526','26604','48119',
                          '41133','56152','14812','63559','46142',
                          '55082','76031','18541','82810','18387',
                          '37726','97396','41341','56610','48944',
                          '92370','77073','58099','28794','54140',
                          '62559','87286','64166','35794','71949',
                          '84839','66418','77153','72768')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

