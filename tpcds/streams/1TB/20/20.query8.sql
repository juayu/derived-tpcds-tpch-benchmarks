-- start query 8 in stream 20 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '15457','24801','21777','39643','99807','54022',
                          '71850','41454','78863','65954','60873',
                          '10282','84508','34784','97808','89314',
                          '97684','37797','28505','46966','70292',
                          '52567','97216','62784','76732','26859',
                          '76078','13401','11324','11467','63224',
                          '10310','90286','90295','52384','71122',
                          '93448','70296','26549','80656','62407',
                          '53371','19044','94935','63398','42479',
                          '43868','82034','89759','38241','87048',
                          '64058','57543','37131','38923','64208',
                          '14431','94558','53938','24291','61729',
                          '77057','64237','62799','43760','69833',
                          '38139','92904','68503','99852','29819',
                          '31657','78784','82143','48722','75947',
                          '21200','67731','48787','41299','77950',
                          '11914','80310','34681','25695','51991',
                          '10255','78868','98456','88782','12039',
                          '30226','24625','90078','28913','72923',
                          '94551','19607','10301','46543','41115',
                          '59097','59762','45830','86145','72122',
                          '37438','48715','26524','39289','15139',
                          '97927','22743','39486','67250','71995',
                          '83020','26108','95309','92573','35127',
                          '45764','27242','78612','57416','72454',
                          '16497','71346','89972','65654','82901',
                          '47413','11069','15136','10232','29112',
                          '61499','67667','40496','99886','62971',
                          '46989','11988','22072','64384','13855',
                          '50892','82627','25503','51902','75359',
                          '34035','26749','65695','51832','50817',
                          '83539','72984','52471','92738','41965',
                          '54804','85926','95335','98312','97872',
                          '43611','35707','15631','72982','40168',
                          '53398','49829','19896','45860','39430',
                          '86308','73092','57913','78541','61098',
                          '58692','66458','16527','63429','74800',
                          '87883','49260','44519','42460','51647',
                          '55024','55374','62094','70097','15856',
                          '32052','59022','64977','42183','32327',
                          '27408','79958','62364','16110','80029',
                          '18395','71399','91090','40958','82480',
                          '27841','82147','39124','74731','63925',
                          '26686','54595','49428','43170','42494',
                          '82329','78456','20571','92240','74134',
                          '18046','27273','27441','36034','62524',
                          '31711','73069','80167','92824','56276',
                          '68045','41004','37572','62242','89870',
                          '40602','33356','79071','86659','80256',
                          '31073','41338','65509','55343','91263',
                          '14268','99053','57726','76517','97846',
                          '61978','39675','62275','60124','17014',
                          '96050','46562','64556','59098','44499',
                          '64907','82733','13690','56609','39218',
                          '45626','52775','96522','81063','60895',
                          '83986','62377','62594','25675','11842',
                          '47316','29941','62881','92281','84537',
                          '10288','20654','92022','96803','70364',
                          '58307','49707','42941','64454','88706',
                          '24300','80472','50413','46879','85879',
                          '87819','72192','37405','45927','84766',
                          '94270','36597','50605','67532','68506',
                          '23376','54240','57505','99512','73167',
                          '28034','20404','31528','33064','59548',
                          '42070','52406','22824','39321','19935',
                          '93598','55047','20148','85361','36853',
                          '46788','98029','65818','51885','73289',
                          '54829','17989','63521','42669','23391',
                          '26801','16414','78517','20506','19955',
                          '81400','96297','71141','90020','68730',
                          '90459','35932','58855','75920','44486',
                          '85817','25018','21620','61240','33627',
                          '64165','40480','97630','65163','66258',
                          '14570','53835','78633','92137','90536',
                          '69480','36277','99440','25249','84640',
                          '36702','40565','65805','19906','53998',
                          '68230','62370','52414','83359','59330',
                          '50294','43457','69943','57016','85753',
                          '38886','32650','45683','30348','27352',
                          '19908','73116','37414','39027')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

