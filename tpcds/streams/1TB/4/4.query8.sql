-- start query 8 in stream 4 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '76613','96888','40243','87577','52091','97235',
                          '67211','75667','75133','93198','46052',
                          '53172','12481','53707','84482','79439',
                          '96509','15588','14256','22848','77561',
                          '13380','55265','62162','70323','68023',
                          '89050','71113','80729','25786','12422',
                          '14461','26999','12703','59082','66132',
                          '80047','17385','61884','47457','80556',
                          '67997','15637','91584','56087','80442',
                          '60464','45391','91113','55150','76813',
                          '67402','41681','73347','24129','64429',
                          '19174','30018','72571','34986','38636',
                          '17637','43537','82491','30794','63872',
                          '15260','27847','37635','15328','94400',
                          '92218','51500','29644','33886','73024',
                          '51041','30092','37381','28948','57722',
                          '82710','94312','74983','15002','41112',
                          '30281','23301','85929','16937','53840',
                          '56761','75459','26181','27743','44261',
                          '11552','29292','54022','20955','26419',
                          '57742','45849','32609','32682','66766',
                          '57292','86079','21143','80464','12201',
                          '96883','82090','96984','45202','94640',
                          '52774','86296','57668','52180','86120',
                          '17135','17918','44903','85934','99338',
                          '31941','28246','92445','73002','54327',
                          '31580','69325','63585','25746','58589',
                          '28033','89242','99078','20943','60217',
                          '19970','35628','45051','60002','55801',
                          '65462','19214','53056','31152','56043',
                          '65812','85662','93715','90621','75739',
                          '30177','44131','30522','64579','28962',
                          '86382','49900','86241','89102','62571',
                          '94380','70152','38540','23203','40620',
                          '31560','25432','55838','50013','78408',
                          '40456','47773','42631','40023','46646',
                          '78292','32150','94814','34298','38208',
                          '85190','93767','91080','89926','58955',
                          '19091','62941','75932','37997','20138',
                          '35867','68078','29510','37278','23655',
                          '15664','63548','26610','48567','84129',
                          '37646','67692','97782','81896','76900',
                          '37220','46785','29853','69701','34205',
                          '46920','11823','75950','86754','27504',
                          '45817','22851','99173','53019','59956',
                          '52474','56688','77597','43008','51524',
                          '23005','16002','15981','91546','57435',
                          '67228','48648','61637','60200','14041',
                          '78582','24223','14556','59852','61310',
                          '10718','29335','67230','12221','31294',
                          '78964','56065','52799','76164','59044',
                          '23430','44771','69336','71874','19080',
                          '78216','52044','19078','59354','63913',
                          '75485','15685','53153','12018','70783',
                          '84316','69426','17864','40725','94306',
                          '13256','10494','55133','51308','97768',
                          '68514','66597','86666','55411','80051',
                          '52149','59514','16514','35632','48973',
                          '39927','85799','24544','57998','51604',
                          '66309','25815','73374','16110','89669',
                          '20302','70241','12820','10107','87780',
                          '36675','50658','73089','67477','88627',
                          '45219','37738','41810','88851','37403',
                          '66313','55867','16938','28463','93829',
                          '13397','42353','61002','98194','19975',
                          '58030','39434','90024','12340','13384',
                          '15025','53458','37694','63798','60493',
                          '59163','62747','78431','86635','66089',
                          '57564','11333','27250','98726','16733',
                          '73699','28247','63121','15294','32319',
                          '20323','51296','10653','93033','23597',
                          '64899','14508','11124','32046','26116',
                          '30532','63674','92054','89429','65198',
                          '30220','68484','12275','86719','37107',
                          '18741','64319','46804','49695','60216',
                          '12838','68723','28381','11419','94577',
                          '56222','81066','94570','18417','21593',
                          '44959','45808','28704','44367','73261',
                          '73242','97323','63451','18490','74376',
                          '32254','68622','68879','55367')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

