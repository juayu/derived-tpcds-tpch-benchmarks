-- start query 8 in stream 10 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '23359','14746','85560','28745','46243','83614',
                          '45175','26210','94439','57945','48793',
                          '16406','36192','80091','68946','52093',
                          '91152','97701','37453','97087','49872',
                          '86895','11009','11071','78845','35042',
                          '33149','66136','89469','69389','62682',
                          '97733','39133','32305','71939','91543',
                          '14052','69537','45348','67684','31105',
                          '48291','18860','91969','89019','95085',
                          '65726','20374','83953','85197','94162',
                          '47314','77991','71185','71231','73879',
                          '78777','77769','63231','59590','31078',
                          '93872','40185','69862','43033','46840',
                          '44620','41415','61089','51443','68365',
                          '70909','58954','76362','58437','53461',
                          '83911','36270','79735','15800','53921',
                          '78638','90422','22240','40637','78236',
                          '83677','34546','21351','43793','50214',
                          '27625','43846','99518','91718','30721',
                          '88024','46104','89874','77154','72398',
                          '66080','53989','86075','89586','72729',
                          '41830','35519','77629','51460','80734',
                          '68013','50391','89926','48789','46431',
                          '47993','44864','13228','68872','89211',
                          '15353','75983','14359','73452','36213',
                          '75831','72599','70765','67205','12811',
                          '19098','13530','24445','65816','11540',
                          '26303','19539','64484','72583','66499',
                          '60411','41786','82891','33523','44318',
                          '73244','91619','20253','41556','61760',
                          '84534','38283','54445','40410','82788',
                          '48271','22203','64614','85319','55359',
                          '97959','64795','62805','69989','71500',
                          '41261','65919','92818','73828','87398',
                          '57379','50768','13635','87562','80876',
                          '61286','94518','83764','54833','93976',
                          '47773','87492','19193','98114','26981',
                          '20534','72291','65864','80125','38733',
                          '62001','94064','20176','35909','43362',
                          '80431','46915','46650','97233','39835',
                          '82382','28129','36762','44607','41547',
                          '36065','18280','77304','59000','35418',
                          '16543','99878','79119','64016','11393',
                          '18001','59495','44969','22564','61806',
                          '16655','11642','16887','19596','45156',
                          '32149','93632','66005','79537','87612',
                          '48833','25099','33480','82516','86744',
                          '60864','34286','63379','62128','13650',
                          '20723','31089','11145','86992','71612',
                          '22076','47681','63125','87530','90541',
                          '44145','75159','75726','22616','82216',
                          '68029','60163','75550','27071','83004',
                          '16584','38996','45976','65143','44671',
                          '48816','34294','77411','19612','74885',
                          '66692','60693','64967','39847','93988',
                          '76795','29909','64873','62447','55238',
                          '90128','13479','92203','55919','45365',
                          '34154','63042','48668','57852','68813',
                          '35338','71537','99599','22631','12608',
                          '67370','91095','12985','82288','56580',
                          '19891','31116','16831','73654','78740',
                          '90957','38179','32071','87023','43866',
                          '22603','84103','50632','56923','57689',
                          '52807','35310','97994','42129','22771',
                          '71307','80614','53833','71451','57308',
                          '65595','56700','25005','30591','94433',
                          '32472','34455','69365','10732','70290',
                          '45414','95644','46058','26732','40522',
                          '31162','10746','63384','62508','35827',
                          '91161','27515','35390','54499','36565',
                          '50254','30692','76908','47854','34791',
                          '55031','94749','38793','69264','21050',
                          '51295','66570','56260','32764','41759',
                          '77788','37325','60943','70767','37606',
                          '73334','36880','98616','88247','66173',
                          '79204','74174','54724','61283','17837',
                          '72631','12553','62396','35099','72890',
                          '14240','12363','21494','30117','18761',
                          '85212','70685','97105','35987','33890',
                          '71597','78562','18444','45380')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

