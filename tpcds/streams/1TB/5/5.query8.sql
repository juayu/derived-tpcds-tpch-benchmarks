-- start query 8 in stream 5 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '31869','67342','68558','71603','68193','37458',
                          '14864','72825','46891','74668','79085',
                          '28460','15948','40991','19397','89498',
                          '91340','39117','43562','31512','62039',
                          '83353','56793','90181','63004','18919',
                          '30301','79521','43036','60428','44152',
                          '62245','65841','48399','95403','21400',
                          '79561','81213','38919','94249','75317',
                          '96129','81691','60396','97288','81657',
                          '40855','63931','82004','45419','87925',
                          '67583','39451','63213','93315','56680',
                          '52974','59896','79385','58819','47215',
                          '74582','89410','33334','27356','68694',
                          '77795','96497','92237','63951','52198',
                          '85898','61396','43041','53206','88267',
                          '87053','90649','56193','83366','42650',
                          '32528','23610','31937','85723','79713',
                          '66154','28960','85115','94335','71080',
                          '50699','63247','47033','61080','96722',
                          '42112','44258','96477','91033','38237',
                          '20773','77655','43531','93575','76205',
                          '73294','60896','66679','85778','65941',
                          '85511','71560','51648','55777','99256',
                          '88637','88294','58079','62798','16090',
                          '70269','99906','56227','71845','82896',
                          '76176','50306','32045','44228','86035',
                          '16651','51477','83099','56014','29719',
                          '94604','72597','42942','39520','43040',
                          '78016','39359','67475','46169','11330',
                          '50961','46108','26187','70010','16496',
                          '29767','13297','18710','46921','75027',
                          '46454','26811','59182','49316','55364',
                          '85168','86837','18691','55519','16644',
                          '69630','58077','38771','60491','84996',
                          '87379','11805','95131','24709','76057',
                          '84049','54810','18607','96271','19984',
                          '73316','30251','63748','82075','90723',
                          '20240','92098','14585','60720','33516',
                          '96496','59271','50355','69032','41310',
                          '13702','85762','55723','92195','87630',
                          '72660','48198','46784','97456','18726',
                          '49874','25675','37254','36700','68685',
                          '39039','42338','99198','68551','87642',
                          '11973','71723','19957','28878','26403',
                          '24110','86914','49748','49655','57852',
                          '77146','29015','96954','57679','44468',
                          '70224','32421','69074','93157','38444',
                          '58231','53541','71110','97022','64098',
                          '67682','82538','97417','80478','19052',
                          '96897','97862','82831','81046','99669',
                          '70418','82936','73298','93633','92812',
                          '41765','62996','69747','39208','36982',
                          '70496','74365','43819','40234','33828',
                          '58901','27094','78763','39179','84383',
                          '57266','99421','17160','81285','65445',
                          '39002','93811','66986','55958','27283',
                          '10666','14935','64411','95303','23705',
                          '49486','87512','51183','94545','48528',
                          '97455','10715','64811','52851','90025',
                          '36338','71021','72821','70807','60183',
                          '54203','47555','35865','38271','95929',
                          '14171','38250','74030','45493','51559',
                          '76372','48962','54663','55470','36824',
                          '14419','15009','20911','70989','38266',
                          '79863','74428','53654','58667','93859',
                          '30272','80324','42751','84313','39600',
                          '33786','87754','49003','89903','62041',
                          '98392','19464','11126','22266','35933',
                          '86431','97325','78857','91473','39803',
                          '90956','21270','74687','51529','28759',
                          '60880','43551','91648','70527','98476',
                          '60695','37236','37385','91315','32896',
                          '90107','30699','51195','71689','22071',
                          '62456','51230','43180','17520','97433',
                          '72441','74197','76658','37534','97255',
                          '62121','98806','59511','59619','71903',
                          '50341','89621','10728','41333','99600',
                          '76500','87031','97992','67949','92848',
                          '83872','32986','39291','77797','44358',
                          '46227','27014','66993','97063')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

