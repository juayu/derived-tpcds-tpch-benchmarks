-- start query 8 in stream 16 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '77648','78857','35077','90300','61838','86710',
                          '72360','34664','82772','45262','13505',
                          '77512','13346','20138','24602','56363',
                          '92401','35695','90326','18853','29484',
                          '63235','84019','26537','95328','10226',
                          '99396','79366','97662','49895','13513',
                          '86639','81330','96769','46359','33599',
                          '50389','87957','89256','55901','41069',
                          '71685','16285','90204','83309','36213',
                          '57590','76186','59848','83196','59207',
                          '70181','87000','35437','14487','77373',
                          '28085','56625','87552','14868','49437',
                          '13411','71050','54424','25401','73436',
                          '41398','46399','68498','42377','33978',
                          '45978','97582','74007','31418','85155',
                          '47874','80657','17503','28161','63401',
                          '96150','32927','32715','90119','34321',
                          '41897','47160','50381','99478','80118',
                          '60359','82289','91615','98530','58658',
                          '97622','69003','93417','12295','74306',
                          '19529','79183','61493','51635','29043',
                          '25459','65707','40357','57808','15553',
                          '31983','12938','21429','77705','38501',
                          '94806','38823','15483','56775','69709',
                          '22604','25296','58793','17253','89752',
                          '63712','78480','15062','87766','75106',
                          '73498','49488','27315','87498','28710',
                          '90178','95904','56288','95363','90896',
                          '36897','90997','84054','83499','51639',
                          '29295','81559','51606','50218','91138',
                          '46589','41356','59238','41968','99886',
                          '33008','14994','68062','99188','58073',
                          '66029','83553','70816','14767','94187',
                          '86087','64699','65158','61902','77358',
                          '16341','40381','83946','99811','47004',
                          '73161','31526','53410','58490','24233',
                          '72422','44082','90529','34602','11300',
                          '52656','73350','50525','63398','53806',
                          '72311','46005','47440','21148','58266',
                          '68739','43691','24706','35697','95206',
                          '13041','41534','16777','94934','89682',
                          '96546','30912','95387','99620','28137',
                          '21050','31604','84007','76594','74227',
                          '37588','72302','54630','98165','11847',
                          '60652','38528','75182','64951','11961',
                          '85885','88947','60114','91667','35294',
                          '59498','24694','79271','11188','89290',
                          '77811','69262','63070','16324','25860',
                          '72211','61374','38681','70942','51853',
                          '25414','89178','31911','18412','82787',
                          '73671','92109','42781','64830','37797',
                          '17616','35656','47818','84992','63808',
                          '55643','55750','89588','33249','29701',
                          '28598','14370','45964','42920','31200',
                          '58742','94613','54125','85339','78741',
                          '17660','83776','87941','47485','28696',
                          '49765','33849','65116','89419','68930',
                          '21631','24446','54765','63033','24690',
                          '15042','23066','12729','49486','71543',
                          '66898','30589','27815','40445','21531',
                          '70129','40189','67819','20003','62105',
                          '21318','29884','88680','19342','75505',
                          '47553','91446','94823','63243','44030',
                          '61765','10068','58407','47839','94751',
                          '91660','86812','53953','82059','16283',
                          '77757','63955','87367','85635','95981',
                          '76241','32880','60391','52515','61284',
                          '69904','60009','65125','68095','78433',
                          '43767','95502','61088','12044','67307',
                          '89143','71877','49500','54749','52934',
                          '17925','43657','56529','45985','21461',
                          '35886','58541','67368','13512','95109',
                          '87180','62942','50979','81605','21620',
                          '20789','27583','12103','38004','42555',
                          '96817','61784','50403','58547','24171',
                          '48651','16020','54691','98268','72596',
                          '48752','56148','81352','32903','26615',
                          '77766','74510','74002','48018','23401',
                          '28718','20490','73890','98619','94629',
                          '92978','24460','88356','63684')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

