-- start query 8 in stream 17 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '29090','89722','66360','56724','68990','93245',
                          '10347','91628','80808','14740','71751',
                          '61831','43049','53505','42391','76752',
                          '70019','53520','14657','59043','39295',
                          '49847','77127','94797','69640','75679',
                          '13105','85713','79987','83741','41243',
                          '57440','17260','55913','62996','51684',
                          '57825','77182','66960','27493','76005',
                          '86073','64180','38343','25860','54773',
                          '13161','18107','50435','85583','20528',
                          '25371','97759','24833','50226','84130',
                          '82900','47547','90885','83422','51189',
                          '25926','88902','45650','64999','25339',
                          '57611','35149','81291','50039','73709',
                          '99153','81168','68717','43523','13257',
                          '49682','86572','84837','51726','69522',
                          '60152','78649','39754','67095','57111',
                          '41418','66357','21577','91468','53725',
                          '18407','39167','11923','52974','63715',
                          '32442','77336','94973','83885','67038',
                          '67557','37750','43929','10589','58932',
                          '64007','42718','51998','73875','82634',
                          '11955','28317','17640','87789','83630',
                          '15717','76899','34060','64013','40753',
                          '61420','13422','96604','47392','81328',
                          '96451','75191','35180','30594','12591',
                          '90621','34316','34190','77354','14386',
                          '67359','90988','41530','69867','62391',
                          '86095','16186','33870','24239','30507',
                          '95597','44047','90547','74554','40501',
                          '43019','58327','47425','50178','19571',
                          '98312','77547','71229','72662','86121',
                          '68429','22571','52007','31386','38567',
                          '46532','16524','27035','42668','84134',
                          '38377','99894','85779','87306','17297',
                          '66304','32499','29897','15152','99242',
                          '10436','12987','19176','82000','79389',
                          '33475','37000','24041','63003','39273',
                          '17209','60958','67741','19729','89525',
                          '22697','78874','32145','29889','79890',
                          '57967','38561','74113','72768','24542',
                          '95683','60483','67221','21278','65851',
                          '41861','47387','87134','33583','99833',
                          '35080','65374','90000','74571','38102',
                          '35992','30738','38867','63597','73510',
                          '12243','74220','98276','83448','40249',
                          '67074','92065','62281','20313','52207',
                          '69452','83476','76902','20943','44896',
                          '34918','68501','86423','85412','80217',
                          '23466','23401','29035','36556','50950',
                          '51900','74316','46048','54463','21411',
                          '61653','21695','28303','85015','31987',
                          '45659','92845','75032','47510','77107',
                          '26316','60814','89809','29641','50657',
                          '42417','63210','51566','39400','83324',
                          '16358','39019','50928','91026','66549',
                          '35750','16394','11918','57936','94284',
                          '51770','47846','62146','10434','93442',
                          '30666','65448','78544','20391','91407',
                          '50331','73823','32132','21017','12965',
                          '63621','23422','20850','42321','14513',
                          '19894','16601','31760','28722','82462',
                          '29261','80323','47188','18367','15952',
                          '96876','69420','96946','85246','69057',
                          '91825','27447','74183','21585','36084',
                          '20820','99953','38967','48548','85168',
                          '88306','67349','21252','94244','71425',
                          '65501','95946','42778','75152','27368',
                          '19033','50325','79181','40676','55467',
                          '76944','47834','82937','21107','40164',
                          '54593','85405','66533','83079','92306',
                          '98048','42888','71211','95069','58729',
                          '99637','34652','26044','12592','22178',
                          '17772','32539','91302','49314','60181',
                          '77417','92503','25460','61112','10370',
                          '24499','43030','20785','54667','27446',
                          '98142','49349','55246','37472','59677',
                          '80898','42574','49714','93079','92838',
                          '71404','16553','86922','87357','20762',
                          '88484','62161','61538','74552')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

