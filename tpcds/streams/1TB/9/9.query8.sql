-- start query 8 in stream 9 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '19314','36665','88649','73276','73224','85273',
                          '99875','78853','46555','42679','77761',
                          '11095','94098','92260','69168','10912',
                          '27018','56787','72262','65388','74075',
                          '46209','17218','60079','33463','13882',
                          '94610','39235','11855','84000','50394',
                          '53241','56459','23813','95070','34300',
                          '14000','34604','41950','20331','75003',
                          '92548','37911','39360','18902','35281',
                          '45342','44384','68447','11189','31568',
                          '22510','89672','75089','61900','89611',
                          '46706','40543','62505','35711','12216',
                          '42989','72868','14359','80698','97860',
                          '84594','71119','56718','18429','39419',
                          '47748','27354','72382','36765','47809',
                          '93460','16836','83794','94329','17703',
                          '43411','45023','15936','55111','37065',
                          '33343','39982','50536','52482','57836',
                          '86884','22588','89746','90632','44668',
                          '46083','64136','67495','52921','99638',
                          '72105','15762','73510','73137','49699',
                          '37289','45863','15043','52594','63267',
                          '98006','51441','24601','23156','61484',
                          '71928','39745','48711','38952','57943',
                          '59987','20069','87668','60855','15301',
                          '83614','43263','18617','13838','16797',
                          '95945','69590','96059','16856','31196',
                          '18178','77635','91882','38254','24619',
                          '99615','39478','35672','52213','60250',
                          '34751','57946','64620','21844','26656',
                          '78148','63494','28035','85637','63479',
                          '63578','72092','70565','78773','16211',
                          '68306','95829','52903','40255','32539',
                          '17430','36410','15204','62886','48088',
                          '54788','96515','20301','78857','95306',
                          '79159','46562','80151','57856','24782',
                          '94417','57664','70048','75903','44481',
                          '63511','62271','45978','83084','74666',
                          '80611','39737','20110','55726','27207',
                          '47082','40075','67881','55556','20147',
                          '62583','73081','97958','29310','47786',
                          '16761','25703','37264','50710','50732',
                          '44950','37249','64350','95092','16685',
                          '38949','90761','81892','52609','64204',
                          '80658','57111','82581','12237','46319',
                          '95710','48928','22636','11582','85393',
                          '72945','75384','26872','67548','98543',
                          '75226','95054','96534','45407','20492',
                          '88615','69994','26310','14874','43832',
                          '97560','76714','87499','61314','28854',
                          '19447','21929','46018','24508','97877',
                          '17173','99459','54526','73623','78312',
                          '88119','17499','44351','80761','48039',
                          '91998','94650','82267','46781','15629',
                          '85136','26573','92675','12438','44016',
                          '49181','93930','14983','96771','76027',
                          '38133','94737','95529','56844','22732',
                          '27826','57540','99844','24806','61301',
                          '91977','98499','92623','99059','10876',
                          '29437','22193','59175','42301','21855',
                          '60788','57571','13641','42695','38366',
                          '81599','29149','77241','81190','47389',
                          '13388','76454','56325','39749','98798',
                          '94869','63201','20669','34144','80884',
                          '59031','31045','62575','55415','33519',
                          '41473','19855','94873','18769','25967',
                          '30345','15112','41160','34419','89056',
                          '41033','69236','60685','92850','84159',
                          '94894','80393','64270','81280','97152',
                          '77464','92425','94038','28571','76276',
                          '59844','35013','42032','26979','43829',
                          '30678','24504','43945','77170','33037',
                          '85841','62818','60527','79282','13940',
                          '81618','36121','83658','60751','28675',
                          '30194','23730','47101','92304','89041',
                          '34551','21809','71148','10915','19536',
                          '33861','49009','15760','27586','16914',
                          '58244','59318','89204','24167','20674',
                          '35373','49637','67290','38169','80818',
                          '30112','23967','12355','20623')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

