-- start query 8 in stream 1 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '50737','66702','84951','19405','12182','86394',
                          '48660','56497','97625','59803','55173',
                          '84374','99809','32650','43688','20712',
                          '35667','42928','75032','52143','19564',
                          '11048','76809','42157','47838','44382',
                          '78999','88755','39549','47632','59986',
                          '11279','19769','79817','17179','69511',
                          '37648','62301','24541','27138','88137',
                          '17072','27552','24947','23505','64405',
                          '47972','49559','98162','88326','14566',
                          '50685','50577','14193','88335','14652',
                          '82331','63411','94434','28090','21809',
                          '10778','38791','90033','76200','30968',
                          '64666','18905','11494','53263','87455',
                          '58269','87987','66908','74979','22480',
                          '97934','48274','99646','70444','76236',
                          '53063','92686','47406','87345','38653',
                          '17964','82430','26952','39998','57164',
                          '85853','40606','84115','73193','33502',
                          '29204','46539','55385','20987','52610',
                          '11239','80017','81262','23850','25174',
                          '15465','26552','65885','64680','67137',
                          '59902','66088','15136','83438','20114',
                          '89511','78313','13370','88850','23526',
                          '19013','40095','99685','99868','40941',
                          '35812','82020','96537','57016','35813',
                          '55776','73108','25832','22624','20243',
                          '72380','31490','25324','74963','43686',
                          '40159','91279','81278','75798','59913',
                          '21383','69582','22532','99186','77013',
                          '58071','59949','33629','65129','62067',
                          '16038','45336','94100','25307','48655',
                          '74395','55114','27709','98925','47260',
                          '71643','18679','11761','46598','79226',
                          '80924','57447','83646','32871','67574',
                          '65303','14975','55920','55244','31394',
                          '67996','17388','68037','77550','48690',
                          '21789','26482','62693','31097','61285',
                          '15157','43866','18827','54506','20411',
                          '55602','37513','93203','51244','14307',
                          '96584','19399','16469','57899','10048',
                          '39146','41793','14721','40228','11167',
                          '49490','10185','61801','81936','62902',
                          '74039','26174','71326','32348','86308',
                          '25768','79112','91011','96274','99740',
                          '13334','29999','10923','37125','85429',
                          '16758','55046','32147','77727','76753',
                          '84444','16509','90757','27429','49153',
                          '50581','12111','83411','73265','54785',
                          '17127','83073','68859','31226','50042',
                          '63722','25494','41973','51917','51878',
                          '48390','63352','35329','56178','84961',
                          '30100','22621','81113','70695','46483',
                          '70236','63021','85089','83573','95834',
                          '85792','68844','40605','84597','89709',
                          '42750','20709','79080','96414','13982',
                          '45697','92987','71158','98912','64174',
                          '79622','52545','48885','33280','74453',
                          '23629','31484','51948','31332','45484',
                          '15463','52677','20380','19860','37084',
                          '24052','34440','43633','68970','17716',
                          '83031','34179','35325','97450','56679',
                          '50956','80735','98090','90043','89821',
                          '22747','40854','38526','74447','59359',
                          '27260','80040','57609','13490','16680',
                          '18564','53454','64546','96376','78179',
                          '34605','84256','11431','74212','75203',
                          '92134','12153','96814','35153','21287',
                          '23855','33050','59941','64321','98623',
                          '37766','82506','22246','36854','15190',
                          '47635','88500','40680','37997','78686',
                          '38016','99640','41452','36625','14885',
                          '12874','66175','63071','76348','81973',
                          '36538','29986','30461','97780','88048',
                          '27453','31410','25418','73993','72022',
                          '83150','35510','31380','51337','50020',
                          '96978','90755','38394','95552','26297',
                          '84144','10322','78363','63227','28391',
                          '31036','14366','19299','30433','18792',
                          '77282','68628','68517','40332')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

