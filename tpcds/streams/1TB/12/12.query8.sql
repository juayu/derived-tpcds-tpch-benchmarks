-- start query 8 in stream 12 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '81690','69105','21558','39882','60871','50148',
                          '91566','26138','31963','46505','47451',
                          '90531','88877','44866','65250','97750',
                          '82157','49511','98259','87879','74888',
                          '47858','96940','48798','78493','68555',
                          '85041','12400','68538','11243','37413',
                          '15941','65417','29812','12317','98468',
                          '42804','86595','81340','83845','22448',
                          '67342','50124','25765','42651','58763',
                          '58340','98361','11480','22733','85031',
                          '26955','61426','20034','41771','55796',
                          '39585','39404','53684','58721','50338',
                          '27883','95212','53814','13281','68890',
                          '35291','28059','96841','94152','73025',
                          '33713','45559','72812','37234','28506',
                          '17579','85320','68916','66001','50460',
                          '66513','29509','19775','44532','41770',
                          '40754','18255','55981','67114','95994',
                          '61342','95089','82128','31101','30200',
                          '89996','22032','83536','96636','34326',
                          '59147','38962','87358','97273','19420',
                          '37295','55410','68361','37992','74132',
                          '81262','42754','36305','30447','38646',
                          '89385','98005','90914','21684','89799',
                          '55170','84325','38926','72037','29957',
                          '45917','95034','48247','41921','10114',
                          '60810','66846','24507','28572','25059',
                          '36901','86178','43272','69159','28400',
                          '19297','91649','57014','29259','49137',
                          '37451','33736','54089','68378','20731',
                          '48972','14179','22568','19581','78837',
                          '59293','83084','32097','49870','24100',
                          '10320','81568','25627','77181','53171',
                          '15837','19533','50706','93028','91685',
                          '52420','85525','45960','34532','62901',
                          '59371','76567','40384','64490','77587',
                          '36538','95073','73302','88590','82636',
                          '11930','89776','19151','50960','32475',
                          '22719','30813','15066','99622','45659',
                          '79190','85220','31635','12567','74363',
                          '26856','47295','97773','58164','39390',
                          '35211','71030','33534','67511','89562',
                          '77999','35941','59160','69857','49437',
                          '80208','77790','70854','86960','54763',
                          '13345','25496','28386','31076','42359',
                          '72564','28793','72960','20846','45176',
                          '49477','32225','62570','70563','18099',
                          '71128','15061','10276','25023','83864',
                          '29396','22981','34998','25782','58050',
                          '53540','36423','58987','17792','66201',
                          '79259','50696','26522','80065','38809',
                          '13776','38543','43787','57159','64347',
                          '13816','62852','78344','71335','95158',
                          '39293','40972','26062','91506','19073',
                          '39459','79302','20456','72876','15190',
                          '44513','80948','88586','75267','81111',
                          '84354','37753','51533','33740','35704',
                          '54145','25072','57633','29326','68698',
                          '99397','11124','48573','45604','41789',
                          '10106','56883','32020','77952','29970',
                          '45976','22423','21959','97885','18130',
                          '87545','14964','17563','19367','80883',
                          '76577','90241','79728','54328','76765',
                          '61193','69256','33175','23365','30866',
                          '32244','43841','38396','11592','82280',
                          '48012','40012','33711','50479','86984',
                          '98780','13964','77496','83554','89054',
                          '84901','54650','96420','84654','16479',
                          '54120','90813','34731','56328','39093',
                          '30295','51667','65074','15990','50950',
                          '92230','95184','94979','25576','72829',
                          '68691','52219','24419','30333','28320',
                          '76049','62521','50204','63303','73135',
                          '38270','73791','48500','78875','76024',
                          '29026','15230','82354','68168','21194',
                          '14594','61607','44004','35672','66043',
                          '20077','27143','96719','14322','24398',
                          '40009','83231','81840','14903','37370',
                          '30174','62639','43442','62912','99317',
                          '17088','94678','23539','86713')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

