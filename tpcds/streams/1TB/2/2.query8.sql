-- start query 8 in stream 2 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '53454','64109','91603','14988','87205','70406',
                          '63289','71130','30040','56282','51023',
                          '68143','28196','80889','40957','48321',
                          '18131','50596','84226','49293','26698',
                          '44862','88024','95755','79522','76852',
                          '69236','18689','76146','62082','29191',
                          '80263','17817','70079','66459','88803',
                          '24366','95450','53101','39346','26015',
                          '79229','68871','30021','74068','15732',
                          '13169','58987','20518','84371','37142',
                          '85851','54092','13353','93492','83388',
                          '62408','11306','30127','40794','34580',
                          '85990','67094','41980','87653','17886',
                          '98309','90895','42030','16048','20249',
                          '92963','96504','57417','36748','98373',
                          '66391','83440','63044','17948','48616',
                          '46355','96754','57852','69415','57652',
                          '23886','41813','61242','12723','17077',
                          '92765','96258','83800','33656','73286',
                          '63700','99537','78170','29885','25897',
                          '81161','68538','37178','12528','82478',
                          '56633','64389','84380','36720','43959',
                          '18041','14241','38050','88613','72421',
                          '69065','57627','76098','84267','87146',
                          '51981','99826','45816','32314','18546',
                          '45825','61784','91594','94413','40984',
                          '50378','22164','46819','57904','54802',
                          '72579','15221','12403','53819','23287',
                          '71036','59185','56394','64930','36567',
                          '62245','80060','65434','34098','49268',
                          '85405','40507','31011','24099','15578',
                          '46388','63687','80460','63115','39336',
                          '83402','71040','37629','58810','10629',
                          '52961','88573','88771','30557','74022',
                          '13108','75508','77802','33206','46210',
                          '30116','97434','37202','85442','90287',
                          '26997','88985','93772','19956','43022',
                          '89997','98637','57788','27320','15309',
                          '80376','69864','96644','99238','39162',
                          '80182','72540','49332','77580','17344',
                          '16634','26445','41967','86203','78515',
                          '29828','80966','56547','81191','38356',
                          '93750','93875','86325','94477','73907',
                          '65498','81742','54717','72626','44172',
                          '24023','55033','80837','91805','71779',
                          '78111','48591','26516','67905','80122',
                          '44186','64384','72988','60612','84382',
                          '45670','33010','71477','76149','41717',
                          '78889','81548','38237','71514','55742',
                          '68665','89452','93556','92601','92598',
                          '52765','95687','50071','85792','63613',
                          '68175','21030','91320','76181','14487',
                          '96456','79307','76191','56558','62782',
                          '12489','18424','83842','88690','17791',
                          '65515','52312','83146','42591','73297',
                          '89290','92654','94502','58119','74978',
                          '14301','91893','98862','78527','47150',
                          '57634','25632','53306','30371','99261',
                          '84182','17933','56686','13302','62173',
                          '80226','21477','28622','87253','93996',
                          '22350','17629','22859','84900','87963',
                          '18241','88071','94498','59157','21831',
                          '30691','84520','30641','37112','66051',
                          '13571','56793','19582','53681','37794',
                          '56669','45152','77749','42921','59299',
                          '17103','50652','23246','29642','88688',
                          '75868','97230','37734','47874','77936',
                          '45764','40801','11763','18473','95773',
                          '45190','44785','28536','68495','77231',
                          '88990','29276','23868','19777','80629',
                          '78533','83326','11199','54726','92690',
                          '75693','68783','78885','34635','85124',
                          '58052','42638','58935','44902','27959',
                          '53584','53829','30007','48585','64214',
                          '31642','49578','40156','71046','31805',
                          '50877','45604','57229','48856','58073',
                          '82916','32507','72553','10399','45679',
                          '11618','44759','92289','41202','57274',
                          '13322','17880','15520','57495','16425',
                          '27469','50880','99546','80020')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

