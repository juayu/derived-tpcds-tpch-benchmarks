-- start query 8 in stream 11 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '92761','75612','54105','16515','19524','82294',
                          '75174','92741','48939','85708','99706',
                          '66812','21919','37393','79153','87925',
                          '52298','33615','17010','48600','45846',
                          '87866','28932','55075','83284','77717',
                          '22155','41142','42529','41943','60128',
                          '37342','53272','49395','94783','37171',
                          '48221','59308','65098','61967','94655',
                          '72588','37977','89420','33103','76955',
                          '48145','90222','56198','79304','19450',
                          '11406','62422','19340','25817','32089',
                          '20223','89370','49214','27799','22605',
                          '51274','76093','22479','25149','67742',
                          '25653','64127','92720','15458','53857',
                          '58639','28940','32274','40492','70729',
                          '47390','80992','95076','72587','85138',
                          '12933','32762','77999','32081','22522',
                          '75484','54284','43784','92758','28446',
                          '95533','36297','63586','64368','95935',
                          '85179','44095','37993','31017','63872',
                          '40479','17581','58070','13072','55532',
                          '47990','31644','87004','72393','77809',
                          '30031','52429','88465','64007','58389',
                          '44242','99558','15491','75748','83959',
                          '71582','23071','78637','56369','46943',
                          '18783','57903','22894','43631','53341',
                          '63983','50803','33218','40101','65995',
                          '13629','62309','37278','97202','84327',
                          '51100','42990','58847','56810','27352',
                          '62157','23059','85210','30954','11951',
                          '56699','85616','33949','27812','62769',
                          '94615','95748','74644','61106','47958',
                          '92909','79097','58721','71723','40167',
                          '41304','24471','11935','53820','63961',
                          '65557','99821','47205','59178','48563',
                          '54278','91559','16567','38536','69552',
                          '15698','72356','55358','63384','71230',
                          '82844','26259','72858','73448','40070',
                          '37939','49751','98246','21493','23259',
                          '42883','90765','59670','51317','90568',
                          '24487','42116','79140','10028','31963',
                          '38011','26167','64300','92660','45589',
                          '52517','61992','40735','12049','99446',
                          '68359','78270','88374','83336','10198',
                          '47824','89549','98946','96838','48011',
                          '71383','90996','14694','15859','47814',
                          '26713','68876','17236','52673','76763',
                          '19126','30281','58675','69808','63427',
                          '82667','20447','90731','45159','84364',
                          '69774','23226','15082','69264','94124',
                          '21326','43607','80144','47475','25350',
                          '59879','26711','98331','46146','15784',
                          '72992','51133','57178','42649','25074',
                          '32858','74788','80528','21342','98390',
                          '83364','35516','54761','83755','51995',
                          '28185','47181','98319','16741','43515',
                          '50183','28490','74970','38030','45895',
                          '92444','11901','42114','54525','24419',
                          '33870','67729','53042','86581','76747',
                          '27591','67753','61332','75162','35128',
                          '64003','87017','63540','26722','71870',
                          '89519','63975','36489','59601','85388',
                          '82591','74121','80314','39312','62951',
                          '44521','92498','31409','77827','24280',
                          '87595','49594','64280','81324','86598',
                          '16485','27107','36515','39932','65122',
                          '72748','66593','84956','36420','40711',
                          '43601','37148','48236','27410','94320',
                          '95153','91817','41736','73303','68938',
                          '25429','20038','16873','58875','41837',
                          '72936','80239','49864','31867','51176',
                          '59324','82273','48718','33663','49180',
                          '37576','89938','14287','36797','40245',
                          '67958','87085','58784','92225','69922',
                          '78646','12898','58033','83492','53031',
                          '47385','34993','85812','88784','22695',
                          '99987','45239','64952','72051','11905',
                          '32840','17855','19522','26290','90080',
                          '47726','53368','92373','97133','31124',
                          '35236','59699','95564','46010')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

