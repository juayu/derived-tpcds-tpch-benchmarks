-- start query 8 in stream 6 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '84215','39895','53579','50883','18622','22569',
                          '11951','25599','78690','52649','44380',
                          '87897','12890','66988','71286','56553',
                          '53221','89323','49978','85343','81048',
                          '21895','94461','94509','25590','46791',
                          '78720','28766','89680','26976','56395',
                          '30412','25830','42137','34336','33417',
                          '67989','42895','91999','59247','36769',
                          '56462','40196','74676','68601','96297',
                          '93811','51354','55504','11251','77744',
                          '46442','74194','12370','58484','12230',
                          '72277','56948','35412','67963','77668',
                          '34830','66529','35559','39845','36891',
                          '93915','12197','95219','48586','72148',
                          '68433','52401','81315','20996','62920',
                          '55250','27581','43574','87338','82250',
                          '42778','98673','39836','74650','55671',
                          '82834','17262','78895','28141','79111',
                          '45953','14395','30363','59680','56013',
                          '33154','64554','44613','55841','79554',
                          '94379','36982','57128','85437','30996',
                          '52342','35875','71076','27911','22758',
                          '60339','65968','13750','69321','38228',
                          '31061','16479','69688','23135','95209',
                          '85781','21296','74207','25021','26844',
                          '64726','72237','38421','86905','26746',
                          '70663','93507','73705','45338','51248',
                          '51144','52523','57731','79760','51427',
                          '42705','29345','98357','73343','14533',
                          '24419','10728','31408','92874','62467',
                          '33230','81687','36350','92101','61208',
                          '23024','16186','91320','77272','84164',
                          '15951','50242','92952','20561','19937',
                          '19266','87671','62341','17293','72876',
                          '25739','53307','23176','89309','63769',
                          '76501','28489','74710','32213','40524',
                          '98209','22986','94296','59986','75416',
                          '43571','73734','25212','60757','57539',
                          '95625','27306','70661','51316','24023',
                          '16262','26397','53194','33652','10249',
                          '42268','60134','72418','37779','84415',
                          '93651','27614','61495','50822','53635',
                          '27741','16494','63950','17827','53293',
                          '32411','91266','85701','62292','61661',
                          '44167','86913','64748','50982','21297',
                          '98314','72965','79865','27257','50392',
                          '55573','94924','81966','35156','90862',
                          '75480','26646','27829','87886','18720',
                          '39468','97179','76577','67120','62870',
                          '21148','64433','62273','79945','21514',
                          '93606','17988','74034','26253','37778',
                          '58017','54358','50634','68415','77584',
                          '93021','40551','42635','60605','69639',
                          '35644','40994','75280','74666','90818',
                          '98976','23985','34323','20240','83813',
                          '67382','67098','41221','57831','94644',
                          '65743','66587','35629','78898','65475',
                          '55007','68036','59232','24716','63894',
                          '97642','25268','95977','13570','36417',
                          '46710','63942','54733','30518','14259',
                          '93984','80269','33993','18894','75991',
                          '63850','39531','76794','56589','92281',
                          '66178','13405','90525','92744','15239',
                          '86858','55235','62280','87177','37223',
                          '24636','85885','99281','19950','66115',
                          '35872','15638','85068','88056','33254',
                          '67472','99400','25630','22450','68276',
                          '69441','28945','15459','14879','52352',
                          '42720','29728','44235','18556','25181',
                          '26861','99812','65193','67524','64178',
                          '27680','10710','30446','87390','89079',
                          '32568','67225','80915','36944','64096',
                          '57867','94246','80385','74668','95899',
                          '92627','14204','70734','62001','35521',
                          '34193','67733','52704','27555','28940',
                          '44025','97009','77355','99061','72288',
                          '82093','76042','53543','70225','56520',
                          '60099','27880','11216','50874','63150',
                          '77858','43408','49596','46918','42026',
                          '98618','71592','58101','80226')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

