-- start query 8 in stream 18 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '78769','76389','31900','73989','25550','26212',
                          '98814','73639','59988','27809','99487',
                          '93211','33473','66722','80126','86741',
                          '47773','73524','93075','28342','27076',
                          '62316','52460','35205','95195','63272',
                          '79375','36953','99453','28467','11724',
                          '39620','20859','30272','34246','48352',
                          '59474','75422','89469','84323','44860',
                          '53570','32940','85407','63654','85507',
                          '31983','71789','22505','26610','72653',
                          '33733','45015','12214','54388','99910',
                          '46181','47478','37939','40061','75265',
                          '23091','52719','26545','55184','66824',
                          '40539','31717','28871','94772','29023',
                          '53394','48721','52532','16241','65337',
                          '71198','80868','14449','66238','75832',
                          '43128','50041','19104','97382','90278',
                          '58684','17780','30723','13914','78795',
                          '53197','52979','27677','51320','15165',
                          '63962','25257','81833','50974','36266',
                          '90448','46959','59220','70919','15664',
                          '65374','13312','75804','52879','64116',
                          '72334','91331','58900','14932','75119',
                          '57592','75566','70846','44902','33067',
                          '73703','57030','80726','64991','49433',
                          '94979','54219','75366','62208','89891',
                          '52392','27767','79017','32816','76848',
                          '15609','91664','48154','61328','78538',
                          '78324','13759','67054','20194','67443',
                          '48501','66060','46196','61281','78894',
                          '46235','49015','31265','20819','55121',
                          '18290','94141','73131','51541','93758',
                          '15820','72710','32841','31275','46795',
                          '14056','17182','48248','82001','88747',
                          '74797','73521','72684','26257','39307',
                          '64815','73101','35320','64121','39536',
                          '83307','88363','33980','82851','54709',
                          '84281','29196','52906','44337','63199',
                          '87306','93841','49378','62495','17937',
                          '44749','92978','79945','46990','66125',
                          '13575','72299','29352','39342','39893',
                          '81971','70177','87209','39790','83099',
                          '66413','47603','72680','41813','86856',
                          '76990','48032','40428','96391','27126',
                          '48244','54721','59566','44912','62942',
                          '33912','55004','95601','72577','13267',
                          '82511','38718','95759','32529','15724',
                          '71784','32266','85842','34109','41220',
                          '82371','92490','95298','32577','61340',
                          '30671','75498','34560','69761','99334',
                          '18660','77690','77194','89930','90389',
                          '14141','58497','68475','51920','51376',
                          '61443','87319','24882','51666','70549',
                          '95659','94567','43664','96490','24986',
                          '66813','31769','73713','20034','72728',
                          '74724','83944','22943','24781','35726',
                          '34398','67650','93011','69884','60670',
                          '57578','64291','81881','38549','90235',
                          '63433','53964','57766','87449','66053',
                          '78625','32425','87317','68902','12812',
                          '64618','62053','50923','93862','91909',
                          '56093','72213','92055','66225','61910',
                          '91484','35159','67069','44782','36553',
                          '52761','19405','68335','72695','94930',
                          '55027','52649','57909','18598','75316',
                          '28780','82210','28429','48399','14539',
                          '28071','75865','10808','15176','65485',
                          '85452','59382','29011','84575','69567',
                          '19178','67828','14956','48653','93925',
                          '50887','77614','78088','92639','80191',
                          '62704','83120','51132','20759','14750',
                          '77180','91305','72369','41817','24833',
                          '19317','94512','13615','23868','85224',
                          '78884','21068','65537','29439','79310',
                          '55062','82219','43142','78491','52504',
                          '51644','21155','77687','17280','95620',
                          '63005','71817','65196','12096','83631',
                          '71554','25714','88374','73687','17652',
                          '11131','61398','38489','59297','63203',
                          '41494','90127','97897','58358')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

