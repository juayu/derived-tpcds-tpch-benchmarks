-- start query 8 in stream 19 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '86986','69437','84450','18393','86835','43848',
                          '58673','36757','44143','17989','75792',
                          '33291','63785','36909','95671','40432',
                          '12529','19513','99537','50448','90729',
                          '97647','95371','75630','27994','53050',
                          '41338','91582','66896','17494','28101',
                          '77605','69018','60893','43762','87988',
                          '19350','55250','60497','75478','16953',
                          '12586','26610','56180','23531','66386',
                          '76570','57611','73424','44035','97992',
                          '31187','70002','11222','19115','75032',
                          '59246','71466','80411','17066','26573',
                          '60293','67372','20127','72390','38097',
                          '96392','87423','14052','24766','78957',
                          '66757','96485','35687','58141','99426',
                          '18531','14597','13828','67487','97367',
                          '17483','97241','45528','56278','37037',
                          '23188','98107','92465','34445','15683',
                          '49125','85207','56662','30478','60641',
                          '96823','46793','54739','16347','70249',
                          '29333','22863','66444','16195','15377',
                          '13898','51890','65594','59051','55395',
                          '58348','16896','31357','57312','76454',
                          '48608','16109','45391','35508','29575',
                          '18846','71652','97720','78073','93887',
                          '14020','85717','29755','11541','24605',
                          '27231','15966','11198','57410','79221',
                          '87671','72772','66815','75161','76716',
                          '82148','59733','43120','52423','68979',
                          '12479','16265','20613','69702','77634',
                          '75388','79540','33187','17526','29330',
                          '65255','32578','69277','37971','80287',
                          '59018','21232','65368','81589','45412',
                          '49400','38742','47627','85612','56624',
                          '75653','97178','14041','62732','87507',
                          '27494','95188','43557','78780','54883',
                          '40099','33670','12470','95820','47275',
                          '33802','66861','71599','63286','84022',
                          '34104','14803','29159','77214','37557',
                          '73967','86080','84157','95478','71576',
                          '79907','77442','71276','48418','22029',
                          '94769','65087','97219','79348','91164',
                          '37489','79916','26114','10974','75723',
                          '63555','13028','28598','26100','76943',
                          '74845','80070','64269','31587','27369',
                          '64731','29902','31208','20782','15136',
                          '61403','68673','37774','86302','59222',
                          '99327','58999','70592','26578','66331',
                          '39612','54300','69849','73672','45242',
                          '66109','26739','71495','32156','92892',
                          '24442','88101','29106','23793','20677',
                          '30594','22886','90232','19784','83593',
                          '78845','26063','44020','59571','10263',
                          '28843','59697','72900','53995','44837',
                          '74773','74277','92956','55099','37752',
                          '43256','68695','53157','29053','55606',
                          '40526','70363','59872','68385','46053',
                          '54340','42112','52650','76998','12209',
                          '23305','56266','58143','35897','53291',
                          '34190','39074','22381','42231','93595',
                          '11050','57021','49860','18624','94495',
                          '99126','61148','43017','88975','41122',
                          '48904','49365','87901','54023','52144',
                          '99982','85016','52174','84406','74535',
                          '39479','95218','99444','41730','64479',
                          '78103','16106','98542','83553','45639',
                          '74738','20932','37074','81816','40975',
                          '93350','26090','64627','23241','41228',
                          '63054','48477','90426','86489','26060',
                          '93150','33582','96683','59846','76416',
                          '44050','82952','58176','33113','48798',
                          '96692','22844','27515','90471','75753',
                          '82220','47610','96755','52198','99674',
                          '83755','59632','79177','50779','53545',
                          '56963','30105','65752','58027','81933',
                          '77283','87945','77362','32508','81087',
                          '20559','34619','94696','62622','85353',
                          '87930','95709','22630','28216','99475',
                          '22165','34176','10844','71673','99150',
                          '82326','95485','16854','23805')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

