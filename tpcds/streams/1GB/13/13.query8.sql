-- start query 8 in stream 13 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '85560','20694','79358','70548','22628','10501',
                          '15091','73499','18384','35555','92244',
                          '36044','77174','13597','54261','11079',
                          '94555','15569','86115','96988','49616',
                          '16186','81656','69800','34244','47697',
                          '24811','51090','52206','41483','61082',
                          '68006','78968','34664','54464','73129',
                          '35686','57645','20131','38896','51071',
                          '75648','53813','48980','26867','94599',
                          '60916','38559','17007','46859','98661',
                          '13037','58191','73908','35683','74936',
                          '55038','55549','80847','19422','55566',
                          '44032','24524','29054','90568','24751',
                          '90579','22235','51314','33517','55168',
                          '84687','58337','87612','77049','69089',
                          '83279','45498','64215','72348','60254',
                          '39463','93926','91515','40680','90489',
                          '25822','21216','12574','68350','84887',
                          '61511','24058','66120','76307','91440',
                          '82825','18712','39577','83646','72444',
                          '65109','61431','95644','79093','87667',
                          '59810','53679','91818','15691','36073',
                          '74115','21431','97146','84923','29958',
                          '29520','85180','51702','76625','13489',
                          '54443','20467','41923','45553','25898',
                          '88502','60460','28584','84237','52410',
                          '53499','75056','57174','95791','60941',
                          '89580','69521','47146','32672','11806',
                          '56379','79180','96085','30113','31258',
                          '73895','63431','90580','92733','72759',
                          '40485','46366','19244','77790','82854',
                          '43055','45311','77884','38173','80564',
                          '74424','55965','55562','63967','72931',
                          '58485','20310','25036','74965','82745',
                          '33845','65930','68162','56419','42696',
                          '27468','89347','33987','56644','50007',
                          '66180','84895','39924','56050','63505',
                          '66824','22585','54263','19645','27616',
                          '66279','52569','61705','17057','80572',
                          '52621','73656','76862','10968','33986',
                          '68868','46138','59348','33767','35308',
                          '74518','57020','17862','74680','46646',
                          '35418','18116','71678','38348','31735',
                          '29453','86904','22898','26228','58249',
                          '53782','10758','93215','64972','39227',
                          '30397','78971','29019','43079','47141',
                          '25153','13722','90691','51311','85860',
                          '66778','96651','79941','34697','78064',
                          '43314','71107','74953','29660','60384',
                          '36765','26141','92986','40675','42388',
                          '81760','60892','83141','19748','42999',
                          '80791','63045','34448','64343','45401',
                          '54823','92445','32234','76789','71114',
                          '17686','70365','30201','76963','69065',
                          '39288','53555','98549','89942','60523',
                          '63736','15786','21853','87051','22625',
                          '99575','38251','43576','42580','29470',
                          '66379','34034','22538','76078','68684',
                          '72137','18474','13341','74891','59213',
                          '97246','75971','89450','29230','77205',
                          '36240','38562','87295','65583','96722',
                          '26767','34364','40330','88167','47447',
                          '34823','69443','83378','55771','97245',
                          '40725','34709','34388','34057','30061',
                          '22409','38177','28631','99738','21653',
                          '39894','63524','94590','55203','41331',
                          '20774','83753','88264','92865','34846',
                          '40632','44346','83415','59318','64709',
                          '84070','54784','44600','62445','98349',
                          '76166','74946','18118','65577','98716',
                          '37290','91169','66528','85477','56145',
                          '35143','48112','23382','52231','68277',
                          '93911','45223','19930','27970','95717',
                          '64092','97794','14042','45903','50024',
                          '17532','38061','33510','66124','72545',
                          '54137','55959','78137','91424','15194',
                          '49056','14373','90026','26956','46224',
                          '33766','10164','88429','72217','89865',
                          '10294','21909','17755','55554','57669',
                          '65616','30887','54493','96432')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

