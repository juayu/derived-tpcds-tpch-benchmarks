-- start query 8 in stream 7 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '14424','28306','20191','98094','78470','74167',
                          '91397','75758','28324','83392','62149',
                          '24454','68207','62082','25945','30608',
                          '17597','66599','45680','30975','93633',
                          '30347','90897','61953','16855','60268',
                          '44798','47543','57333','67508','84943',
                          '50936','98746','82184','96034','97391',
                          '29760','70752','13008','66467','51597',
                          '10548','79660','49319','69145','69883',
                          '20878','89574','82850','21583','16979',
                          '76375','43871','34596','90783','98279',
                          '22189','71448','65014','34294','84035',
                          '51869','93230','64340','51422','87819',
                          '42726','41566','46627','66690','40687',
                          '62811','70745','52223','48356','18455',
                          '43811','23807','15384','20776','72372',
                          '58827','90618','51999','62395','83483',
                          '36601','24860','11327','75736','57507',
                          '22854','14856','88893','44058','10609',
                          '82671','97544','84160','11944','81750',
                          '40054','17942','94414','90698','74841',
                          '39785','38695','55303','12003','14160',
                          '43041','94211','39704','63202','73811',
                          '15087','98834','67436','44439','70319',
                          '85821','30102','33020','87915','81251',
                          '50635','21872','62943','72514','37875',
                          '69964','47959','44877','66811','17916',
                          '34418','13033','96907','92135','55612',
                          '26474','18954','46898','24517','16211',
                          '58044','93331','62402','91982','70755',
                          '63131','42738','13492','40139','77786',
                          '28411','86629','56439','23314','97309',
                          '27036','58956','96357','73373','39525',
                          '12538','89241','75924','99866','65337',
                          '67287','17915','42490','30957','30187',
                          '81266','42474','96957','71965','99251',
                          '13766','42577','59227','90876','21484',
                          '97210','61363','76923','64169','83242',
                          '68472','19414','17157','77045','74337',
                          '96307','57402','89584','26670','33784',
                          '54003','38931','53566','68882','42105',
                          '27703','26937','68138','79971','79884',
                          '42249','65712','81201','33529','80214',
                          '13891','43412','13436','98405','10237',
                          '63000','60822','25726','66699','93174',
                          '57101','17243','86195','10037','48107',
                          '89764','39169','76960','26884','91460',
                          '59191','63352','55946','96446','50245',
                          '57310','44279','89073','19699','38546',
                          '72515','46290','65159','66234','43567',
                          '26509','49827','52020','88576','32035',
                          '93028','53629','89055','11680','22309',
                          '77004','63653','33907','35326','29693',
                          '60850','53627','36893','22929','41473',
                          '56670','39526','44381','66100','10179',
                          '69594','27782','62140','28282','42180',
                          '85210','85180','97227','44881','19544',
                          '63829','95740','72243','10566','97466',
                          '88763','33952','56530','61572','30244',
                          '62103','15041','81698','78658','75043',
                          '11289','48940','82034','51830','39764',
                          '33394','68437','15844','96606','39097',
                          '14855','32213','45818','18595','32885',
                          '16000','12360','72319','42820','69760',
                          '80514','82739','63539','29287','47861',
                          '27496','91302','10026','24905','22113',
                          '88617','57714','30316','51747','96915',
                          '14289','59628','77310','94279','24177',
                          '95326','32310','79156','77447','21464',
                          '41508','10945','36137','94292','64991',
                          '80723','66381','34388','31930','26539',
                          '56537','60006','98033','38557','74630',
                          '98433','90020','13117','63107','91297',
                          '36249','96696','10081','35517','75000',
                          '57193','60685','16446','47017','19426',
                          '95156','27516','58499','70648','71770',
                          '83836','74415','34368','14651','55393',
                          '18802','14895','99503','82790','70250',
                          '86922','24381','65072','53025','24396',
                          '54334','94307','41452','99384')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

