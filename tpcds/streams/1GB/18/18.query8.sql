-- start query 8 in stream 18 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '72787','75740','52661','68830','56236','30525',
                          '68027','99391','40842','96009','84448',
                          '95307','77348','93936','16335','67788',
                          '49478','51682','58347','70532','87176',
                          '59104','55148','96490','75295','79134',
                          '85498','36932','48363','89323','60149',
                          '48678','80245','25981','54572','67459',
                          '63481','49574','27569','33022','68623',
                          '99008','33109','55681','52777','44781',
                          '55615','37040','58018','29587','20550',
                          '35131','57266','77973','43136','95521',
                          '11945','30224','29075','27527','22259',
                          '76268','76348','31095','51630','13095',
                          '32241','70705','66702','71245','54424',
                          '39422','15746','73861','98788','87370',
                          '96577','16724','43200','72246','95759',
                          '23357','88252','30259','22519','25678',
                          '73377','35101','51288','43624','75956',
                          '98802','26792','72716','33711','24975',
                          '90917','42668','18299','11098','24670',
                          '57197','94995','87483','90053','75603',
                          '37039','14407','20394','66868','87380',
                          '39529','36007','56172','12818','77609',
                          '57728','29217','22130','65960','27229',
                          '37995','17765','47290','40722','39659',
                          '70760','48267','55414','75377','46397',
                          '14987','51061','55106','12128','31247',
                          '85796','91642','83502','22359','50806',
                          '91006','49848','98858','17777','56053',
                          '10592','20853','51236','12292','65731',
                          '78330','42644','70798','57862','16301',
                          '73625','64703','77108','31390','88174',
                          '40080','44845','14431','90054','41996',
                          '86554','92013','20091','65734','63737',
                          '65352','79173','52736','26133','43298',
                          '78026','42706','59335','13593','13551',
                          '87889','72667','86209','44984','45836',
                          '32319','97543','27830','53792','53490',
                          '77039','92097','47812','45447','23001',
                          '53298','34008','98246','18047','11590',
                          '18660','82305','77615','42795','97262',
                          '10739','70692','59361','26815','87787',
                          '96337','70617','14313','69287','75963',
                          '74879','62500','57925','50698','38154',
                          '26513','49970','79915','71092','36307',
                          '33472','71920','48574','62120','20543',
                          '16667','79123','56025','82742','59641',
                          '22692','89385','53184','90325','86865',
                          '45290','80149','87895','59680','12594',
                          '78354','96129','39895','14446','19141',
                          '98657','94964','23103','41987','11061',
                          '55573','67107','35715','45385','60363',
                          '59635','43514','90351','57646','75443',
                          '88773','82571','96905','83898','89533',
                          '13067','65175','69124','14099','72593',
                          '66091','17079','51825','41247','31994',
                          '97362','37749','90263','25489','64983',
                          '30196','25640','32294','83888','18986',
                          '66225','58448','68048','37102','19461',
                          '29034','15968','60491','60751','98374',
                          '72972','27112','99302','79045','95164',
                          '57725','49347','31282','80865','69567',
                          '38218','69659','77887','99438','94992',
                          '41739','93521','17311','80383','11560',
                          '52958','24346','69368','65471','94303',
                          '13416','51239','20637','68347','50080',
                          '96058','91800','87801','93969','61447',
                          '41384','18515','15036','65475','22411',
                          '42013','79023','32471','43391','13158',
                          '84527','90219','42934','50232','23714',
                          '27662','56814','42440','44161','38165',
                          '60628','14887','97907','71788','98360',
                          '61066','79206','59256','72682','97259',
                          '24887','93755','60779','10300','90751',
                          '85182','18957','70000','73248','82889',
                          '11691','20985','71375','23791','78307',
                          '44188','30888','73856','78435','23624',
                          '57143','62720','66061','39897','11862',
                          '43393','40209','63715','38241','70057',
                          '52779','22438','79580','35588')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

