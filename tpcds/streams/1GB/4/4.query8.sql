-- start query 8 in stream 4 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '61369','48653','11347','59953','64375','41862',
                          '91523','68136','54704','14646','54769',
                          '81356','13462','83726','38909','72322',
                          '58817','63736','97989','96635','78765',
                          '22501','25007','83897','99482','24084',
                          '80982','47392','50340','14223','90215',
                          '26940','67648','32042','72389','10980',
                          '79337','45325','57300','50685','88764',
                          '54097','28965','53367','66597','78460',
                          '68869','27529','33253','17305','69829',
                          '27379','57403','46614','75310','98770',
                          '79095','32502','47927','86259','42472',
                          '62362','57246','23163','57516','95688',
                          '20815','27778','48231','78025','14930',
                          '95346','65976','83867','97640','80105',
                          '37831','68255','80092','40920','12962',
                          '62937','59920','91927','72066','69620',
                          '10840','59101','43168','13909','53249',
                          '17218','72186','33631','38530','37366',
                          '19979','79344','97507','73373','53602',
                          '47633','43616','88489','81557','43668',
                          '53953','60510','72183','41181','71655',
                          '34485','32844','25911','21165','91342',
                          '95524','51574','90391','85449','37667',
                          '16771','67958','73017','32461','33669',
                          '19149','72466','35246','11766','84669',
                          '63476','93708','23206','78581','78603',
                          '37758','18829','56779','79529','46194',
                          '74093','24181','31111','60371','17844',
                          '25825','71637','48451','36571','68800',
                          '18706','34007','43120','15372','47009',
                          '81619','60846','64065','36294','26759',
                          '98553','98500','97709','90674','36742',
                          '44857','11685','41007','32986','51271',
                          '99942','71994','91416','70748','26042',
                          '24427','18705','88229','73624','43243',
                          '22259','52937','13010','54175','78291',
                          '64308','95611','83986','18775','97478',
                          '87543','98822','68885','87231','16841',
                          '16412','36577','77239','77761','15645',
                          '48778','91540','99308','45423','14041',
                          '62443','69100','52941','41331','81928',
                          '92694','38754','10879','22709','50878',
                          '49264','34486','26692','87127','27740',
                          '43892','21820','79919','30580','53369',
                          '62303','10917','88141','71035','59891',
                          '50581','90943','38314','83472','16699',
                          '10522','54420','18038','93391','24572',
                          '43557','75155','77795','20847','17887',
                          '54296','41704','92961','80075','55611',
                          '22706','83797','84162','14237','60728',
                          '95979','62893','74694','70299','71736',
                          '61166','57253','65992','86303','77597',
                          '90928','44096','86292','96072','28077',
                          '87373','39487','74776','22630','92101',
                          '86284','75262','94608','18659','11085',
                          '43049','62804','90421','89830','13066',
                          '49371','18431','88617','23638','49057',
                          '31302','76600','25727','40979','65392',
                          '63873','72281','63874','85351','71979',
                          '96784','77817','17171','46632','68778',
                          '91893','16401','48202','19523','50561',
                          '74516','67998','83320','94934','36883',
                          '12995','36633','22697','88691','20206',
                          '28087','52720','74558','65315','40568',
                          '92140','35027','70265','74504','79870',
                          '11321','28663','25105','37942','49100',
                          '85710','60479','80784','83333','28360',
                          '28092','72348','24932','14645','41754',
                          '42615','74988','60906','42922','68013',
                          '58808','84873','92076','67096','69983',
                          '64818','62985','59043','97684','80502',
                          '45950','26265','55823','15798','61599',
                          '19090','35433','68572','97169','32683',
                          '18502','30465','58457','44542','39988',
                          '15279','15188','16890','40815','78861',
                          '41554','46369','22441','40736','18223',
                          '40008','35182','37917','71709','69751',
                          '38933','24474','11875','57474','68817',
                          '55849','50376','92249','78888')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

