-- start query 8 in stream 12 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '49361','74127','72626','76276','62204','54706',
                          '19515','11032','62891','57903','16473',
                          '67541','96244','68468','17368','91998',
                          '34269','20536','54492','84737','51870',
                          '89084','78950','29310','88813','90975',
                          '30169','15991','16345','80530','85256',
                          '28274','87898','39438','89582','86143',
                          '36663','51703','88057','25186','75725',
                          '54272','79590','49677','58991','26189',
                          '90485','98473','36675','80212','92374',
                          '59105','90442','27742','20329','61853',
                          '26432','50356','50679','44839','28718',
                          '21659','16384','44849','17350','43548',
                          '77299','76859','87205','28601','33667',
                          '43649','84231','14135','79260','17238',
                          '90410','70461','65219','57289','88409',
                          '72464','76985','23640','42266','77146',
                          '22360','31819','64209','97466','24593',
                          '45322','12182','40137','34247','71297',
                          '67519','41477','23128','66113','20249',
                          '23599','62416','57155','53188','50271',
                          '32950','98686','26982','18044','89516',
                          '21004','71468','81792','32333','23105',
                          '19654','22476','90222','15810','55220',
                          '26981','96766','55721','42788','63362',
                          '30702','75683','16057','68027','34326',
                          '22541','67425','61692','97862','32894',
                          '98347','72556','82313','52915','95132',
                          '73556','44604','38205','47674','54268',
                          '52566','34089','44698','48863','12391',
                          '75997','10514','26966','80352','32882',
                          '63134','40930','57108','11298','20307',
                          '17803','67916','36500','88219','19433',
                          '20839','58993','21959','46217','59951',
                          '39475','57539','22163','30044','97746',
                          '32508','63513','13031','99973','24520',
                          '98072','78797','62363','28595','65585',
                          '32261','35831','68918','75951','60735',
                          '11943','70664','86391','46147','66885',
                          '28377','13192','67107','46653','66799',
                          '80572','86246','77810','81902','53729',
                          '44706','67288','61174','40544','99340',
                          '99247','58205','13321','96771','98545',
                          '30361','92530','67025','35383','31844',
                          '25283','33702','50481','35573','17198',
                          '67540','26574','48515','30476','39285',
                          '51431','98099','50164','73622','21376',
                          '77515','93824','70040','78172','23088',
                          '19817','13561','82433','13119','88552',
                          '76892','41668','43039','70506','59998',
                          '57367','71740','84186','76365','67597',
                          '55015','86889','15432','32642','12265',
                          '87055','22655','57347','87476','91888',
                          '32624','49900','85562','13142','34366',
                          '87560','63223','45566','72727','32978',
                          '97659','74778','26365','91910','84262',
                          '53743','77792','42415','55808','35946',
                          '15152','93354','94365','52845','10132',
                          '53661','95233','74352','94404','93628',
                          '29197','49442','14170','13073','57413',
                          '92765','14293','35996','65081','89512',
                          '94310','51201','43244','54958','55435',
                          '10640','11078','20552','64507','21042',
                          '78384','39091','63787','37015','18162',
                          '11379','34823','30383','21387','84765',
                          '36984','51989','52843','49957','12211',
                          '68650','59605','92794','52675','27786',
                          '87275','49716','76521','68456','51796',
                          '53693','89703','29150','50965','39485',
                          '91446','76060','60372','60054','21640',
                          '12137','36353','99742','44591','12082',
                          '69191','75391','38545','54366','29852',
                          '14605','26347','59995','38216','76645',
                          '36656','54395','26424','16222','27269',
                          '41958','84624','60997','80284','48460',
                          '94121','71521','88476','87701','61523',
                          '85031','46067','60277','88739','77311',
                          '48471','87390','24856','53978','28716',
                          '69226','48980','85165','23852','40770',
                          '74988','84307','49496','97859')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

