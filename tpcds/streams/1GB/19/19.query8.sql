-- start query 8 in stream 19 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '60671','12993','71490','40646','25065','44561',
                          '26146','50287','69979','68242','69832',
                          '43227','93149','91181','82558','24316',
                          '46862','20339','58376','10991','94713',
                          '99215','38139','85325','63696','90055',
                          '99088','39407','26851','93647','67249',
                          '98224','17175','63033','80170','76589',
                          '70396','27517','12406','79847','86194',
                          '89083','25694','19936','64011','94295',
                          '40771','30892','29557','34204','91590',
                          '89510','91081','23832','11362','58790',
                          '16759','65098','58492','69554','42188',
                          '48636','33451','88927','25150','68054',
                          '68205','73082','68401','71274','98701',
                          '69039','34596','84836','63149','54773',
                          '87710','11582','66570','32030','72846',
                          '99016','23155','32417','14130','85076',
                          '34422','92440','59700','97855','40235',
                          '28955','96691','55703','96089','83478',
                          '92477','49328','11737','89897','82590',
                          '10886','42406','17578','94948','14156',
                          '30970','37108','34396','67871','22003',
                          '73602','64660','16487','94432','30439',
                          '48046','59706','76106','58022','80837',
                          '59669','22887','52472','85816','94338',
                          '75430','72486','65727','38631','65800',
                          '36032','94754','59274','65664','12629',
                          '78896','24745','24815','82600','73424',
                          '26684','56440','52577','65750','87336',
                          '44794','82889','78803','27107','58336',
                          '81771','31448','11513','82591','80676',
                          '90814','24448','69466','81606','62182',
                          '54757','18959','66668','99575','57406',
                          '20175','74157','10946','73069','99719',
                          '50653','37855','54891','17953','37899',
                          '27016','77941','22132','54105','90764',
                          '41824','38121','60633','74616','47008',
                          '28086','27203','59392','43213','25792',
                          '12746','77589','85974','40288','26232',
                          '53132','40759','46418','51087','99272',
                          '58001','73632','49151','79343','50894',
                          '50379','95920','53266','28713','83171',
                          '46137','22163','57335','54714','22719',
                          '55139','46040','11332','60806','96447',
                          '34051','78453','63133','19602','51137',
                          '81982','93973','56796','49228','85347',
                          '64068','45101','79600','60963','78868',
                          '90109','50767','33458','48054','70207',
                          '91317','46228','71078','74017','38765',
                          '99518','28312','87172','73311','16055',
                          '69343','43817','94403','51073','85100',
                          '48884','39239','96010','77893','19688',
                          '12807','31477','48504','52806','44432',
                          '42552','23734','10384','69112','97204',
                          '80648','28283','14649','93563','70664',
                          '28094','55182','34742','61082','48982',
                          '83507','91226','51135','27865','80032',
                          '96103','29755','56316','51674','20075',
                          '74680','52522','67418','41193','95569',
                          '79231','21343','67129','68434','71622',
                          '46716','98563','56074','83170','64347',
                          '37548','38374','42449','27479','71012',
                          '69234','42567','73779','96060','97220',
                          '32116','86442','40544','42990','17930',
                          '55399','73187','84618','80800','54022',
                          '73737','51044','15782','85421','61054',
                          '70969','17782','78275','90688','21265',
                          '75298','40180','44787','24603','56559',
                          '74620','73645','76728','95008','43221',
                          '21669','26142','94769','18859','25892',
                          '35049','40036','21258','34037','92938',
                          '97155','76495','56133','52093','45593',
                          '82541','71833','28045','15735','94328',
                          '92525','85575','14581','73385','51248',
                          '66722','53797','34393','32874','41055',
                          '31565','80195','94173','54046','83011',
                          '83519','69743','28776','78835','75586',
                          '60312','53646','75962','30868','52130',
                          '22472','80143','47388','95030','29882',
                          '60152','97943','35359','91907')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

