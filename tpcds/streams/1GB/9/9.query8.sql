-- start query 8 in stream 9 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '68457','54821','79530','18148','69032','63410',
                          '24556','39523','78476','43374','49862',
                          '34789','99450','30540','10865','26567',
                          '81606','32669','40510','24380','67405',
                          '69183','38826','73138','59068','18765',
                          '94181','55749','82154','60229','62506',
                          '50543','30015','24631','59794','11677',
                          '36425','64252','91484','89754','40981',
                          '32173','99877','91351','79133','85364',
                          '13807','99122','56950','93177','37020',
                          '36900','71007','79775','40632','95367',
                          '89471','81006','18833','80118','17212',
                          '42688','42003','77114','75624','21839',
                          '45005','50129','47562','83656','22735',
                          '44882','20822','38666','48844','88581',
                          '13691','37674','75431','21728','47559',
                          '78667','62734','19969','40598','53628',
                          '96059','18454','34801','34740','39402',
                          '58636','12828','73344','18838','54760',
                          '27727','29969','86019','32852','58729',
                          '73677','61691','72222','32281','65254',
                          '75434','56636','42055','64223','85729',
                          '47098','49149','87556','29079','78346',
                          '75973','76852','22259','72965','54371',
                          '53299','87432','31543','56902','52037',
                          '60598','50156','49779','34194','10288',
                          '81192','48649','10991','62025','55498',
                          '12238','23507','71906','10783','76367',
                          '98296','71903','31071','28275','18889',
                          '73259','85237','57859','18906','89447',
                          '95508','28021','45770','41262','83677',
                          '53959','70193','33142','82843','37028',
                          '70587','64203','83393','66331','63507',
                          '84162','14532','88237','59779','38110',
                          '45451','27079','89177','33802','21968',
                          '92993','59891','41800','48299','76904',
                          '52234','26322','52062','41018','95206',
                          '93737','69572','91690','14849','84666',
                          '48468','78577','58987','87785','51773',
                          '50237','96298','26225','55795','63763',
                          '86689','20834','84679','20509','47861',
                          '46241','76083','68338','27076','94681',
                          '80362','41064','89380','34953','34639',
                          '80873','93563','37402','81038','28593',
                          '88609','74231','56889','40890','16086',
                          '10398','49172','83654','43395','82053',
                          '92483','51254','38855','66258','77451',
                          '54831','33707','20624','10131','74744',
                          '92774','12961','67039','40318','21879',
                          '43808','70822','67806','71334','26317',
                          '14454','57066','94147','77076','14664',
                          '71831','53759','77815','62900','94360',
                          '19628','74523','51343','41715','54838',
                          '31174','97650','45462','71567','64095',
                          '98518','72428','89160','87649','12481',
                          '54468','58017','71966','71601','32672',
                          '53962','33740','86294','57894','58909',
                          '72023','25867','70599','34096','57307',
                          '22331','14278','69871','59558','15442',
                          '24211','66652','69410','44423','34959',
                          '40428','15788','17278','90719','84418',
                          '13535','42354','23169','94931','47528',
                          '59790','20144','60936','96139','89421',
                          '21388','52453','20337','54489','99471',
                          '70799','62218','96491','27373','22633',
                          '87713','80768','56523','30369','35166',
                          '87444','94090','87602','92962','51560',
                          '20454','15896','90338','53179','67698',
                          '37917','98112','11956','39000','58674',
                          '26259','76443','66683','10424','61960',
                          '40610','61833','72844','44709','70422',
                          '17078','33742','19588','38728','85014',
                          '25995','15949','12777','91310','67839',
                          '85590','57976','26109','85400','54850',
                          '58964','79424','73055','83364','21328',
                          '47140','26414','12127','36025','77762',
                          '23381','86543','81148','91710','77385',
                          '10372','38232','48334','96419','50957',
                          '91020','28853','42618','65019','83292',
                          '75701','58787','87521','79823')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

