-- start query 8 in stream 1 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '65882','77399','82641','50796','83513','43790',
                          '97171','71243','83385','61904','58455',
                          '24272','69816','78348','19849','19362',
                          '66394','41435','57962','19050','63203',
                          '54068','20770','59266','53168','63943',
                          '50166','48882','77814','40462','24872',
                          '24476','33990','78995','21883','64541',
                          '13307','65711','85467','76993','61630',
                          '55084','15177','53408','58090','47597',
                          '14943','17806','59260','83001','23686',
                          '56759','12064','70772','18653','32772',
                          '63858','81605','94402','72314','27367',
                          '24315','67720','37033','76360','59516',
                          '52723','29605','89568','30364','78553',
                          '13470','74369','27878','86102','88481',
                          '78068','34163','30805','27849','74903',
                          '35605','22069','97161','15200','11618',
                          '21420','19738','26648','68319','86426',
                          '72829','85462','54070','64241','12960',
                          '75331','35379','39960','77904','13729',
                          '33224','92393','32448','16630','49337',
                          '79378','93837','51746','95046','21594',
                          '29893','80541','32554','60842','14598',
                          '70029','13541','71909','49051','30889',
                          '71757','87985','41765','45053','13434',
                          '31477','35559','38465','74537','27330',
                          '66850','35282','14579','20956','17453',
                          '42055','88246','31835','56659','36477',
                          '16118','48023','80737','66883','43774',
                          '71969','79740','43252','86657','66015',
                          '54061','43119','95603','65276','23734',
                          '75547','34448','50684','39981','42262',
                          '85554','91948','36770','64943','95591',
                          '93853','63301','84817','84963','62551',
                          '87294','80339','30202','30718','40973',
                          '13975','12965','68760','61490','78351',
                          '71190','81914','63357','65534','34831',
                          '58594','68644','97668','26949','21441',
                          '72363','80250','61471','93066','59647',
                          '66298','22002','23909','37666','24336',
                          '38720','97176','97611','95151','98959',
                          '20283','22554','92430','87246','40558',
                          '98736','11949','96075','12803','43438',
                          '17930','41248','41452','15270','98231',
                          '39607','59275','54137','31222','61209',
                          '30995','76528','70386','42873','18843',
                          '17795','39995','65015','64652','40104',
                          '81034','59956','37928','33576','99065',
                          '24344','94538','63874','33169','48215',
                          '84879','94224','79401','77111','45333',
                          '46926','41323','78223','38609','36715',
                          '24621','23870','94948','65584','94074',
                          '82796','54471','30451','27745','56023',
                          '24804','59656','48789','20230','77215',
                          '80902','59648','65950','41401','85107',
                          '26402','26617','78887','87672','85269',
                          '15189','10317','20966','16008','87135',
                          '95243','58639','73663','98811','69225',
                          '92730','61469','42280','52079','87768',
                          '22930','94108','96324','88559','72489',
                          '99317','42347','35121','36320','32149',
                          '26051','63121','31951','71065','70969',
                          '80545','84055','41648','30196','16577',
                          '97511','26802','26671','89215','75696',
                          '30288','76226','61754','86381','74943',
                          '53970','12289','53251','42197','43711',
                          '75761','12994','12333','12102','99539',
                          '56382','98551','89483','47321','79894',
                          '89946','40509','89669','80459','90343',
                          '23777','84473','10131','45570','17724',
                          '57165','37568','72265','32576','27400',
                          '20659','61173','78581','88281','72052',
                          '85752','10036','18838','69312','15892',
                          '17207','95714','78317','89059','56529',
                          '24402','17534','98748','58565','17766',
                          '14458','72436','94420','53380','22354',
                          '91954','23156','96327','46055','57032',
                          '62851','36060','28335','20132','22505',
                          '80148','90396','70293','65026','17065',
                          '69885','18884','92408','62484')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

