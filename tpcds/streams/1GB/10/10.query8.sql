-- start query 8 in stream 10 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '16084','43715','30169','33481','53775','48319',
                          '39558','28076','34412','66992','40259',
                          '10174','13242','13859','47607','47641',
                          '29129','68718','91751','62678','52689',
                          '96561','83036','81603','45315','74189',
                          '16813','22987','12192','66610','67506',
                          '61037','33628','22997','54750','93474',
                          '10915','26416','26746','46999','86390',
                          '72337','60233','76564','22453','24688',
                          '11215','63693','28196','65474','62943',
                          '64888','14459','90087','38263','20413',
                          '32041','85883','89392','11682','48825',
                          '37647','99628','79258','96728','78879',
                          '98332','31051','21091','79235','68346',
                          '86729','30394','16073','49681','65088',
                          '60786','18271','90773','47689','77701',
                          '45398','27261','81938','89419','75662',
                          '56105','13430','95518','46521','25790',
                          '15163','86026','75475','14854','83944',
                          '17483','47825','20780','40249','57757',
                          '91880','21973','63136','64027','40787',
                          '81753','84554','38096','26806','43650',
                          '60628','83717','91804','69479','93316',
                          '56398','76918','25407','22616','68697',
                          '23357','41676','23992','84822','36127',
                          '57047','67392','99833','76968','69290',
                          '53963','90248','17266','80282','19094',
                          '37444','32984','33275','89046','18913',
                          '92033','60260','76205','36878','92164',
                          '49865','71326','88820','27976','39680',
                          '76006','16884','64708','26001','96632',
                          '40860','31561','30571','43089','28919',
                          '78680','78863','33920','81883','29691',
                          '10956','82327','71417','84022','96575',
                          '46402','88033','22295','54489','74248',
                          '69208','14318','12012','35382','29449',
                          '52186','41156','65557','57443','49760',
                          '71267','65771','65000','52662','23455',
                          '97179','36795','50923','85793','26417',
                          '72829','66408','76192','11803','63219',
                          '14403','12553','12449','96288','96222',
                          '46345','46328','36170','12917','35574',
                          '21658','95921','13137','89166','13506',
                          '46061','32719','59050','22624','76771',
                          '39021','48043','64051','21943','52641',
                          '90325','69819','81897','23580','22102',
                          '18186','42748','34088','17810','66516',
                          '13269','80923','89800','42319','40270',
                          '13120','48263','91839','12638','58377',
                          '59275','54905','42731','94998','28736',
                          '43173','77150','90324','67626','83469',
                          '27693','55854','91216','91921','34286',
                          '70349','41606','21045','97335','92703',
                          '80681','58552','50614','23977','84543',
                          '59343','77613','22078','43574','82166',
                          '45599','62480','65246','20580','57299',
                          '67178','55175','10402','46153','27485',
                          '64713','69473','51813','40114','74071',
                          '54875','57371','56378','82574','37547',
                          '80728','91129','94137','79862','84657',
                          '69261','11401','53980','85408','60527',
                          '89067','61823','39291','72644','63595',
                          '80541','50929','97651','93196','90805',
                          '51226','16085','97536','58528','10416',
                          '24344','21864','73942','27614','10541',
                          '50935','28468','64467','89143','44730',
                          '28588','58385','14118','43773','50009',
                          '16443','41543','15765','65996','91564',
                          '13132','65211','75004','56555','17473',
                          '92713','23832','57021','89724','42240',
                          '93334','79981','91917','87823','72498',
                          '61826','45774','71045','78445','88777',
                          '47799','49667','81430','51670','83608',
                          '88312','69425','76948','43585','21978',
                          '29879','34621','31864','78791','77874',
                          '72451','96227','27032','22574','76813',
                          '97604','60030','43186','18683','27863',
                          '38969','92662','93024','84987','48725',
                          '23980','45289','72301','53992','76884',
                          '16699','21613','97998','21307')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

