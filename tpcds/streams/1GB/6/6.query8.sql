-- start query 8 in stream 6 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '66037','86727','53350','77553','96248','17428',
                          '86443','44960','66717','91365','83236',
                          '10915','27089','64849','83718','83836',
                          '64342','38466','92469','92062','55597',
                          '71925','41769','75974','74409','41036',
                          '60067','77746','61144','40086','42597',
                          '43843','51539','66794','60454','60345',
                          '94266','84090','87005','94595','22746',
                          '50119','60188','84898','43799','92042',
                          '49461','52316','89213','39804','97171',
                          '37082','56045','93445','90647','18480',
                          '65555','18001','63006','38628','85726',
                          '89461','34104','27061','12801','38383',
                          '62383','77538','80912','27956','96134',
                          '63290','84202','66184','67782','86160',
                          '48645','58586','62739','59512','98559',
                          '34342','70502','61111','36681','71362',
                          '26874','71177','96946','81201','34550',
                          '75477','50782','84415','29324','15108',
                          '70944','10611','29706','43070','10066',
                          '30742','86104','44798','95568','46454',
                          '54651','53874','80198','72057','76014',
                          '89591','34684','20734','58194','23423',
                          '49145','78484','67362','48012','27072',
                          '27117','41182','51690','58744','76100',
                          '18171','16377','40148','65262','50082',
                          '20496','13559','40135','90851','29195',
                          '15486','68344','64486','90304','31196',
                          '26821','77483','34573','60119','66241',
                          '23856','41628','82544','83928','37852',
                          '81823','20014','39520','17958','80711',
                          '18490','25088','69120','35971','14824',
                          '33905','26101','89349','37008','96139',
                          '57918','87653','76721','67340','24949',
                          '92567','48711','87170','59309','51222',
                          '92549','67634','37814','87568','41800',
                          '35845','19705','50184','39013','66681',
                          '90773','22643','86729','93719','58990',
                          '43966','48627','20542','68469','85338',
                          '97810','79106','10441','35017','42630',
                          '78129','91152','95137','57072','78135',
                          '73070','82311','66471','45236','46200',
                          '56736','19137','60062','35925','72688',
                          '50857','37190','14647','35402','56820',
                          '60414','80177','88193','32690','24302',
                          '34181','43516','23775','41306','67040',
                          '34851','34096','60292','58491','73411',
                          '95216','30622','24242','80235','60845',
                          '56590','78760','73020','97782','23209',
                          '68185','45972','28548','95415','76711',
                          '73576','99303','33358','48890','40593',
                          '17782','16866','25577','57506','83860',
                          '62155','27268','54476','27425','30155',
                          '28243','49900','97326','89077','45213',
                          '82846','40986','11925','95752','49541',
                          '43760','39534','67695','71222','53852',
                          '35693','38007','26784','20298','78052',
                          '97064','11944','23337','22245','61158',
                          '16193','85539','14661','75701','33504',
                          '62701','30794','34817','18161','26488',
                          '69010','86090','25965','51485','53727',
                          '24092','58312','32942','74591','25987',
                          '76958','64625','35329','91596','70288',
                          '55913','27254','35960','68132','28126',
                          '52495','31331','62583','66388','98499',
                          '77626','29121','54048','89763','46899',
                          '36398','25975','11131','40817','99801',
                          '72639','75252','72750','22724','56403',
                          '10571','61910','95318','29932','25500',
                          '66696','39446','83548','29539','28545',
                          '35248','76538','82584','48160','85683',
                          '70244','78665','30701','42267','61499',
                          '79789','81972','41428','60030','46688',
                          '44389','77856','43412','81079','32324',
                          '73940','66164','47483','45854','58252',
                          '96462','95926','74777','77094','15646',
                          '44212','12326','50282','22476','43139',
                          '10728','18306','21030','29606','48661',
                          '44467','34976','74663','62844','79756',
                          '86542','33407','94084','97874')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

