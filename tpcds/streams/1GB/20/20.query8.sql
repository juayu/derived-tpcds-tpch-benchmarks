-- start query 8 in stream 20 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '94445','83708','22019','58134','44116','67066',
                          '78332','59977','54671','65786','82932',
                          '46010','57922','31751','24286','61622',
                          '33803','97803','72882','95058','17034',
                          '39361','79719','31610','24574','94344',
                          '10115','78401','46990','60647','89014',
                          '98227','30896','32518','99148','90280',
                          '75506','73863','99072','38958','50492',
                          '77173','81005','58759','96806','85478',
                          '30599','32165','34350','45389','69227',
                          '36113','16663','10916','20445','38270',
                          '15211','61599','83172','37480','42617',
                          '40871','64963','82520','56428','35862',
                          '27556','34049','45771','31075','93139',
                          '77974','97313','30343','20962','32561',
                          '26169','31246','21491','74861','72573',
                          '98358','43707','28016','15458','75672',
                          '31441','43387','24071','15817','55198',
                          '18729','38581','90081','83163','65231',
                          '95630','47955','83577','29558','77242',
                          '73045','92710','58201','87452','40607',
                          '35193','26336','65955','30829','14756',
                          '43041','96263','11288','73075','27140',
                          '56667','77778','12047','22069','40925',
                          '94532','54789','82587','56083','87566',
                          '67006','58750','32593','59947','42031',
                          '84963','96469','34779','41662','27109',
                          '36797','19227','91123','74550','29152',
                          '27232','89763','58785','38259','50255',
                          '46834','42890','42506','12090','70789',
                          '54510','83425','19354','25231','94453',
                          '83267','49639','85140','31066','55770',
                          '99031','15604','59829','43842','36461',
                          '15945','78506','78535','21395','46473',
                          '97640','80648','15133','90583','33959',
                          '46202','80852','64463','80455','74224',
                          '15427','42885','16505','79088','21479',
                          '73758','92821','35230','78445','50775',
                          '33456','23232','37892','16949','28524',
                          '63697','68374','96578','15243','89145',
                          '73912','39609','43100','10861','91353',
                          '55445','91904','50601','65313','41126',
                          '11273','28357','69475','66631','53971',
                          '13205','35293','90261','57113','19714',
                          '12415','53686','53148','25120','35433',
                          '16564','61519','76584','33865','27588',
                          '97790','40398','91679','89460','44185',
                          '47078','92467','69310','43928','83658',
                          '71535','46707','98307','41277','94440',
                          '86485','62449','42798','89051','90019',
                          '65074','25171','96993','52990','11727',
                          '23066','80017','92146','45724','66133',
                          '66706','17147','83588','67259','39673',
                          '44517','19641','78292','49093','72552',
                          '61126','40033','44596','47211','21660',
                          '54060','94094','96402','38513','55744',
                          '78986','73742','88598','41027','68697',
                          '92617','59712','28647','56008','33802',
                          '84751','28637','95613','73860','45666',
                          '84266','60322','57133','20263','21525',
                          '28009','62695','88466','63835','79812',
                          '87294','48556','61867','29000','19250',
                          '43623','65667','46622','26431','28598',
                          '37984','24868','64442','89838','81455',
                          '74948','53884','11054','17032','14969',
                          '25126','67437','98415','45382','65003',
                          '20623','18879','22024','62125','77068',
                          '34663','72915','53177','39196','26702',
                          '70929','42589','55817','33765','50070',
                          '70245','88221','39238','93023','78275',
                          '92124','14043','93170','35992','67007',
                          '12695','61595','38739','92873','42000',
                          '82110','44918','55911','19572','42362',
                          '20451','95883','46803','63548','25149',
                          '91350','91504','80099','88189','76417',
                          '40195','73354','66765','91459','58534',
                          '14319','74488','17891','81405','74314',
                          '67427','50009','56610','20317','72127',
                          '37378','89565','60223','80485','31667',
                          '28787','28973','99045','70825')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

