-- start query 8 in stream 15 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '11465','95465','58881','76219','42014','41240',
                          '79953','95061','51539','33618','17472',
                          '89205','66218','95497','29916','61492',
                          '75163','88875','37224','19470','72725',
                          '38958','10139','17111','12237','85275',
                          '24578','50528','11521','47550','74894',
                          '64143','36569','44361','72177','24889',
                          '88655','63421','78206','46587','28324',
                          '57390','78476','97611','79622','15648',
                          '25567','52557','63305','18852','70102',
                          '53290','71600','13284','78204','11009',
                          '73527','58585','41660','12455','74153',
                          '19395','66832','24693','13153','22253',
                          '96111','95332','27512','47343','39172',
                          '70125','21233','97104','26599','83876',
                          '53354','15101','77417','63632','10421',
                          '29661','72896','64547','25907','80987',
                          '71071','26324','48597','44401','64035',
                          '75367','45781','89753','94053','68005',
                          '99733','35266','89920','23070','64794',
                          '87364','93579','68060','69983','26159',
                          '76209','58935','51645','37704','51909',
                          '93465','18781','80409','46784','30377',
                          '40281','45461','68117','65876','51085',
                          '32042','57879','53590','66110','29753',
                          '73255','65005','66809','94611','32838',
                          '68233','58126','95735','18740','45451',
                          '93405','71028','23296','53157','41420',
                          '32228','92507','74161','14326','10996',
                          '21662','59051','66445','74937','27944',
                          '69632','29820','65063','55648','10019',
                          '25398','88786','36435','66160','72819',
                          '65468','20057','14316','98182','50503',
                          '33538','10437','75020','82516','41100',
                          '67570','28751','56577','55868','37124',
                          '67773','41606','42901','51480','58177',
                          '15449','37742','31645','33499','52526',
                          '51884','20787','50946','25024','76244',
                          '44916','31759','15081','20356','15460',
                          '81814','11236','90709','78814','96924',
                          '89505','66687','93825','38452','87625',
                          '77147','28562','43019','64120','86954',
                          '37264','94769','78586','47814','21383',
                          '37513','67441','23034','33580','18129',
                          '44184','44373','13959','70435','59238',
                          '39754','48027','50017','20413','11954',
                          '18281','90409','21449','20833','17403',
                          '64406','70814','41173','19652','53330',
                          '23089','96796','59657','57750','66281',
                          '13506','65859','58917','23002','32553',
                          '53331','33436','32020','23072','25046',
                          '67840','64696','59178','80784','43614',
                          '30429','75207','20146','52075','26871',
                          '72539','97141','97932','25479','83111',
                          '52674','49071','42285','91066','80573',
                          '83161','20395','69863','42813','81368',
                          '56587','41713','39050','72758','25794',
                          '17607','80864','84743','46403','94428',
                          '53647','53841','29582','66103','55669',
                          '41257','30466','66400','42736','86338',
                          '68726','70589','60260','64001','46566',
                          '64285','85619','68213','79921','89170',
                          '51207','84036','31180','66174','50604',
                          '52017','84011','54173','68962','81963',
                          '44971','90719','95504','90269','86792',
                          '76972','88469','35925','40919','67367',
                          '99120','88331','94112','36843','23154',
                          '31273','42185','33765','30987','11653',
                          '81898','59533','87341','52590','12052',
                          '62440','39679','47001','25738','65901',
                          '26544','93727','70401','12094','60969',
                          '97648','75286','23497','50990','81534',
                          '99045','57135','28689','13892','23651',
                          '55297','25519','58328','46234','22057',
                          '30389','72104','49704','12317','46799',
                          '81001','75317','95144','53537','90514',
                          '31141','63870','45909','57060','36516',
                          '70058','60667','87468','74082','18040',
                          '90795','63623','44329','89414','27323',
                          '21391','73811','19613','44886')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

