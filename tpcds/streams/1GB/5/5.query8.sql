-- start query 8 in stream 5 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '98549','57639','45550','57272','92090','39086',
                          '60295','81556','59196','84024','57118',
                          '91855','78186','41814','96116','35188',
                          '18134','96295','40035','94052','42027',
                          '89483','75318','63796','80075','12628',
                          '21726','82624','40493','66342','83567',
                          '20650','86368','52962','54514','86543',
                          '52945','65208','17273','47548','35897',
                          '68325','76231','65288','87977','55269',
                          '97740','10108','16359','66126','94504',
                          '75694','21068','30374','31302','50365',
                          '36519','18459','67662','15003','59948',
                          '24870','61128','26946','88496','71037',
                          '31110','76204','73793','52660','73751',
                          '89026','56687','15966','53749','45220',
                          '37355','11046','14508','32877','83498',
                          '29097','48622','24378','82562','16500',
                          '40745','35673','72393','79480','79188',
                          '41555','27257','70679','82435','54094',
                          '31724','99950','50251','44817','91683',
                          '58023','46037','93278','10840','46050',
                          '97306','25633','63410','20288','66501',
                          '51273','34341','84546','67432','28352',
                          '27887','45284','26598','10418','56188',
                          '40929','86565','85048','72941','16592',
                          '34934','93255','64699','81549','87344',
                          '43977','52610','20111','56165','10745',
                          '44897','60230','65408','24627','35469',
                          '30921','87282','53660','68066','21917',
                          '50846','33849','30859','40527','76026',
                          '49192','34233','34815','64999','51089',
                          '91561','61433','33474','43230','76366',
                          '11810','51696','34490','71700','87711',
                          '41856','38691','53540','47731','96016',
                          '91343','29493','77203','55716','19547',
                          '11549','96506','34018','90243','60951',
                          '18153','81847','52295','68134','20015',
                          '13013','19926','59488','25684','77651',
                          '18626','53746','47478','75192','22807',
                          '54150','69084','37518','22623','84947',
                          '18329','94863','95301','25908','64282',
                          '89966','82173','93171','15692','26730',
                          '66168','54757','26219','82051','85761',
                          '41204','42194','99527','69998','49478',
                          '44529','48010','13704','39141','97293',
                          '73094','72368','25847','90294','39823',
                          '40373','94919','73482','25407','52808',
                          '88467','83006','74862','17944','13193',
                          '91861','66306','36813','80613','18125',
                          '38196','17108','83686','89342','45022',
                          '73660','96683','65790','14131','74142',
                          '38529','25022','54229','72967','82662',
                          '40140','25272','96664','68985','66919',
                          '37851','66059','87226','89922','43982',
                          '28392','98338','31196','72359','84460',
                          '17527','74404','71824','37503','14294',
                          '41132','19805','74286','63534','83700',
                          '12863','34105','23638','38402','19013',
                          '62748','74938','62760','72513','29318',
                          '90901','40115','97861','81846','14657',
                          '57413','63606','23792','54227','91574',
                          '83893','95535','56080','85812','77213',
                          '83635','38799','89867','53332','40454',
                          '37589','96079','53590','49658','32221',
                          '52165','59472','14186','32535','80993',
                          '21847','25952','62917','81973','84559',
                          '17703','72426','13283','85356','29747',
                          '93878','78395','87987','63453','13881',
                          '61812','38608','38774','85858','31304',
                          '70852','48958','31451','97876','89630',
                          '61229','86466','12254','84585','91987',
                          '69123','69136','27678','46766','30343',
                          '26657','30799','98533','64305','33360',
                          '47369','93722','92210','31798','62583',
                          '62826','56166','17471','96733','16756',
                          '37182','62531','58445','92665','52512',
                          '14644','88991','49327','80790','87976',
                          '15856','67624','30815','88994','81758',
                          '46702','11333','62895','61380','30030',
                          '11944','88513','99456','10109')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

