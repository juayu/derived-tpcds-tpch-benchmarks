-- start query 8 in stream 2 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '62000','21541','21026','56351','69289','55297',
                          '37068','42086','91596','30155','54025',
                          '13902','56177','25711','77398','48785',
                          '95427','93570','63500','29404','44512',
                          '53781','67710','14924','46527','55563',
                          '84407','41176','56050','32686','51788',
                          '25059','78059','41764','72732','68160',
                          '90323','42493','25000','17221','91874',
                          '37075','85854','15919','36975','27324',
                          '38100','49297','99075','74965','74632',
                          '80287','54472','55816','52666','40598',
                          '77854','49458','12110','90705','47341',
                          '26416','74486','86160','30838','37607',
                          '53482','46406','44064','29917','36607',
                          '45317','39526','36133','71003','27298',
                          '83929','52570','19719','47085','52250',
                          '62969','47539','62575','97965','73330',
                          '16911','90442','13695','25743','48543',
                          '76769','99602','61417','36128','30560',
                          '26945','40108','89278','36841','33111',
                          '71715','82054','96200','99882','30363',
                          '61161','68500','21548','20527','88782',
                          '74174','22814','62625','82191','34317',
                          '17549','96736','72356','53339','66742',
                          '48608','20650','41944','43986','97939',
                          '61628','64920','16481','39716','40444',
                          '84231','93519','87940','23183','68182',
                          '45435','81710','36701','37974','56426',
                          '29660','47475','65321','96364','21205',
                          '58098','14140','55235','87030','37606',
                          '34288','68504','43590','68710','56832',
                          '94990','52964','95975','73498','48541',
                          '25763','64563','31105','96284','74102',
                          '73099','66807','62714','67796','33577',
                          '75948','86291','24786','29970','98048',
                          '15259','38408','64587','16362','30941',
                          '41610','90563','44143','34810','28837',
                          '15532','94289','37349','33000','11527',
                          '25361','25145','41950','91754','20283',
                          '65048','23628','74521','85402','84600',
                          '88482','69098','13697','19602','10262',
                          '97746','40792','12962','90239','51453',
                          '43976','90008','36956','69016','90300',
                          '61960','42540','60110','86192','71293',
                          '71940','98722','99174','43462','24702',
                          '16509','79668','63493','79264','70652',
                          '48264','84052','81095','68907','20476',
                          '51570','98973','15797','46762','11200',
                          '28966','77431','34651','42684','13193',
                          '37447','89866','77734','62184','43181',
                          '74720','98637','53125','87350','11617',
                          '22148','92708','79561','96590','21284',
                          '48341','56841','11783','88571','50557',
                          '38104','18564','65891','67094','77858',
                          '33559','48403','23903','53624','78247',
                          '83624','98723','66651','54869','43771',
                          '13978','86168','10301','96447','74639',
                          '98529','60503','81979','68893','54404',
                          '91672','68813','34691','34645','16584',
                          '80735','53921','45502','70823','77182',
                          '54023','66493','80390','99016','51352',
                          '91162','50075','91810','27449','75131',
                          '84637','89775','93669','78810','42032',
                          '94181','78369','18770','29221','89037',
                          '85314','40836','90203','18551','73566',
                          '79670','86187','24779','88658','81771',
                          '18390','56439','99533','80483','61983',
                          '60049','10021','76573','94516','35239',
                          '25746','12860','59278','95234','10027',
                          '49311','14982','15161','25927','23499',
                          '36076','20939','40519','63004','86934',
                          '82997','32366','77373','83900','65186',
                          '59075','67894','35346','94127','35036',
                          '58216','86942','42664','93033','40341',
                          '62929','19308','32012','48060','77315',
                          '22031','56818','80831','29302','16899',
                          '55234','43461','93699','18797','99995',
                          '20525','83597','32918','51164','93238',
                          '83237','29339','58088','75950','73953',
                          '77933','42056','68603','20693')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

