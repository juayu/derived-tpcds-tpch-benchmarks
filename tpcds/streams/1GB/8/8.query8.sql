-- start query 8 in stream 8 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '72276','11428','44349','79079','23834','86897',
                          '10593','38584','42603','62467','28366',
                          '40020','49749','97649','37822','58717',
                          '34223','45406','72826','38514','57928',
                          '56006','48338','94885','65693','15017',
                          '53351','78583','11975','14979','47422',
                          '55496','46637','19659','52989','22976',
                          '57753','78109','37854','16557','82152',
                          '50229','88102','56985','40375','42397',
                          '95507','99412','54130','83136','92636',
                          '80771','69487','65401','84972','90400',
                          '33065','45128','94512','75802','29624',
                          '40804','11672','35807','54064','82462',
                          '58709','22892','41689','43071','23763',
                          '19525','67001','40650','41297','66300',
                          '92679','10663','81293','97283','40772',
                          '80604','95526','89920','92737','55263',
                          '70904','37740','12147','71075','39283',
                          '33801','13459','83716','82681','73628',
                          '58564','51804','49878','40945','74991',
                          '68175','19746','53845','36665','22218',
                          '17066','64978','81052','99519','89311',
                          '58218','90217','26529','51977','56196',
                          '26008','63907','99420','63097','48696',
                          '54390','12892','85131','97794','42442',
                          '50837','88659','96284','79273','61404',
                          '82255','26497','87133','90192','21789',
                          '15578','20848','49110','50015','21476',
                          '59795','28030','24868','35514','75342',
                          '95865','51025','87081','87108','24801',
                          '76015','88752','51822','85281','89850',
                          '69742','63229','21014','30448','99178',
                          '80048','81251','80569','78008','76260',
                          '79603','55705','97430','33658','38736',
                          '53588','98727','25334','10024','23383',
                          '51561','15172','41914','82742','96310',
                          '73271','84060','11295','50997','54081',
                          '40051','96056','15990','96336','30681',
                          '55163','67445','38448','58060','61051',
                          '81944','98676','54781','27726','74090',
                          '75738','87220','53182','90741','84383',
                          '52588','95175','77607','64905','82337',
                          '40423','54165','27821','44927','76738',
                          '98046','40850','60297','85481','65608',
                          '17716','35321','93564','97160','22455',
                          '61039','37482','69703','28972','85856',
                          '65348','99786','20205','97049','42542',
                          '26041','17448','41923','10884','91971',
                          '85996','26234','28777','61456','61736',
                          '46177','75018','61928','74150','75637',
                          '14102','41269','23365','92509','16916',
                          '51455','16411','82098','32125','26135',
                          '60300','37050','32121','41190','64508',
                          '62018','85848','10228','95411','12767',
                          '29365','54731','35503','89342','98093',
                          '50870','52577','53562','98620','79326',
                          '52267','38097','35731','93674','42947',
                          '97395','18229','64319','81070','36502',
                          '60154','69787','67085','53380','20013',
                          '50818','50481','19058','95774','80477',
                          '68406','56627','29449','91422','27361',
                          '61405','17079','82267','57824','32449',
                          '86807','90517','45451','76130','55640',
                          '41835','70855','44772','97584','54894',
                          '27639','10661','83067','94276','95054',
                          '71914','64498','13147','76666','43386',
                          '65674','17015','26216','64591','63624',
                          '22316','39043','71048','64880','56533',
                          '24281','34276','10131','35428','89861',
                          '97801','99132','84393','49928','38656',
                          '45703','54259','35275','70721','42018',
                          '20359','15093','61837','83592','96612',
                          '36286','76073','19891','18903','53631',
                          '86440','16603','18046','52652','56644',
                          '79423','71497','72183','60017','86876',
                          '48658','32995','72100','22068','80208',
                          '95982','57198','51503','65911','71409',
                          '22277','87367','75288','33599','78225',
                          '96009','16455','45971','57241','57571',
                          '15066','38901','87146','67936')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

