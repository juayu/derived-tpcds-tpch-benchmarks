-- start query 8 in stream 14 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '45397','15782','44070','80199','59664','54579',
                          '79461','48108','20033','91858','55420',
                          '24290','15901','39478','50773','58692',
                          '48424','83478','66920','24174','34273',
                          '54558','21460','25604','98802','27684',
                          '12439','85905','87452','32505','12133',
                          '10073','32307','22092','96384','83493',
                          '36203','59517','35436','72669','44200',
                          '12172','62912','70515','14521','25434',
                          '65175','90434','96787','25670','21701',
                          '83250','17504','70664','13282','94624',
                          '53405','53031','24866','43666','48389',
                          '24709','72324','73618','91564','77628',
                          '69281','19276','43791','71479','77863',
                          '43594','13636','32444','38167','10942',
                          '68588','83008','12577','50980','48738',
                          '31138','98250','20444','10078','28743',
                          '91271','67591','28907','23243','30614',
                          '53841','61423','23072','45488','49160',
                          '93024','13196','65542','67585','83909',
                          '11404','14894','56074','21617','93448',
                          '75001','24998','36321','47376','93510',
                          '19240','36828','74579','36372','41109',
                          '12977','90175','35641','57912','26295',
                          '16117','11544','79091','94458','61097',
                          '92126','22328','19984','47734','16194',
                          '84025','59388','65332','79469','18342',
                          '93934','28576','88660','55291','59320',
                          '25479','45373','29308','77801','65912',
                          '21703','49103','36410','34599','45467',
                          '61322','56823','90013','45448','92430',
                          '61894','91309','13737','56275','78882',
                          '18003','90078','17984','24670','77240',
                          '17196','25297','11858','78567','51087',
                          '68785','54349','26482','31052','97429',
                          '96732','80806','80499','67088','91432',
                          '88527','39598','63256','93455','18598',
                          '20827','91724','24590','31009','14506',
                          '64443','15848','53357','91142','38128',
                          '62415','51284','15177','55085','71860',
                          '16966','96494','69174','16570','77047',
                          '27836','34557','30673','62337','13834',
                          '57574','68800','68721','52310','79716',
                          '67140','31445','55934','16930','34257',
                          '68829','53438','45875','32878','48746',
                          '95682','67605','99643','93709','71028',
                          '64331','45614','22292','20160','45113',
                          '72934','68386','54352','13835','62274',
                          '43194','70266','10813','17852','81486',
                          '92412','68393','94794','65267','33128',
                          '60335','20412','79076','23829','36778',
                          '95535','21304','47725','16555','75011',
                          '75879','64318','96483','20322','68263',
                          '71101','93912','70034','62191','54331',
                          '69451','94430','16379','38040','82073',
                          '16345','78208','24933','93759','10951',
                          '30811','24532','44208','59367','74654',
                          '44953','90646','32464','94199','50403',
                          '45732','35739','23249','24192','16609',
                          '23264','56110','56580','23200','32711',
                          '87765','43069','20921','75304','10093',
                          '79540','23247','48619','44084','31939',
                          '84391','17059','11563','46235','70231',
                          '60957','20179','26746','43047','64317',
                          '37900','46715','21032','49256','86614',
                          '37732','92610','80438','59441','39426',
                          '17907','23950','55110','75429','11577',
                          '99533','13003','40503','44298','61709',
                          '62025','67245','29005','15392','83596',
                          '32046','67300','18353','78425','66826',
                          '36668','34218','83438','29936','96360',
                          '69521','17946','18653','92623','49491',
                          '70221','17308','94643','22765','90709',
                          '60118','55010','46081','11403','83295',
                          '45386','72446','43823','73175','10500',
                          '10169','90944','32658','83474','48256',
                          '84551','18578','56729','98766','60091',
                          '26505','73788','35382','29281','77491',
                          '60786','12997','94776','52638','23890',
                          '27024','43499','11326','39503')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

