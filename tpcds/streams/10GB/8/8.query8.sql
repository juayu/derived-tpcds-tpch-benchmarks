-- start query 8 in stream 8 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '71433','63226','80040','26522','33963','42023',
                          '51478','22038','11553','41432','49998',
                          '93970','28141','84216','91838','25166',
                          '76911','41980','40192','14708','86691',
                          '28619','78294','86512','26014','10405',
                          '37350','37614','38886','79961','73500',
                          '83942','37447','40274','51889','28292',
                          '40543','26300','91208','11526','66463',
                          '10455','49648','63971','48425','78382',
                          '45438','45560','51655','23014','85346',
                          '53821','13460','47706','44328','98822',
                          '76783','76428','33563','65680','56673',
                          '70916','60632','36879','27267','10890',
                          '95296','46845','96117','83803','46246',
                          '38926','94901','66038','16348','82457',
                          '89416','60443','25936','57419','18026',
                          '40360','26195','36809','22325','83919',
                          '12407','50437','17518','43413','97643',
                          '43552','55532','63244','25829','89333',
                          '53539','92716','60803','78955','60265',
                          '43696','25641','66070','63016','83644',
                          '49706','70941','82168','72299','12272',
                          '67561','69619','95585','60367','55647',
                          '16328','83423','89697','48254','40287',
                          '47040','25334','61848','71592','80720',
                          '25465','72007','60161','57314','58695',
                          '94860','30787','60822','33353','98001',
                          '40965','50217','82281','82980','56552',
                          '11096','52948','23876','55541','37429',
                          '22651','61679','45731','80386','17211',
                          '67606','49983','98870','19584','60931',
                          '20164','95755','58528','92108','26841',
                          '91910','88257','18306','61790','18507',
                          '88872','44134','55656','67442','14703',
                          '69405','29398','25766','16465','17408',
                          '13530','15618','39808','22249','89038',
                          '30447','83864','45976','56173','90693',
                          '40722','81378','43464','79484','45462',
                          '26208','41530','82223','54246','72055',
                          '29340','52512','29442','10680','42660',
                          '68877','30808','27483','61351','94065',
                          '57916','64096','24976','23795','81040',
                          '19569','51530','26683','84701','16672',
                          '46679','87647','64375','12939','56897',
                          '38310','48636','98615','13064','40686',
                          '26346','10345','41135','85665','32361',
                          '36273','42708','82796','36200','84511',
                          '41799','72404','76221','99209','37064',
                          '47119','23734','62055','95045','98227',
                          '79758','84665','52210','28958','28687',
                          '96258','21024','50649','54665','34392',
                          '75723','11694','36346','66793','45404',
                          '18741','31942','47845','43490','19551',
                          '80949','60974','14782','67069','86865',
                          '89672','92346','18534','20661','56132',
                          '69760','60905','88377','58260','14789',
                          '59324','66896','79935','85794','82640',
                          '69672','70204','85911','12262','99573',
                          '65635','31367','61965','88584','32359',
                          '15221','34620','86944','30102','13331',
                          '40308','75433','71160','60401','99471',
                          '97250','19860','73900','39157','28695',
                          '58006','24450','30806','24550','30883',
                          '25785','57303','94072','66160','42043',
                          '10097','37968','99218','71270','25413',
                          '86358','46091','33273','31847','58544',
                          '68003','84750','93456','59827','47000',
                          '31026','69622','17448','12430','70188',
                          '11456','32188','88160','16057','46827',
                          '93458','62471','48223','18098','56593',
                          '86629','99470','16773','53357','48742',
                          '60941','95804','65399','48185','81587',
                          '87763','92306','10766','83443','23793',
                          '58106','52818','82821','87302','31122',
                          '15188','53548','56740','37468','57827',
                          '69904','92626','41010','48927','22366',
                          '13877','39194','86331','35682','80388',
                          '84962','96072','26084','47427','93335',
                          '61383','27349','33513','20731','55547',
                          '33979','90744','61978','90533')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

