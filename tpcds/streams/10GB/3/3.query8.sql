-- start query 8 in stream 3 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '55821','50223','10993','11575','97802','58338',
                          '58106','70527','41714','49867','96885',
                          '35306','97763','23772','89996','51185',
                          '91682','27066','49274','55928','79734',
                          '74565','95111','91111','24597','76526',
                          '64686','47297','74280','65794','59927',
                          '59216','95243','78359','48695','30815',
                          '83065','79054','38498','38236','49980',
                          '25808','45724','32927','14084','63757',
                          '98182','91003','80956','32436','68397',
                          '26282','63585','40777','48681','19589',
                          '37163','47292','32668','15942','18487',
                          '98754','28256','21653','38971','49474',
                          '90272','44057','36439','33578','16088',
                          '81821','26812','20329','21419','16142',
                          '47424','97792','47991','94773','15488',
                          '91936','12424','51746','19025','48104',
                          '72378','73207','29580','49805','63866',
                          '20778','86188','38538','27994','15965',
                          '10915','40151','42661','68613','17267',
                          '51653','13652','33179','50217','92045',
                          '77073','55720','67367','30738','77872',
                          '40202','36318','69041','83682','55234',
                          '56790','41626','12478','33825','15972',
                          '27366','27239','27041','98801','20630',
                          '70115','89949','70381','97046','29681',
                          '71498','87435','13226','15285','64816',
                          '67156','74023','57956','67745','69236',
                          '87517','80907','25231','53910','50520',
                          '50478','77846','13884','22274','75917',
                          '47673','15162','45841','69905','42428',
                          '93990','18361','99277','75886','71979',
                          '43982','40463','40983','85075','78375',
                          '10164','80677','55789','15257','63421',
                          '35322','64590','19810','61189','78553',
                          '54827','72168','66161','51399','11359',
                          '17534','99054','50716','33186','59292',
                          '58835','17966','59105','82298','97592',
                          '88785','93197','90444','26591','78479',
                          '67206','34300','49911','65807','93089',
                          '40979','94612','18344','60503','10833',
                          '64770','77262','17610','23955','95976',
                          '64432','80385','98555','41623','64231',
                          '90441','87192','99371','14663','41739',
                          '10085','13620','69330','84727','25392',
                          '28342','19177','32621','29770','89530',
                          '15752','99778','91824','25814','76339',
                          '43442','11986','67192','32549','97347',
                          '41585','38493','38111','25130','21142',
                          '64420','19319','43012','78007','68935',
                          '74588','40770','50547','40495','58229',
                          '79088','74214','84233','50749','10260',
                          '41160','74925','10170','50097','39972',
                          '48449','26136','90991','17793','97824',
                          '43523','24830','68674','47492','37209',
                          '77011','12063','43238','84890','50407',
                          '99794','44717','48908','24493','15461',
                          '93282','26133','21875','10007','52941',
                          '24984','66613','24347','74788','93857',
                          '93418','27894','62500','17263','54973',
                          '62837','28360','36766','54723','71301',
                          '52144','60041','11113','90225','26012',
                          '85006','49241','77885','84098','32388',
                          '33783','30138','67404','90090','35307',
                          '15252','15757','11784','89032','94484',
                          '55854','42379','26883','32794','72946',
                          '34604','27110','90672','75836','61828',
                          '92024','18906','38815','29465','87069',
                          '98090','91806','74475','28808','82531',
                          '55834','49197','33215','90105','25367',
                          '17646','69194','73177','40750','83679',
                          '42859','67095','49539','42308','16666',
                          '79277','88395','18120','36450','14565',
                          '55895','79393','96135','85151','28685',
                          '76559','83275','38384','52968','34769',
                          '11871','26731','75526','87029','48779',
                          '58451','54919','92989','90297','19512',
                          '62114','83732','92046','29898','29294',
                          '25730','12921','35145','61489','34850',
                          '69240','49260','26548','32099')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

