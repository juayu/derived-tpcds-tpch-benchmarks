-- start query 8 in stream 4 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '83059','52461','67017','56881','38885','20842',
                          '24658','78662','14691','19271','99600',
                          '47677','91086','97709','21129','20653',
                          '13147','26937','15096','47447','67083',
                          '25298','10917','89767','66677','29037',
                          '46991','51100','97841','36696','62421',
                          '87950','41129','22431','94585','36000',
                          '56288','50734','37132','93938','74045',
                          '29518','24508','36652','59333','51986',
                          '75609','51004','19268','50661','61004',
                          '33989','52967','83444','30188','15361',
                          '20137','60884','27366','34439','58777',
                          '43829','22490','34993','21414','26348',
                          '45181','75141','30524','44090','12296',
                          '15546','47327','69609','55553','57235',
                          '56773','30299','69033','74478','11891',
                          '40606','77606','85724','27387','66477',
                          '76023','16754','32222','69853','86597',
                          '51026','21368','95962','56266','90612',
                          '36409','61448','88021','83525','60058',
                          '73530','93841','20141','34284','13323',
                          '71487','24904','79172','13386','43812',
                          '41478','40573','16376','13183','99092',
                          '30967','44997','80667','64761','75725',
                          '78493','54567','51850','32825','74954',
                          '97033','24120','99696','44059','98329',
                          '77283','53065','40165','68501','11814',
                          '33686','84701','77994','81784','56652',
                          '23584','20128','27418','37068','89829',
                          '75950','78366','63841','30447','88960',
                          '48376','24761','65828','41217','10504',
                          '98912','90411','31449','62598','68512',
                          '34471','44290','75498','51994','24935',
                          '21334','31223','53824','40815','17813',
                          '45892','95226','58773','96691','66247',
                          '62090','81075','53342','19933','14094',
                          '60965','28402','73889','91669','75814',
                          '51643','29651','68187','75279','82293',
                          '91056','49582','32152','62224','50356',
                          '20321','90533','10715','35330','58200',
                          '20029','80964','39774','35114','38897',
                          '12114','72586','89509','22496','51798',
                          '93210','82664','35160','84424','25240',
                          '73435','32557','21908','39220','67136',
                          '61144','94791','13760','45129','52056',
                          '89604','39795','64742','12623','57634',
                          '83710','23956','96578','42333','69183',
                          '82469','33093','48021','95525','64890',
                          '36655','31918','33001','16933','55146',
                          '82877','58946','71887','55806','30135',
                          '62790','91037','62739','69529','67441',
                          '17323','57155','74788','49434','81937',
                          '48701','49942','92764','31263','84621',
                          '24596','41094','55094','52186','27326',
                          '61043','76276','77273','32218','62204',
                          '94954','79554','54868','54627','61736',
                          '43915','35580','20480','67471','21091',
                          '99999','76228','39450','60388','18202',
                          '75663','63699','22871','57272','99755',
                          '39479','17436','79706','74543','34598',
                          '83928','86332','33083','46689','43274',
                          '37180','59317','78286','50077','18506',
                          '19368','37717','61471','28957','24110',
                          '55776','85550','94357','16935','10189',
                          '56046','41457','68150','26195','72965',
                          '82482','84426','40181','54878','93030',
                          '62526','88839','93338','27748','40439',
                          '34468','52421','42543','58302','91866',
                          '88373','84522','71261','39308','11304',
                          '67357','67597','35564','62354','94269',
                          '14908','16446','22390','27575','43366',
                          '91052','42376','17252','44214','10804',
                          '71670','93983','47638','55792','23002',
                          '22055','47119','88563','90819','70311',
                          '24136','91201','91332','61852','51422',
                          '67452','27307','39851','83044','15823',
                          '27220','16290','53226','72813','17307',
                          '24215','66976','88278','53655','94699',
                          '79463','10691','13490','32756','23735',
                          '24129','56076','95514','32933')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

