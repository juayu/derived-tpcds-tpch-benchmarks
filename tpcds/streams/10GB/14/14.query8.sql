-- start query 8 in stream 14 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '93878','50248','65651','75810','58851','28432',
                          '86520','97000','91395','25555','28053',
                          '97839','49930','35368','21766','59571',
                          '11798','40534','69138','24702','89243',
                          '70238','73969','41822','73585','96472',
                          '35347','44546','22513','56212','63272',
                          '37870','58771','98889','34301','38362',
                          '70656','31097','99016','62696','80399',
                          '90865','85330','87543','13186','95874',
                          '57179','67883','46035','86365','44999',
                          '60579','21051','55892','71305','26445',
                          '82407','64358','95903','51669','41522',
                          '52247','47231','85571','45175','29312',
                          '96097','70269','97483','33650','29961',
                          '41018','65497','95147','99064','26168',
                          '87076','77047','62221','94709','36674',
                          '62909','59589','73443','69675','24723',
                          '36931','38354','62406','31127','55167',
                          '32606','46706','83922','79085','89458',
                          '69339','32044','61535','68569','68388',
                          '48624','27067','38326','14753','95589',
                          '31416','16210','28237','29769','43692',
                          '13966','87203','61454','51259','67129',
                          '57298','63260','44135','68368','99828',
                          '75194','85522','47035','98346','53805',
                          '31764','39633','75014','99232','77032',
                          '70497','91009','44195','90694','80319',
                          '13947','24192','11088','93774','79316',
                          '10646','89072','17381','85061','41221',
                          '63268','64801','96162','64729','39418',
                          '71846','25651','56428','20542','68478',
                          '47163','50144','58933','24494','35009',
                          '43051','90683','21596','41546','83451',
                          '80779','18710','15553','93346','63559',
                          '40282','50324','47570','95106','22990',
                          '98415','10053','55968','33954','87923',
                          '16827','97178','38831','47376','10135',
                          '52840','29968','77414','44564','47075',
                          '14537','83763','50838','63129','27531',
                          '31480','41521','70454','28900','78814',
                          '82269','62014','42155','66939','97129',
                          '45739','56627','46781','90571','17977',
                          '54007','27207','42298','50889','18918',
                          '76812','66551','46242','85687','79265',
                          '92789','84149','15647','57568','19746',
                          '72145','79455','67456','59683','35487',
                          '39559','94022','93475','43477','60110',
                          '50874','75772','22045','73567','32121',
                          '75402','51674','17209','12459','28662',
                          '67689','65562','19259','66633','47603',
                          '75509','10555','76534','41104','14682',
                          '92716','32209','24087','82179','98785',
                          '41895','98903','44197','35791','17181',
                          '54256','84540','81136','77450','44606',
                          '58360','34088','57132','38702','19731',
                          '38437','87594','65232','62177','43799',
                          '65109','41569','49734','16083','25690',
                          '13785','45459','34445','79317','11574',
                          '96919','84588','17699','38862','35022',
                          '89385','28193','59164','37428','10542',
                          '32887','66653','46395','38741','96898',
                          '98044','42888','92529','40159','56552',
                          '62588','64267','15511','31955','59953',
                          '12290','74040','87017','89926','86455',
                          '40620','73834','27160','12602','36109',
                          '95017','14237','29384','48087','49143',
                          '54835','58494','72368','96479','69953',
                          '77913','43702','24871','78206','29737',
                          '29916','42788','89584','27565','45557',
                          '79884','32193','67585','82395','42382',
                          '36219','45628','41074','56333','86917',
                          '50711','75948','76987','15914','72834',
                          '99225','58352','41701','37265','59755',
                          '37759','89224','61041','89084','82775',
                          '60417','15611','27369','10934','22890',
                          '15251','82731','97495','90490','83721',
                          '38821','82466','45046','77367','55621',
                          '65535','96446','73002','53789','47686',
                          '80273','73110','86368','44046','44020',
                          '64829','53001','47622','82106')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

