-- start query 8 in stream 1 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '71358','54103','61180','86927','91850','77607',
                          '97979','11894','95681','95213','94267',
                          '52413','84010','52167','74155','24140',
                          '89917','10222','71961','66397','37651',
                          '13241','46554','73819','20530','97768',
                          '92082','89591','21961','40074','45775',
                          '74885','30590','37441','51832','60109',
                          '70552','32219','10382','71192','64546',
                          '74609','50053','68772','48886','26041',
                          '98222','17277','10528','85459','36314',
                          '32642','86223','17145','37487','65293',
                          '43840','49457','51429','38453','57735',
                          '42153','57728','81773','95413','70840',
                          '13714','96445','40866','18130','49753',
                          '16660','54054','27867','52150','18015',
                          '22158','89480','94160','34389','24069',
                          '59467','37908','85823','59322','47228',
                          '49540','99404','18165','85392','72642',
                          '83318','19878','61580','23846','77548',
                          '52786','95460','81516','68006','21880',
                          '84569','74928','93473','75166','92754',
                          '18828','95019','70071','72332','52783',
                          '17665','27386','12184','10794','50676',
                          '75904','38248','97015','44741','64947',
                          '98341','26329','38416','71448','20456',
                          '29528','29856','91151','54112','80039',
                          '93299','36367','56013','73952','75746',
                          '77971','86208','65964','15938','60404',
                          '22629','66341','35127','70803','72106',
                          '15770','73292','82600','50982','49556',
                          '69868','16522','23510','93750','27354',
                          '47632','33082','52938','74709','83378',
                          '26082','17926','30253','98063','74365',
                          '74639','28480','24150','53333','30476',
                          '72211','58001','30827','92335','96387',
                          '68240','24933','16633','68815','83496',
                          '92963','79480','35928','62138','47128',
                          '20922','28704','61755','46919','46100',
                          '86080','45547','59698','88617','43898',
                          '25636','93083','87519','55542','14453',
                          '37957','25999','41578','87664','47110',
                          '86912','18039','92265','28913','61176',
                          '18093','37069','97365','31143','49734',
                          '79241','64449','38854','43946','26598',
                          '61713','86206','80241','47602','51813',
                          '31233','71399','18048','97005','85286',
                          '65852','60219','37871','67759','95575',
                          '94949','78595','49514','85308','70416',
                          '80288','58476','95144','89066','64498',
                          '88154','84563','71780','79777','30338',
                          '93123','94667','76089','24306','70509',
                          '69088','90253','90084','97949','30055',
                          '69014','54255','25642','86879','86353',
                          '34190','40718','25609','42773','66116',
                          '55824','95427','94180','68307','80358',
                          '77439','60314','33712','41071','73191',
                          '88202','87381','81609','47403','50940',
                          '32259','43758','84750','50777','99525',
                          '67233','33133','79190','78414','70031',
                          '94928','43630','66648','23073','42888',
                          '37479','83065','44977','70069','85161',
                          '24010','12424','45613','31475','57888',
                          '34258','38365','97222','97055','99075',
                          '33555','22698','20670','81088','18884',
                          '96417','44107','95912','24187','54343',
                          '59751','48326','44582','37392','83778',
                          '24625','41362','63873','49015','23646',
                          '86406','20640','89045','62382','24265',
                          '66876','35074','40382','37703','36842',
                          '58584','10412','93154','51947','10799',
                          '42696','93376','91036','35344','98058',
                          '22099','61011','47599','60482','68863',
                          '80310','49653','18031','49091','27465',
                          '71443','34098','73197','84766','46676',
                          '78143','45941','34504','20104','29998',
                          '51371','17350','80156','47744','55361',
                          '92177','57576','60445','14328','55468',
                          '97888','41083','56818','32247','73487',
                          '87242','83762','59463','91447','58556',
                          '64938','32459','93910','35072')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

