-- start query 8 in stream 9 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '37600','69603','88518','76084','49834','48579',
                          '76891','25062','28064','79451','79711',
                          '44504','84796','25356','59474','20242',
                          '37908','62770','10794','91441','41798',
                          '47135','65889','21535','43793','97430',
                          '46657','61070','19071','15740','49751',
                          '63423','77122','32733','66968','26894',
                          '15342','26275','72196','24341','85159',
                          '45116','32351','76377','11700','46090',
                          '23780','96759','40321','99354','30130',
                          '87471','37961','72346','49742','35739',
                          '18029','81455','98980','60188','74031',
                          '36108','59196','20082','72015','75307',
                          '81977','35643','86873','11783','92977',
                          '52672','97390','49433','95593','62254',
                          '69728','88179','15756','10532','86407',
                          '29961','56617','84955','44560','58987',
                          '24939','41373','86954','60800','63328',
                          '11469','53727','80717','63125','57404',
                          '42433','37814','81038','86593','86024',
                          '90040','35794','16302','11368','18202',
                          '36563','47900','16536','90761','43960',
                          '38277','27812','84716','52167','17360',
                          '13982','37665','32903','29040','36100',
                          '36721','62351','70692','13387','57119',
                          '47888','57752','36817','30872','31297',
                          '24855','92380','94883','31444','68944',
                          '80351','10157','46236','59737','38031',
                          '31826','73473','55458','73273','39046',
                          '68305','70373','58406','79198','44943',
                          '20404','45774','26890','98134','38746',
                          '41546','76781','83335','34805','75096',
                          '30789','66804','87953','13463','56045',
                          '74035','14849','37243','71228','26567',
                          '35191','70712','78300','50174','46911',
                          '89932','16465','24491','66331','65381',
                          '63474','67663','88084','54605','44397',
                          '73835','76494','72150','46560','28597',
                          '32977','43236','78601','56938','40375',
                          '42030','11716','75528','34541','16827',
                          '34325','66624','33963','12049','50880',
                          '92069','97922','30848','87005','37477',
                          '74501','71990','76882','14057','86573',
                          '26237','72562','65932','83112','56673',
                          '19170','75176','37152','18131','96046',
                          '36028','69094','64136','19389','19603',
                          '30959','93566','92808','93244','58269',
                          '23414','41203','93774','94247','73561',
                          '56892','82467','99353','47620','16411',
                          '99595','70736','92393','17782','88327',
                          '19055','55339','13365','47005','72107',
                          '90072','19662','68596','90766','42702',
                          '43626','27222','55003','42270','46580',
                          '60579','27767','77648','64961','53073',
                          '60458','50347','20805','38424','44850',
                          '60240','17026','31075','42021','59328',
                          '97417','52727','23606','93556','55063',
                          '33084','54941','89180','15837','13699',
                          '88391','46226','70379','72218','47043',
                          '41058','57366','96910','50518','18950',
                          '86879','58301','85503','11697','51649',
                          '65285','93799','84551','63180','55704',
                          '50861','81026','95784','47567','98510',
                          '62276','92761','36733','40461','17076',
                          '88194','43922','93577','28839','71268',
                          '15747','96093','25696','49970','18351',
                          '82227','68686','19594','32945','22095',
                          '44809','77649','35654','77179','90943',
                          '22396','90857','30064','37974','92802',
                          '46899','27056','80775','67510','40525',
                          '98321','84500','46064','44668','47632',
                          '96327','92775','28373','47774','16129',
                          '39298','29336','55942','74003','50336',
                          '98041','73903','37035','52926','30466',
                          '11633','54258','71800','48334','35001',
                          '16735','39743','73476','53807','12640',
                          '25275','39845','78005','33376','25496',
                          '32385','84898','15670','79595','58939',
                          '36327','11176','71823','38977','60974',
                          '35121','30646','13074','90025')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

