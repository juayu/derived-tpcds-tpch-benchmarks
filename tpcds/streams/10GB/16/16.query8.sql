-- start query 8 in stream 16 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '77061','89380','94093','21685','91459','69386',
                          '98197','62910','28600','58020','39061',
                          '80903','49459','65159','44230','66617',
                          '50169','79122','64995','44120','72927',
                          '98459','23131','27603','94194','63319',
                          '61281','74181','69080','86746','98699',
                          '67118','51355','16551','18759','88060',
                          '71665','50582','58701','80468','57061',
                          '50696','21017','58271','26371','98797',
                          '36772','47900','75594','44078','39272',
                          '44679','51775','23038','39089','59755',
                          '97624','47845','91315','47934','80856',
                          '27309','97448','94439','53625','72311',
                          '98754','66573','51758','63206','98653',
                          '57470','50555','82092','68078','34641',
                          '36183','51670','39823','75185','39600',
                          '43817','96336','60998','38457','72645',
                          '99286','10097','49317','28942','79241',
                          '14817','82311','14176','81985','33567',
                          '97621','61786','61697','63705','73624',
                          '16655','31238','79065','79277','51147',
                          '51361','80779','46346','65164','55018',
                          '74792','34922','82444','68463','89290',
                          '63812','39356','95743','92180','12848',
                          '91643','80503','80731','36320','53674',
                          '33387','42425','81156','58241','96513',
                          '18846','90048','90097','99827','64404',
                          '51476','38602','35131','32398','88945',
                          '51474','93248','65846','10745','10776',
                          '60241','58496','29061','34457','75536',
                          '61758','82852','37696','16463','54737',
                          '28055','48296','65496','36074','35436',
                          '42204','12516','67599','13296','68287',
                          '96483','65806','82076','83156','69996',
                          '37704','87063','83604','91101','92898',
                          '64112','78676','19180','36405','67428',
                          '52997','34048','15886','53350','14164',
                          '69172','16806','61586','96229','77335',
                          '58258','35181','21538','66530','64520',
                          '89539','35025','68165','94508','95060',
                          '55584','69685','59559','66852','32170',
                          '28840','31335','99957','86066','75364',
                          '26622','60233','92070','49009','30042',
                          '41525','40094','29460','30022','48271',
                          '20411','83099','72046','94636','19307',
                          '26082','19991','55230','75030','70097',
                          '30169','83994','28324','43387','58551',
                          '15075','82602','25399','56205','64477',
                          '85995','12523','64601','79313','32969',
                          '11721','25584','63380','17909','73630',
                          '55920','69195','70674','65814','65842',
                          '31234','96338','72392','24376','90102',
                          '24833','97861','97143','31797','59910',
                          '70514','49038','62242','89779','32278',
                          '48659','52554','39746','73597','34333',
                          '63029','71912','96585','82664','68179',
                          '12967','93863','43458','37589','16487',
                          '67435','69637','52316','97422','61075',
                          '33393','79033','25758','10895','84003',
                          '97152','40608','52656','31197','30742',
                          '28072','49792','44228','32215','20598',
                          '91598','90536','91604','79356','90010',
                          '31914','95905','56321','24310','19328',
                          '61482','53694','45416','39177','62561',
                          '90275','30931','80846','52391','34816',
                          '33421','78253','42337','46393','24317',
                          '37977','85299','51984','80125','93313',
                          '63685','41494','74728','56634','59026',
                          '36145','30688','23690','44891','30387',
                          '80170','26660','15244','46608','77502',
                          '85615','25741','62695','33966','38321',
                          '16384','60510','47968','99229','92450',
                          '33597','10845','17816','31718','84188',
                          '63754','72778','44396','15956','99828',
                          '38042','28870','78403','26747','14883',
                          '68749','45783','98670','76667','23012',
                          '17964','30969','91953','39048','86505',
                          '83797','62563','25439','20583','58494',
                          '82109','48957','14855','54912','70685',
                          '55131','78655','67165','20849')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

