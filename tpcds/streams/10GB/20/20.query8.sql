-- start query 8 in stream 20 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '30207','61353','25609','83893','60138','30327',
                          '40750','47709','11879','38978','98155',
                          '25955','95724','38033','18818','26206',
                          '94571','53216','77900','16449','21956',
                          '49599','69689','87258','95276','94528',
                          '52047','49217','50484','27384','78325',
                          '97339','25028','28985','26337','18808',
                          '99383','55243','42725','81687','25131',
                          '88950','36670','69607','71841','70764',
                          '50708','94058','48080','41886','22917',
                          '86063','64084','68753','38718','80356',
                          '37735','76677','78632','20970','73362',
                          '74404','72362','35925','73311','29515',
                          '24489','45845','75308','36178','31314',
                          '25388','45646','95193','85510','37551',
                          '55454','34161','39613','54876','46095',
                          '13422','46618','66123','78098','88997',
                          '27279','78896','83994','27170','99081',
                          '43593','43686','21539','84194','75651',
                          '18552','97689','94597','34141','34899',
                          '88265','21220','75800','71315','87080',
                          '96323','86520','69258','36641','27135',
                          '64964','47982','34017','56436','36048',
                          '57820','17188','39285','62753','57106',
                          '55480','77769','13587','21650','62741',
                          '87420','49904','50691','41998','44415',
                          '81658','39168','46092','81202','46489',
                          '90064','76483','52594','70332','57901',
                          '59510','99411','57755','31244','49267',
                          '29331','19414','50701','17116','40823',
                          '78197','50228','60271','97311','64996',
                          '77795','69294','18071','89155','25005',
                          '38797','52327','78150','12684','85012',
                          '44063','21692','96758','32208','71303',
                          '89387','47971','42237','34604','22487',
                          '70409','68786','43184','67156','84191',
                          '34474','85019','17625','51668','37725',
                          '72725','86853','41158','43255','68737',
                          '93226','72044','16472','83935','41644',
                          '55890','36299','17668','59346','73892',
                          '13037','26964','39526','23857','12020',
                          '22164','33469','21333','98234','77804',
                          '28965','32980','37406','31295','68452',
                          '17430','63958','45850','73430','29953',
                          '95359','28811','98488','98461','35086',
                          '88660','19739','56647','81820','65498',
                          '79145','81060','72205','12524','99163',
                          '31940','68169','55983','75123','65913',
                          '85605','10110','71082','53293','57444',
                          '64626','54376','52215','85964','86256',
                          '26755','14788','94497','49984','35135',
                          '29514','70843','90044','94949','66151',
                          '62610','48641','44509','55086','84816',
                          '14055','29216','61079','60548','35176',
                          '50233','54436','62984','92142','65704',
                          '36789','76857','65572','27890','23622',
                          '58760','89788','70619','43856','59528',
                          '18558','95689','90521','51628','11688',
                          '80870','64524','64306','11529','61078',
                          '83645','45313','24392','67415','10918',
                          '45943','28227','37899','65228','14241',
                          '43061','73516','18879','26807','73852',
                          '28082','67107','52087','90966','99379',
                          '47546','36851','12298','36604','34363',
                          '72654','17712','30269','22670','33423',
                          '98578','88199','83620','24325','42561',
                          '78055','43134','85021','56092','22179',
                          '38157','22428','94979','77064','11470',
                          '66568','67347','18488','85357','20312',
                          '63651','23426','68709','19642','22590',
                          '55667','34291','85673','44148','67380',
                          '80537','30293','85495','88812','76068',
                          '82697','52747','74049','89021','64948',
                          '28450','66383','85447','74912','31001',
                          '28795','14652','72744','20975','94201',
                          '72492','31573','53468','26082','95764',
                          '98749','82802','28262','12039','98314',
                          '76013','61399','46273','74858','47382',
                          '90106','74775','75785','73253','68317',
                          '94429','25658','19111','86222')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

