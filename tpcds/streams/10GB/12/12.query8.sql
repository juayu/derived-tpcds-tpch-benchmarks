-- start query 8 in stream 12 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '53201','94976','82182','48143','65037','73355',
                          '16561','33347','49424','97119','96992',
                          '47788','72827','21175','77079','12045',
                          '39359','11694','36412','18652','83692',
                          '64932','12026','50961','70073','35088',
                          '88999','85306','17993','52325','44935',
                          '35405','23179','17393','20976','97511',
                          '74299','24830','43336','46902','61393',
                          '50526','84596','11740','40075','42005',
                          '59586','68940','52370','49373','27060',
                          '37233','84343','50978','29922','58405',
                          '22832','34669','76122','97325','70929',
                          '73013','65962','38620','13909','50308',
                          '40954','69631','50760','12930','77383',
                          '30946','15011','74375','60817','56322',
                          '40457','61283','87642','78134','78527',
                          '68563','34674','56579','22292','57642',
                          '48601','45178','75665','45074','22058',
                          '26386','27705','22063','24554','41419',
                          '54875','75537','34494','36330','87362',
                          '15452','90021','49458','55246','98443',
                          '87715','27279','98686','15234','95183',
                          '30407','91048','80412','49774','21033',
                          '15290','25353','49878','82324','86282',
                          '84607','89818','56862','85298','11610',
                          '33189','80166','76817','62142','26339',
                          '42382','92373','68325','33322','91803',
                          '56712','47060','42375','12965','15739',
                          '25211','61479','84533','74011','91095',
                          '23871','53739','78751','48744','13707',
                          '51728','96203','90352','64326','96427',
                          '74900','17233','69780','19050','98817',
                          '65576','17823','31317','54481','67423',
                          '16216','81164','77376','98518','34213',
                          '41425','94223','55164','45428','10079',
                          '87956','40537','51265','87292','77852',
                          '67065','49336','11910','12712','65094',
                          '69202','39012','40953','30292','93707',
                          '34695','56622','45440','85296','74463',
                          '85930','78279','85650','51123','89280',
                          '80234','64548','79511','88668','93225',
                          '42445','16584','90188','88814','77083',
                          '75311','41311','58266','67341','43893',
                          '34399','92626','52358','45933','53865',
                          '41731','50875','36134','54507','66329',
                          '66764','61166','80033','22902','78193',
                          '67503','20702','44901','30551','93474',
                          '73896','89971','23128','44817','19925',
                          '50653','35145','79274','20865','80454',
                          '31506','45146','86768','56998','15824',
                          '80993','32160','90087','64345','24339',
                          '84732','37200','70112','58642','17213',
                          '90152','94575','96497','61337','88332',
                          '19512','82030','86803','33967','60698',
                          '34391','98893','86405','25284','70457',
                          '32169','99516','53349','75741','93671',
                          '99104','59147','73252','58507','17069',
                          '11515','30796','54246','29223','74974',
                          '69357','67373','81752','35696','18186',
                          '89765','57993','29479','24065','81030',
                          '82120','86810','52965','58123','74712',
                          '76828','46504','76783','99764','30039',
                          '72670','72712','78909','92979','82717',
                          '56032','39492','34730','26524','34921',
                          '48571','29744','89024','56075','90728',
                          '94753','67865','37543','14892','38318',
                          '20058','52929','76581','15370','52386',
                          '59303','85397','77880','47191','22572',
                          '41911','80238','44105','11775','96814',
                          '29716','34306','94624','68241','43322',
                          '97914','33291','64344','40991','78261',
                          '11913','36643','36110','14799','86254',
                          '93145','76246','32093','99179','39683',
                          '77617','60212','56091','15764','82396',
                          '30075','71641','92965','16602','16541',
                          '85476','46911','72189','51466','13414',
                          '43382','86272','76757','45486','60773',
                          '69581','94587','39527','70810','97926',
                          '52088','70054','17411','76045','53145',
                          '75606','98476','77528','18532')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

