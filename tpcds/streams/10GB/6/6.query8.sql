-- start query 8 in stream 6 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '91646','29269','93958','99230','13865','49517',
                          '58657','73986','81087','27597','79209',
                          '67889','23431','46576','28309','71814',
                          '58257','69209','33824','66376','19697',
                          '52481','81808','72102','91548','52616',
                          '61106','20034','98138','71404','94598',
                          '93164','89051','26023','19114','93192',
                          '40191','79733','28382','70763','82608',
                          '65591','34072','41918','33770','84645',
                          '97358','16764','75157','52608','26521',
                          '70742','51958','51956','81544','74796',
                          '28041','16586','30182','19688','56019',
                          '63415','69420','93527','93949','37719',
                          '75367','32978','29050','25259','11759',
                          '72307','21718','99486','65791','42942',
                          '96727','27764','10863','27567','34803',
                          '27564','37418','10378','62205','52751',
                          '31550','44900','68073','55624','35792',
                          '31394','23531','83142','85635','45412',
                          '77488','45941','39868','78657','28859',
                          '60168','14270','55263','20882','31217',
                          '59404','16166','89526','30715','14961',
                          '89804','55749','63546','37522','12096',
                          '93868','55891','57199','84841','68576',
                          '56337','56668','31203','82135','17075',
                          '65780','41106','92216','92648','90653',
                          '61115','55841','54713','10373','52587',
                          '62230','40222','41940','56590','81211',
                          '76939','88186','68969','32898','81677',
                          '39665','29629','80956','83684','19850',
                          '53863','86915','18555','36358','16406',
                          '15587','84450','70065','70568','62294',
                          '56764','95539','76394','55934','23697',
                          '53445','92487','62897','46292','56095',
                          '81432','70851','71020','16164','75733',
                          '55621','50014','81013','56100','20504',
                          '49159','69180','54560','88723','60237',
                          '35330','60966','82895','95443','64296',
                          '23757','71168','47779','17951','34869',
                          '88933','77602','47316','61014','71724',
                          '83306','18775','35054','89096','83143',
                          '58073','76949','62030','88638','87495',
                          '24494','68857','59081','92982','81092',
                          '26608','59668','39020','85210','70318',
                          '71113','68549','49579','32790','46372',
                          '18612','60554','66283','61931','87035',
                          '84657','64811','44215','13360','24730',
                          '89390','74443','35609','49445','70648',
                          '43393','44496','49034','78216','99984',
                          '73633','14510','56753','40434','51147',
                          '75680','89612','46279','28373','39164',
                          '49466','85263','10824','53064','82487',
                          '14035','98501','84197','80304','70470',
                          '35397','28179','34801','35971','69397',
                          '42322','43421','62625','41994','34000',
                          '51244','76978','43128','60151','83652',
                          '22191','41828','51279','62380','41669',
                          '85013','51662','54092','32371','10108',
                          '32076','76819','53909','37568','17485',
                          '75191','36241','61578','79072','24361',
                          '38800','47854','98791','44944','96111',
                          '23082','20106','26596','82393','99948',
                          '96677','95315','80308','18664','94887',
                          '82077','97316','58994','46641','55344',
                          '16626','25982','77838','61217','11948',
                          '14893','61694','73504','84034','29938',
                          '36249','18102','62468','28635','64248',
                          '83675','28017','88853','29166','24966',
                          '98560','58520','61189','16360','72893',
                          '44657','90064','19063','97726','48563',
                          '42635','11389','72748','57144','12276',
                          '53638','76954','64876','70831','52693',
                          '34897','26311','97258','21414','66310',
                          '41549','61451','48988','85449','39769',
                          '78027','85473','40852','36712','86939',
                          '49796','86800','81961','39281','62706',
                          '90976','81911','51401','50426','68453',
                          '75705','83268','95445','11104','76867',
                          '16884','30205','91174','28985','36394',
                          '78512','87813','12317','16447')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

