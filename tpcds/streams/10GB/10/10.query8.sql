-- start query 8 in stream 10 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '81058','27761','17066','87061','87481','69167',
                          '19174','60022','57943','78325','75214',
                          '84004','74107','67052','80453','85232',
                          '22780','96727','94614','17626','47349',
                          '68167','29098','59974','88026','31677',
                          '70523','10009','29830','44721','29800',
                          '30180','35433','87038','80960','60360',
                          '32727','94604','83006','78654','19921',
                          '60795','24978','28569','64577','19419',
                          '40678','36585','18981','58811','80531',
                          '78179','68555','27993','86780','88869',
                          '27947','99189','76866','57928','46182',
                          '66060','90886','39232','34628','26309',
                          '55725','24540','61808','73255','16528',
                          '56441','64204','58332','76950','21928',
                          '65595','26816','78545','91847','59537',
                          '36165','42978','92502','34310','22283',
                          '76964','85311','88510','93434','68828',
                          '65128','87353','26872','88574','65258',
                          '13108','23980','70225','20316','11259',
                          '12060','79113','70744','23554','32885',
                          '18539','64019','58193','78862','30616',
                          '69094','54730','24434','54111','57330',
                          '48765','49910','18914','96694','99383',
                          '11557','36743','69907','40620','54616',
                          '94787','31506','22848','26906','75764',
                          '45239','63779','95386','53864','40417',
                          '73337','61951','10382','36521','65210',
                          '22703','94655','10798','59052','92133',
                          '40259','73887','56571','99677','79662',
                          '32905','46710','84118','53877','70715',
                          '47005','27953','68279','49073','91398',
                          '44117','74218','24098','74102','66284',
                          '32551','79561','43280','43074','63530',
                          '17463','33906','38796','55989','99569',
                          '95407','72868','31794','62598','31459',
                          '36272','85272','20077','49578','24833',
                          '56976','81055','43252','13414','60906',
                          '73565','12076','80438','92998','44181',
                          '23184','51359','52864','65190','28584',
                          '73844','33790','12172','58499','10069',
                          '76590','77968','13045','75971','77372',
                          '34623','76024','64257','15226','12730',
                          '94926','60392','16770','42706','88225',
                          '21437','74670','88970','95418','98846',
                          '12422','74795','34236','68631','77570',
                          '56877','46971','66451','63680','82743',
                          '12063','45599','59718','33008','60517',
                          '17647','27438','44979','44986','44607',
                          '69013','89417','38353','48489','68176',
                          '36905','86632','35961','15884','81017',
                          '10005','28239','76847','81104','91030',
                          '53380','98138','22901','23824','37543',
                          '13610','59500','45850','98218','64286',
                          '45012','10783','57278','44588','79689',
                          '40389','21936','35864','31496','39606',
                          '72186','17578','47424','38458','84166',
                          '52016','25782','83894','16452','93097',
                          '82160','24419','57088','54305','15983',
                          '18132','35022','52217','13467','47928',
                          '87546','39197','82668','20239','75426',
                          '39255','28224','21603','83345','79532',
                          '13662','15034','80787','55820','61536',
                          '86002','13331','36570','84372','79056',
                          '81741','30122','13887','80037','39001',
                          '56598','58486','63686','80336','17099',
                          '30274','11669','47494','71279','20594',
                          '56837','56979','34477','77599','24048',
                          '98103','89397','95939','84283','47036',
                          '52444','27263','26280','65220','71539',
                          '91344','52686','37379','31203','14399',
                          '48746','74336','33401','91838','79668',
                          '33497','20565','26047','54645','95197',
                          '13566','21288','43066','76547','47757',
                          '52508','31454','87036','90988','37279',
                          '88540','20447','43429','94891','62722',
                          '59234','45768','28016','12250','67144',
                          '49781','82072','54643','18930','64524',
                          '65387','78602','20987','89874','77322',
                          '20551','94653','30190','78439')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

