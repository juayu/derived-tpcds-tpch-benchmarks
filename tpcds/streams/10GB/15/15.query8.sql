-- start query 8 in stream 15 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '35991','95406','11390','19403','95818','23181',
                          '56423','92752','32626','17367','14223',
                          '65593','80064','95006','29603','96321',
                          '72386','95248','29932','70347','63860',
                          '94768','55975','39212','58797','87526',
                          '58305','14884','42559','15599','77311',
                          '35665','28091','80584','61703','55569',
                          '23778','57298','77834','29943','93519',
                          '66007','17913','77734','89813','74692',
                          '35057','45111','99695','12486','79866',
                          '37067','12327','47731','99793','69837',
                          '89884','51912','50112','37674','76111',
                          '71253','86575','71597','10029','92919',
                          '45076','35705','59275','37894','51160',
                          '21267','68767','34911','55512','21637',
                          '13166','86426','55702','12577','54019',
                          '62071','41088','59013','50352','35437',
                          '17343','82512','67316','58967','94633',
                          '33224','35174','89775','39260','71851',
                          '52840','95707','57658','98428','92160',
                          '98849','16838','84582','63874','26852',
                          '23287','96095','14411','58057','67133',
                          '96428','57888','56011','22494','64204',
                          '74351','87364','17416','70957','27975',
                          '42003','50303','26738','25627','54647',
                          '60057','87305','69750','59951','69359',
                          '23415','96822','91830','97357','12280',
                          '23078','58120','30712','54639','17558',
                          '52376','10862','48759','33078','29667',
                          '12567','23920','82117','23974','86723',
                          '85926','88114','17926','22488','11428',
                          '49812','43826','76397','51717','94759',
                          '63160','69926','32749','95422','74462',
                          '63976','72417','41562','23765','72504',
                          '36990','66498','52853','75885','52646',
                          '41231','73287','51534','26045','11321',
                          '93730','72227','20224','79749','85570',
                          '60450','67954','27768','15224','73090',
                          '21579','85664','21417','31304','59515',
                          '31463','88655','86548','33840','41924',
                          '83327','75179','64824','74471','52973',
                          '18326','72116','64787','23792','95436',
                          '51410','36525','29748','79928','91127',
                          '58517','24119','37296','39797','97395',
                          '88389','54063','73262','22017','69429',
                          '66807','48193','94305','21350','17909',
                          '82973','62153','39678','33245','77838',
                          '17569','10134','51177','44421','63788',
                          '54124','42400','68375','18105','32844',
                          '84119','32674','33684','17113','78055',
                          '63426','77702','60123','54759','44471',
                          '97518','37617','45782','69255','89627',
                          '17749','68179','67013','27514','30410',
                          '94401','32557','85119','41736','71674',
                          '44087','31965','80119','79150','56581',
                          '81862','96066','53907','91689','37440',
                          '15266','89353','53639','44086','99772',
                          '18000','65470','64691','90235','52513',
                          '74339','82875','98582','55521','49292',
                          '58076','97763','39413','48671','18447',
                          '71704','62569','53029','49628','54676',
                          '17877','45805','76505','98147','51657',
                          '63200','13209','66817','41044','65671',
                          '62031','98472','49538','53312','62839',
                          '48947','98695','85012','56848','30884',
                          '85438','93677','94334','47744','91608',
                          '61382','91807','95740','43425','93958',
                          '64722','22841','88767','95050','72804',
                          '79023','31830','41584','13205','21538',
                          '10179','23931','95942','33193','82687',
                          '45935','54864','79395','93792','91901',
                          '50483','18859','73224','61265','82185',
                          '62867','32790','96903','50116','72365',
                          '31114','94982','58232','79370','20376',
                          '52193','39290','79540','47577','14051',
                          '91957','52549','25032','13055','76837',
                          '92198','75594','25436','43011','35879',
                          '30013','44843','60011','47779','62384',
                          '12135','60765','93565','76273','17452',
                          '38927','88523','12427','55430')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

