-- start query 8 in stream 19 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '38531','89910','38176','27167','15436','15731',
                          '37137','24976','94708','53400','24498',
                          '20704','98108','59947','70273','72062',
                          '43408','67494','90717','28681','87717',
                          '30117','40402','88348','11702','13005',
                          '99008','42113','27836','54440','14537',
                          '20067','26754','23291','63526','88903',
                          '54032','10269','22047','97441','71110',
                          '44933','75385','32300','42882','11994',
                          '86019','32191','75901','86095','41103',
                          '89539','66237','12373','51516','45422',
                          '14511','38656','93390','61880','71517',
                          '10973','60492','78243','17140','72000',
                          '85680','51493','75688','66060','57714',
                          '88999','44137','41942','59999','39157',
                          '30154','36489','71058','71899','50902',
                          '80199','58117','41328','78414','44296',
                          '97340','19030','84695','65586','82845',
                          '30123','46869','76343','96809','34312',
                          '28953','75663','87316','41852','57131',
                          '71172','74742','72991','19228','99141',
                          '34934','84546','18566','35261','92076',
                          '63289','39323','91303','20566','63522',
                          '72472','34104','63443','80739','36903',
                          '11964','21265','84212','92226','14781',
                          '77356','17917','31574','43982','81818',
                          '60356','36193','26140','22130','66514',
                          '45060','59948','17181','26319','35569',
                          '71423','36565','16036','61377','77043',
                          '56507','66120','20530','23306','94364',
                          '54670','75360','18915','59693','83240',
                          '33852','45805','14118','61376','99185',
                          '55167','39934','87611','35693','39923',
                          '70255','30387','80356','88104','67435',
                          '54985','83069','80283','92629','48160',
                          '90154','89657','92624','86909','98845',
                          '70320','13191','19957','99313','36908',
                          '73127','77708','15164','32263','40891',
                          '97190','99847','82981','81154','81866',
                          '98471','84171','58091','57005','36500',
                          '85402','70232','69828','52188','39932',
                          '44077','86976','57775','95965','35522',
                          '61433','60157','41303','34439','39924',
                          '37868','80804','70019','32784','41827',
                          '76961','39792','75404','72506','38745',
                          '64563','75079','19115','93724','96107',
                          '68671','36365','24267','38831','78750',
                          '31374','55786','20267','98734','72709',
                          '81773','51543','53900','52437','18789',
                          '20086','81548','95941','91163','26619',
                          '96671','68778','44184','46128','37413',
                          '65618','51159','57617','34492','80711',
                          '77769','38501','65917','27843','44966',
                          '86625','87836','59931','66468','91619',
                          '51904','48558','15915','35854','12100',
                          '57409','71546','11349','29517','31570',
                          '20868','29555','63757','73828','33109',
                          '45340','27752','73352','91572','16754',
                          '13063','46901','33756','82205','21345',
                          '41877','95768','95629','55169','43703',
                          '45477','33720','38020','31785','46179',
                          '67765','74108','67804','45049','97512',
                          '40128','92021','61345','52432','72788',
                          '27374','31993','48227','60297','50007',
                          '51786','29477','52679','65212','99172',
                          '57224','92252','89887','92595','32700',
                          '90193','86988','54961','31719','81881',
                          '47404','58617','16104','16545','90501',
                          '98335','83358','29038','33283','15907',
                          '62124','16170','52155','46838','60503',
                          '48460','95990','39981','77395','52456',
                          '21641','99470','11247','89114','26040',
                          '18330','32445','82951','75848','64119',
                          '92727','16969','79393','30491','96162',
                          '20655','79316','12771','93172','67265',
                          '57937','55273','76474','16610','38874',
                          '76219','27922','24008','28826','45095',
                          '96097','83012','41938','22869','26230',
                          '25758','30922','86108','81188','26432',
                          '19930','50606','81679','28478')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

