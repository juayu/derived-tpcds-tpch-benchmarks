-- start query 8 in stream 18 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '23001','13146','56961','65261','52211','23646',
                          '29548','75457','39757','54201','83780',
                          '27972','88625','51708','22548','84136',
                          '44389','94105','50077','73946','13638',
                          '19030','63371','51400','78822','28944',
                          '49744','39393','16728','70310','92169',
                          '40070','42578','11561','80073','32178',
                          '40288','88684','23401','90391','50092',
                          '43018','74954','72583','12705','21548',
                          '30987','10260','46954','99544','20803',
                          '50606','72903','40450','50714','12377',
                          '98910','66008','73246','45368','90923',
                          '48101','54660','96499','71940','78196',
                          '86216','36847','85216','58611','69809',
                          '20603','69400','68723','73317','47371',
                          '88962','70429','11216','45607','77364',
                          '44177','20731','76531','86508','61113',
                          '58625','31775','51525','67456','43308',
                          '65938','46350','67783','57062','98990',
                          '54277','17890','66273','43567','57075',
                          '35258','74871','51755','19726','89555',
                          '77894','56131','69287','57201','77065',
                          '49457','58039','28976','66437','14533',
                          '71412','90651','89173','74922','46390',
                          '87753','85940','35399','30000','74072',
                          '28090','25939','74109','79598','77482',
                          '89476','60720','92466','54929','65752',
                          '18931','99952','56057','13015','53817',
                          '90286','71000','77573','24382','16093',
                          '80863','78264','24399','45702','40352',
                          '97712','52890','62673','33586','20640',
                          '28470','43516','79916','43564','69602',
                          '74212','42449','77362','81824','63864',
                          '25780','56537','40306','40669','23539',
                          '52782','31612','22965','35006','53302',
                          '62264','47831','58416','35695','33528',
                          '99283','24373','33300','23965','48665',
                          '77346','92532','79442','52549','93812',
                          '51719','80021','58839','77243','73618',
                          '80895','98060','40764','17358','78278',
                          '68045','68389','77555','47356','23540',
                          '93322','96358','83574','49239','58192',
                          '78906','19467','97203','24267','47579',
                          '58425','23662','79836','37143','39606',
                          '81109','72014','24463','16502','27798',
                          '99057','62805','59260','40676','51646',
                          '66844','70918','54195','17271','70833',
                          '36799','48906','92924','66623','31072',
                          '23332','27118','32442','12985','98667',
                          '97210','69428','20677','81430','86363',
                          '36087','97511','70562','27010','33994',
                          '93960','40329','34586','29647','27279',
                          '79923','67873','86710','70492','94404',
                          '40468','81803','42432','66612','42213',
                          '71853','12875','14008','42752','27990',
                          '83670','12440','41488','46028','49481',
                          '84181','69481','23400','20190','46336',
                          '86617','60663','45420','60830','13949',
                          '61570','28345','51183','81191','66834',
                          '74191','88112','71082','12340','40448',
                          '14012','69422','52742','65031','37438',
                          '59430','23284','64698','79861','48765',
                          '32499','44477','16636','15707','63212',
                          '78308','63897','46235','42307','25481',
                          '72017','58171','84203','68426','76933',
                          '57855','88098','19396','59247','91257',
                          '16963','22886','12198','74098','62841',
                          '99500','36809','51167','52706','99144',
                          '59152','19815','12242','23306','32549',
                          '31152','56572','89325','67759','16065',
                          '69244','21855','25632','21987','63086',
                          '88340','57621','45677','91129','59255',
                          '18321','10400','77546','62849','28709',
                          '81402','10880','85918','15544','89499',
                          '29603','57444','93072','15985','67156',
                          '40256','90494','97890','16359','96803',
                          '23930','90028','71597','43281','57920',
                          '34545','24084','34458','79161','76176',
                          '32203','82098','12597','95018','36708',
                          '17719','59121','18689','39818')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

