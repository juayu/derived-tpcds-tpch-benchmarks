-- start query 8 in stream 5 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '69115','65074','26523','69228','39672','18101',
                          '45882','88947','41690','36783','74651',
                          '88021','57130','95781','93431','16787',
                          '90926','21045','84504','98548','18881',
                          '70016','47475','56160','72148','47684',
                          '13288','10990','31656','68075','59518',
                          '14236','98122','60684','49929','99359',
                          '33822','87636','11811','44213','68531',
                          '40522','72178','87183','68467','62663',
                          '19576','45000','55311','14565','81192',
                          '64246','35943','29832','41083','11330',
                          '80021','78756','98553','58064','33900',
                          '12701','40768','79360','59364','92730',
                          '77034','53312','24655','72634','63710',
                          '74629','18086','59591','70064','57990',
                          '26880','10758','14750','74488','38959',
                          '81628','58055','62143','62406','10953',
                          '35621','63939','24566','92743','22304',
                          '24168','24630','12736','59801','23732',
                          '74980','95775','34174','20017','33782',
                          '43956','10884','64553','15453','34795',
                          '59674','29428','40802','49230','68356',
                          '61432','99802','10011','76840','77784',
                          '78438','89075','25562','98289','45097',
                          '98181','68952','29935','49598','38151',
                          '10018','69000','20948','90108','74611',
                          '85565','13672','18805','11752','16998',
                          '83371','40543','50159','28863','85281',
                          '49015','94174','99936','74045','90844',
                          '11487','53426','30517','52181','24986',
                          '16676','20993','96984','67302','87301',
                          '28491','11525','67421','77362','19017',
                          '91897','12279','61735','86770','15302',
                          '33461','32593','52635','28761','59078',
                          '53145','70789','31594','67842','46001',
                          '25904','29736','22496','94257','29434',
                          '12861','45036','31669','59278','79624',
                          '16482','43561','81349','62162','67338',
                          '32633','65050','80873','49362','75823',
                          '49145','96339','56625','22973','13010',
                          '75181','54104','61887','94368','44346',
                          '82989','48505','41152','80031','57177',
                          '50740','46880','63912','29382','64268',
                          '75005','62139','74494','26013','67736',
                          '57957','75714','67520','67136','54790',
                          '58105','38947','79118','91788','71388',
                          '47823','71033','24271','78971','59206',
                          '49436','34156','11845','97261','40319',
                          '90214','46561','84342','66145','12687',
                          '82082','94649','91049','22853','94264',
                          '18169','41794','11597','26630','52774',
                          '97169','25504','18190','98260','86863',
                          '22967','58641','64131','42145','27451',
                          '50525','93503','95966','81403','39281',
                          '37236','48990','41886','39965','73108',
                          '30964','39046','64505','25987','45091',
                          '77998','61663','85916','80840','27197',
                          '58362','95428','89257','16363','42702',
                          '47498','63723','19515','58222','29410',
                          '72426','96116','95810','89505','28586',
                          '33935','35688','26336','68867','80162',
                          '95095','40494','36986','21178','34085',
                          '31001','25541','90433','80945','99091',
                          '13731','39166','95834','88543','72662',
                          '69888','96404','58465','71258','86594',
                          '21240','91608','27813','76795','45235',
                          '86088','85789','74452','89290','77315',
                          '21992','78531','15391','47078','82195',
                          '53220','32355','16458','28830','50960',
                          '39921','12723','67377','56733','83936',
                          '65707','52740','18847','17696','85278',
                          '93045','52245','88789','37251','90130',
                          '39458','65140','18907','30936','13603',
                          '50348','47263','13232','53709','42478',
                          '93829','55068','56041','44768','11516',
                          '95306','53863','24504','77959','99005',
                          '73717','85144','13891','64848','90436',
                          '79998','27145','29751','95681','92932',
                          '35744','57125','78552','10791','53746',
                          '35051','24784','59129','27117')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

