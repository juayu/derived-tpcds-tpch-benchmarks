-- start query 8 in stream 11 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '32094','64687','16083','34868','45230','59172',
                          '66964','75278','17125','26837','30159',
                          '16171','75981','85483','93498','55416',
                          '91509','17159','59716','30113','61547',
                          '27706','39271','36346','68570','55745',
                          '25818','84876','89120','54218','89811',
                          '84507','98943','93675','93062','47761',
                          '25653','23170','16061','45910','69655',
                          '76366','95694','41211','77659','16374',
                          '10817','91688','60548','86918','67141',
                          '45640','69005','25093','73661','85635',
                          '19718','90051','23837','90810','73062',
                          '44815','77421','28045','36177','36146',
                          '81684','70929','46628','88252','79659',
                          '75783','81258','56949','86758','57683',
                          '63407','37138','96149','62850','24741',
                          '44559','61880','95935','49813','69891',
                          '39447','50448','37620','44821','89232',
                          '43999','64452','74037','92384','33486',
                          '55651','81116','52888','31857','58864',
                          '38788','99562','31176','19284','45990',
                          '36738','32773','22773','47787','19813',
                          '31937','97777','92232','96967','30852',
                          '10064','58668','10073','16477','73784',
                          '84585','77071','16480','54265','84105',
                          '25074','66369','51390','45560','49285',
                          '54545','97632','93770','95096','39345',
                          '50621','69060','22307','95153','14017',
                          '77726','28365','41898','39961','92514',
                          '81023','53882','40389','76990','48767',
                          '46060','21390','35849','66476','31534',
                          '83909','16265','52386','90458','45195',
                          '23565','16740','82336','28656','17182',
                          '59551','35892','89930','74348','43720',
                          '33601','26667','40883','47294','69217',
                          '97453','59171','94591','70579','38473',
                          '88620','36696','36919','67519','36568',
                          '74363','78417','28105','33697','76448',
                          '29630','61018','93272','42885','10029',
                          '27411','72775','72008','30332','86115',
                          '59938','60901','46790','53403','33672',
                          '45072','88898','11478','57634','24787',
                          '27603','64921','63454','81631','90007',
                          '13782','33896','43140','99021','43880',
                          '55576','17208','20462','84697','69363',
                          '13109','88749','25765','40191','34436',
                          '10605','22515','72320','26155','23053',
                          '46883','28509','46439','38307','28134',
                          '99306','12265','28458','13871','87677',
                          '20813','44216','75918','67295','75255',
                          '20777','84181','24110','23348','61667',
                          '23754','32388','36907','24100','77401',
                          '74653','37856','96512','52051','10428',
                          '51339','84370','22992','12978','87194',
                          '25077','18166','30928','46227','60538',
                          '69233','43678','14468','52990','88595',
                          '35778','42530','14316','27390','22071',
                          '73968','94386','11159','83366','16433',
                          '19082','49424','33667','95307','34875',
                          '22643','93883','54533','42875','67516',
                          '95557','72988','73735','91914','96732',
                          '65977','15542','18366','87580','14376',
                          '70927','93004','46507','16454','85403',
                          '43932','81246','60082','51067','15232',
                          '92659','95869','72037','76247','91736',
                          '35757','73318','50597','46721','69887',
                          '88288','45747','35711','55625','12724',
                          '45413','24573','68032','11141','17563',
                          '33715','39543','87118','17742','89958',
                          '69592','20232','35336','69197','81752',
                          '53802','71259','20551','40606','57010',
                          '85966','71687','52470','68675','39485',
                          '92075','49277','65387','82301','96883',
                          '70282','63283','73079','37417','63935',
                          '37934','93551','43618','31421','29142',
                          '27878','79529','43651','19598','96033',
                          '51666','96818','59264','32549','36911',
                          '83787','52325','99936','51290','34266',
                          '89112','46316','24729','68924','58868',
                          '26021','80620','14080','21337')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

