-- start query 8 in stream 7 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '57864','64259','33323','88044','24258','77466',
                          '83534','41744','73059','81504','54420',
                          '52668','31666','27577','80192','37796',
                          '33740','21219','45361','75900','83974',
                          '35439','43145','35301','55827','28411',
                          '85578','77520','65537','52672','53646',
                          '19366','26782','53366','87388','83007',
                          '55586','50038','79611','85079','27764',
                          '90187','69479','94879','99060','62790',
                          '47513','23795','13691','41444','77785',
                          '58994','49674','79137','52821','19437',
                          '85280','69767','53996','96044','29366',
                          '18181','82733','75613','40663','25002',
                          '22752','10145','87135','76934','39218',
                          '79970','79967','21139','94926','12903',
                          '83071','50951','68263','59086','75070',
                          '79183','58071','73337','62893','83625',
                          '32581','67117','18790','19222','52986',
                          '93992','94590','31669','15234','41877',
                          '98461','44761','25963','43045','39894',
                          '54018','37618','29469','60880','35371',
                          '93533','94434','83793','83402','13347',
                          '10221','29458','53236','89941','98841',
                          '97078','78604','83221','24673','47925',
                          '74785','54962','67044','23058','55308',
                          '99134','31973','81930','38886','85732',
                          '81113','55942','85124','29818','67510',
                          '13346','28485','94196','36100','96709',
                          '33682','80391','98261','68746','21615',
                          '60013','73820','22317','78852','56609',
                          '73295','29705','45868','39725','44827',
                          '71209','65839','81696','43404','29774',
                          '53141','18245','25512','40107','53735',
                          '49266','85799','86139','40402','83641',
                          '16711','40254','77288','91341','83746',
                          '77247','52146','98209','11363','64123',
                          '16720','49340','78830','77285','50624',
                          '73121','75109','28367','74389','54915',
                          '76900','52891','29079','98952','57704',
                          '22822','53113','23818','88126','76105',
                          '63986','54399','54916','46225','51028',
                          '39193','32791','10630','50502','83578',
                          '14112','29215','20682','64922','48624',
                          '30282','34136','15779','18882','38894',
                          '21066','13085','32748','83967','39391',
                          '74075','23414','68218','85346','27000',
                          '79765','49783','45658','33677','13627',
                          '58576','12453','87052','63171','29657',
                          '78006','33959','39626','67491','90111',
                          '31388','62519','75389','65514','37807',
                          '55509','87222','39143','27212','54378',
                          '78903','36647','54944','37628','67674',
                          '14070','84286','47518','57535','10339',
                          '69625','46600','81955','42349','40556',
                          '96830','82397','68626','63197','77267',
                          '45833','57153','67532','78127','11019',
                          '10122','82217','22678','79761','53754',
                          '68381','44935','62141','81838','44360',
                          '31626','25363','26041','79587','93773',
                          '92844','47007','36126','76078','86976',
                          '16848','32306','43902','84599','60388',
                          '33652','15565','20303','39429','55660',
                          '84857','50304','77038','91338','91536',
                          '49533','84062','11548','79802','26573',
                          '69489','80554','88849','42100','60167',
                          '54069','28638','61039','88281','97690',
                          '86600','86262','34187','70268','55374',
                          '66275','60309','24813','40826','34804',
                          '88241','95268','51884','72626','85272',
                          '82268','62184','35683','81362','75095',
                          '95709','56440','29938','23378','76611',
                          '29038','66630','94008','50085','47782',
                          '32038','23822','14203','88502','42315',
                          '45952','29949','86100','51719','18588',
                          '83112','41979','53483','48769','93043',
                          '16870','17929','23668','49889','20296',
                          '91134','20126','64344','21843','98651',
                          '34438','97670','42380','65866','52027',
                          '64772','17018','20729','24469','43786',
                          '99617','43367','17653','11541')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

